<?php
/* 
	Meruert CMS
	Founded: 2011, Nov 03
	Primarily released: 2011, Dec 18
	Version: 8 (code name "Iruma") - TO CHANGE
	Released: 0000000000000 - TO CHANGE
	Updated: 22.02.2019 14:10
	Build: 8.000-pre
    Version history: 
        18.12.2011 (v1, "Lulu"), 28.12.2011 (v2, multi-language), 15.01.2012 (v3, flexible), 12.02.2012 (v4, improvements), 02.08.2012 (v5, "Julia"), 03.07.2013 (v6, "Gauhar"), 12.02.2016 (v7, "Arabella"), ??? (v8).
	Website: http://meruert.com/
	Idea, development, design, templates, languages, official website, support:
		© Kirill "Erlang" Panfilov (http://kirillpanfilov.com/)
	Participation:
		© Murilo Ricci (http://murilo.lingvoblog.com/) — Portuguese translation corrections, bug reports
		© Rosana Poroshchuk (http://ro.meruert.com/) — Ukrainian translation, tests
		© Iren (http://iren.berite.info/) — basic Spanish translation
		© Mustaine — Chinese (traditional) translation
		© Hans Christian Hansen (hanschristian.hansen@hotmail.com) — Danish translation
		© Ekaterina Stepantsova — Italian translation
		© Serge Patsaluyonak (serghelm1011@googlemail.com) — Belarussian translation
		© Pavel Honig (http://honigp.info/) — Czech translation
		© Anastasia Morugova (http://anastasiamorugova.com/) — bug reports, tests, design themes, inspiration
		© Yulia Aranovich (http://juliacesar.com/), Ruslan Ivanov (http://siriusianin.ru/), Vasiliy Versus (http://dcversus.ru/) — tests, ideas and bug reports
		© Vladimir (http://silvertransfer.ee/ transport company) — Estonian translation
		© Xusanbek Xakimov — Uzbek translation
	Used technologies: 
		— Uppod (http://uppod.ru/)
		— Ya.share (http://share.yandex.ru/) - TO CHANGE
	System requirements: Apache / lighttpd / nginx, PHP 4.3+ (5 or 7 better), GD2, mod_rewrite (optional)
	Code obfuscated with http://wb0.ru/phpobf.php
*/

if(file_exists('conf.php'))include 'conf.php';define('Engine','Meruert');define('EngineVersion','8 alpha');define('EngineBuild','8.000-pre');define('EngineCodename','Iruma');define('EngineWebsite','http://meruert.com/');define('Ext','/');if(!defined('Fxt'))define('Fxt','.php');if(!defined('System'))define('System','Meruert/');if(!defined('Db'))define('Db','data' .Fxt);if(!defined('DbReserve'))define('DbReserve','data-reserve/data_{ID}' .Fxt);if(!defined('DbTexts'))define('DbTexts','data-store/');if(!defined('DbRecords'))define('DbRecords','data-records/');if(!defined('Themes'))define('Themes','themes/');if(!defined('MainTheme'))define('MainTheme','orinoco');if(!defined('Template'))define('Template','template' .Fxt);if(!defined('Style'))define('Style','style.css');if(!defined('JsFolder'))define('JsFolder','js/');if(!defined('Js'))define('Js',JsFolder .'meruert.js');if(!defined('MyJs'))define('MyJs',JsFolder .'js.js');if(!defined('Langs'))define('Langs','langs/');if(!defined('Langs2'))define('Langs2','langs-custom/');if(!defined('Flags'))define('Flags','flags/');if(!defined('Storage'))define('Storage','files/');if(!defined('Media'))define('Media','media/');if(!defined('Special'))define('Special','special/');if(!defined('Tiles'))define('Tiles','tiles/');if(!defined('Autoload'))define('Autoload','autoload/');if(!defined('Preprocessor'))define('Preprocessor','preprocessor/');if(!defined('Comments'))define('Comments','comments/');if(!defined('Ratings'))define('Ratings',System .'ratings' .Fxt);if(!defined('Framework'))define('Framework','framework/');if(!defined('Functional'))define('Functional',System .Special .'functions' .Fxt);if(!defined('Management'))define('Management','management');if(!defined('Pagenotfound'))define('Pagenotfound','404');define('Main',MainTheme .'/');define('Protector','.htaccess');define('Robots','robots.txt');define('Sitemap','sitemap.xml');define('Logger',System .'log' .Fxt);define('MagicAutoSaver',System .'tmp' .Fxt);define("securCode","<" ."?php die(); ?" .">");if(!defined('LargeDb'))define("LargeDb",333);if(!defined('imgMaxW'))define('imgMaxW',1200);if(!defined('imgMaxH'))define('imgMaxH',800);if(!defined('avMaxW'))define('avMaxW',200);if(!defined('avMaxH'))define('avMaxH',200);if(!defined('maxPicsAmount'))define('maxPicsAmount',5);if(!defined('maxMediaAmount'))define('maxMediaAmount',1);if(!defined('enterURL'))define('enterURL','enter');if(!defined('randomURL'))define('randomURL','random');if(!defined('uploadRef'))define('uploadRef','file-uploader');if(!defined('socialNetworks'))define('socialNetworks','vkontakte,facebook,odnoklassniki,moimir,lj,yaru,moikrug,liveinternet,blogger,evernote,twitter');error_reporting(0);ini_set("register_globals",0);ini_set("default_charset",'UTF-8');if(function_exists('mb_internal_encoding')){mb_internal_encoding('UTF-8');}define('ThisServer',@$_SERVER['HTTP_HOST']);define('ThisReferer',@$_SERVER['HTTP_REFERER']);$m='';$db='';$single=0;$managementMenuU=array();$managementMenuA=array();$service_pages=array('drafts','preferences','secret','upside-down','editsource','files','comments','new','edit','copy-page','edit-comments','edit-sidebar','edit-supermenu','edit-topmenu','edit-footer','edit-template','stats-code','edit-part','edit-phpcode','edit-menu','edit-meta','list-pages','list-posts','post-ratings','logger');if(ThisReferer!=''&& strpos(ThisReferer,ThisServer)===false){foreach($_POST as $k=>$v){unset(${$k});unset($_POST[$k]);}}function protectDangerTexts($s,$noStrip="<b><i><u><a><img>"){$s=strip_tags($s,$noStrip);$onevent=array('on','On','ON','oN');foreach($onevent as $oneventOne){$s=str_replace(' ' .$oneventOne,' &#111;&#110;',$s);}$javascr=array('ja','Ja','JA','jA');foreach($javascr as $javascrOne){$s=str_replace($javascrOne,'&#106;&#97;',$s);}$s=str_replace('<a ','<!--noindex--><a rel="nofollow" ',$s);$s=str_replace('<A ','<!--noindex--><a rel="nofollow" ',$s);$s=str_replace('</a>','</a><!--/noindex-->',$s);$s=str_replace('</A>','</a><!--/noindex-->',$s);return $s;}function strip_quotes($s){$s=str_replace("'","&#39;",$s);$s=str_replace('"','&quot;',$s);return $s;}function trimslasher($s){return str_replace(' ','/',trim(str_replace('/',' ',$s)));}function xmler($str,$tag,$ifEmpty=''){$tags=explode('/',$tag);foreach($tags as $tag){$found=0;if(strpos($str,'<' .$tag .' ')>-1){$str=substr($str,strpos($str,'<' .$tag .' '));$found=1;}else if(strpos($str,'<' .$tag .'>')>-1){$str=substr($str,strpos($str,'<' .$tag .'>'));$found=1;}if($found>0){$str=substr($str,strpos($str,'>')+1);$str_pos=strpos($str,'</' .$tag .'>');$str=substr($str,0,$str_pos);}else{$str='';}}return($str=='')?$ifEmpty:$str;}function walkxml($s,$tag='item',$find=''){$a=array();while(strpos($s,'</' .$tag .'>')>-1){$item=xmler($s,$tag);if($find == ''|| count($find)<1){$a[]=$item;}else{$set=array();foreach($find as $elem){$set[$elem]=xmler($item,$elem);}$a[]=$set;}$tag_start=strpos($s,'<' .$tag);$tag_end=(strpos($s,'</' .$tag .'>')+strlen($tag)+3);$s1=substr($s,0,$tag_start);$s2=substr($s,$tag_end);$s=$s1 .$s2;}return $a;}function upXMLer($s,$set,$val=''){if(!is_array($set))$set=array($set=>$val);foreach($set as $k=>$v){$path=explode('/',$k);if(strpos($s,'</' .$path[0] .'>')===false)$s .= '<' .$path[0] .'></' .$path[0] .'>';$fragments=array();$s2=$s;foreach($path as $tag){$fragments[$tag]='<' .$tag .'>' .xmler($s2,$tag) .'</' .$tag .'>';if(!isset($all))$all=$fragments[$tag];$s2=$fragments[$tag];$getTag=$tag;}$fragments=array_reverse($fragments);$state=$fragments[$getTag];$up='<' .$getTag .'>' .$v .'</' .$getTag .'>';foreach($fragments as $fk=>$fv){$up=(strpos($fragments[$fk],$state)>-1)?str_replace($state,$up,$fragments[$fk]):str_replace('</' .$fk .'>','',$fragments[$fk]) .$up .'</' .$fk .'>';$state=$fragments[$fk];}$s=str_replace($all,$up,$s);unset($all);}return $s;}function paragrafize($s){$s=str_replace('&quot;','"',$s);if(strpos($s,'<p')===false && strpos($s,'<P')===false){$reserve_codes=array();$ri=0;$tags=array('code','h1','h2','h3','h4','h5','h6','blockquote','table','script','style');foreach($tags as $tag){while(strpos($s,'</' .$tag .'>')!=false){$getSubstr=substr($s,strpos($s,'<' .$tag));$getSubstr=substr($getSubstr,0,strpos($getSubstr,'</' .$tag .'>'));$getSubstr .= '</' .$tag .'>';$reserve_codes[$ri]=$getSubstr;$s=str_replace($getSubstr,'<special:reserve:' .$ri .'>' .$tag .'</special:reserve:' .$ri .'>',$s);$ri++;}}$split=explode("\n",$s);$text=array();foreach($split as $p){$text[]=(trim($p)=='')?'&nbsp;':trim($p);}$s='<p>' .join("</p>\n<p>",$text) .'</p>';for($rj=0;$rj<count($reserve_codes);$rj++){$getTag=xmler($s,'special:reserve:' .$rj);if(strpos($reserve_codes[$rj],"\n")>0 && $getTag == 'code'){$code_replacer='<pre><code>' .htmlspecialchars($reserve_codes[$rj]) .'</code></pre>';}else{$code_replacer=$reserve_codes[$rj];}$s=str_replace('<special:reserve:' .$rj .'>' .$getTag .'</special:reserve:' .$rj .'>',$code_replacer,$s);if($getTag!='code')$s=str_replace(array('<p><' .$getTag,'</' .$getTag .'></p>'),array('<' .$getTag,'</' .$getTag .'>'),$s);}return str_replace(array('<p><pre>','</pre></p>'),array('<pre>','</pre>'),$s);}return $s;}function recognizeLinks($s){$s=str_replace('&quot;','"',$s);$s_expl=explode("\n",$s);for($i=0;$i<count($s_expl);$i++){$s_expl[$i]=preg_replace('/([\b]+|[^"\/]+|^)(https?:\/\/|www.)(\w*)([\.\w]*\/?)([a-zA-Z0-9_\/\?\-\.\!\+\[\]\(\)#,%;:~=&]+)/i',"$1<a href=\"http://$2$3$4$5\" target=\"_blank\">$2$3$4$5</a>",$s_expl[$i]);$s_expl[$i]=preg_replace("/(https?:\/\/)(https?:?\/\/)/i","$2",$s_expl[$i]);$s_expl[$i]=preg_replace("/href=\"([^\"]*)((\.|,|\?|\!|:|;)\")/i","href=\"$1\"",$s_expl[$i]);$s_expl[$i]=preg_replace("/(\.|,|\?|\!|:|;)<\/a>/i","</a>$1",$s_expl[$i]);}return join("\n",$s_expl);}function setURL($s,$get='',$anchor=''){$a=$anchor==''?'':'#' .$anchor;$s=str_replace(array('%2F','%3A','%3B','%7E','%5E','%5B','%5D'),array('/',':',';','~','^','[',']'),urlencode($s));return(isset($_GET['q']))?Siteroot .$s .(defined('Mxt')?Mxt:Ext) .(($get!='')?'?' .$get:'') .$a:Siteroot .'?' .$s .(($get!='')?'&' .$get:'') .$a;}$rq=(isset($_GET['q']))?$_GET['q']:$_SERVER['QUERY_STRING'];$rq=trimslasher(str_replace('{{PLUS}}','+',urldecode(str_replace('+','{{PLUS}}',urlencode($rq)))));if(strpos($rq,'&'))$rq=substr($rq,0,strpos($rq,'&'));function setRedirect($url='/',$get='',$anchor=''){if($url!=Siteroot)$url=setURL(trimslasher($url));if($get!='')$url .= '?' .$get;if($anchor!='')$anchor='#' .$anchor;header('Location:' .$url .$anchor);exit;}function setRedirectRef($anchor=''){if($anchor!='')$anchor='#' .$anchor;header('Location:' .ThisReferer .$anchor);exit;}function createMenu($equal,$selected='',$splitter='',$envelope='',$pref='',$path='',$keepLink=0,$filter=''){$filters=explode(' ',$filter);$menu=array();global $rq,$aliasedURLs,$aliasURLs;$i=0;$stripeClass='menu-stripe-1';foreach($equal as $k=>$v){if(strpos($k,'!')===0 && defined('manage')){$k=trim(substr($k,1));}else if(strpos($k,'!')===0 &&!defined('manage')){continue;}$k=str_replace('[lang]',specifyLang(),$k);$pathk=isset($aliasedURLs[$path .$k])?$aliasedURLs[$path .$k]:$path .$k;if($filters[0]!=''){if(in_array('filter:include-parent',$filters)){if($pathk != $filters[0]&& strpos($pathk,$filters[0] .'/')!==0)continue;}else{if(strpos($pathk,$filters[0] .'/')!==0)continue;}}$i++;$addClass=array();$addClass[]='item';if(strpos($rq,$path .$k)===0 && strlen($rq)>strlen($path .$k))$addClass[]='holder';if($i==1)$addClass[]='first';if($i==count($equal))$addClass[]='last';$addClass[]=$stripeClass;$stripeClass=($stripeClass == 'menu-stripe-1')?'menu-stripe-2':'menu-stripe-1';$addClasses=' class="' .join(' ',$addClass) .'"';$create_id=strtr($k,'#:./','----');if($create_id=='')$create_id='main';$env_start=(trim($envelope)=='')?'':'<' .$envelope .' id="' .$pref .$create_id .'">';$insertId=($env_start=='')?' id="' .$pref .$create_id .'"':'';$env_end=(trim($envelope)=='')?'':'</' .$envelope .'>';$sel_start=(trim($selected)=='')?'':'<' .$selected .$insertId .$addClasses .'>';$sel_end=(trim($selected)=='')?'':'</' .$selected .'>';$setUrlOrNot=($k==''&& $path=='')?Siteroot:setURL($pathk);if(strpos($k,'www.')===0)$k='http://' .$k;$serv1=str_replace('www.','',strtolower(ThisServer));$serv2=$k;if(strpos($serv2,'http')===0){$serv2=str_replace('www.','',strtolower($serv2));$serv2=substr($serv2,strpos($serv2,'//')+2);if(strpos($serv2,'/')>0)$serv2=substr($serv2,0,strpos($serv2,'/'));}$processURL=(strpos($k,'http')===0)?$k .'" target="_blank':$setUrlOrNot;if(strpos($k,'http')===0 && $serv1==$serv2)$processURL=$k;$setId='id="lnk-' .(($pref=='')?'':$pref) .(($k=='')?'blog':$create_id) .'"';if(strpos($k,' ')>-1 || strpos($k,'$')>-1){$menu[]=$v;}else{$v=(strpos($v,'[[')>-1 && strpos($v,']]')>0)?$v:'[[' .$v .']]';if($keepLink>0){$addClassesSel=str_replace(' class="',' class="selected active ',$addClasses);$menu[]=($pathk==$rq ||(isset($aliasURLs[$pathk])&& $aliasURLs[$pathk]==$rq))?$env_start .'<a ' .$setId .' href="' .$processURL .'"' .$addClassesSel .'>' .$sel_start .$v .$sel_end .'</a>' .$env_end:$env_start .'<a ' .$setId .' href="' .$processURL .'"' .$addClasses .'>' .$v .'</a>' .$env_end;}else{$menu[]=($pathk==$rq ||(isset($aliasURLs[$pathk])&& $aliasURLs[$pathk]==$rq))?$env_start .$sel_start .$v .$sel_end .$env_end:$env_start .'<a ' .$setId .' href="' .$processURL .'"' .$addClasses .'>' .$v .'</a>' .$env_end;}}}return join($splitter,$menu);}$rootdir=(strpos($_SERVER["SCRIPT_NAME"],'index.php')>-1)?dirname($_SERVER["SCRIPT_NAME"]):'/';$rootdir=str_replace('\\','/',$rootdir);if($rootdir!='/'&& $rootdir!=''){$rootdir=trimslasher($rootdir);define('Siteroot','/' .$rootdir .'/');}else{define('Siteroot','/');}function filereader($f,$mode=''){$f=trimslasher($f);if(file_exists($f)|| strpos($f,'http')>-1){$m=fopen($f,"r" .$mode);$fc=fread($m,filesize($f));fclose($m);return str_replace(securCode,'',$fc);}else{return '';}}function filewriter($f,$what='',$how='smile',$mode='',$noSecure=0){$f=trimslasher($f);if(!file_exists($f)){if(strpos($f,'/')!=false){$f_folder_all=substr($f,0,strrpos($f,'/'));$f_folder_paths=array();$f_folder_paths[]=$f_folder_all;$f_folder_short=$f_folder_all;while(strpos($f_folder_short,'/')!=false){$f_folder_short=substr($f_folder_short,0,strrpos($f_folder_short,'/'));$f_folder_paths[]=$f_folder_short;}$f_folder_paths=array_reverse($f_folder_paths);foreach($f_folder_paths as $f_folder){if(!file_exists($f_folder)){mkdir($f_folder,0755);chmod($f_folder,0755);}}}$fpr=@fopen($f,"w+");fclose($fpr);chmod($f,0777);}if($f==System .Db){$what=preg_replace('/<p:([^>]+)><\/p:([^>]+)>/i','',$what);$what=preg_replace('/<p:([^>]+)>0<\/p:([^>]+)>/i','',$what);$what=preg_replace('/<p:([^>]+)><br><\/p:([^>]+)>/i','',$what);}$before_content=($how=='before')?filereader($f):'';$after_content=($how=='after')?filereader($f):'';$whatx=$after_content .$what .$before_content;if($mode!='b')$whatx=stripslashes($whatx);$fp=fopen($f,"w" .$mode);flock($fp,LOCK_EX);$pref=(strpos($f,Fxt)>0 && $noSecure<1)?securCode:'';fwrite($fp,$pref .$whatx);flock($fp,LOCK_UN);fclose($fp);return filereader($f,$mode);}function createBackup($coerce=false){global $getElemNoBackups;return($coerce===true || $getElemNoBackups<1)?filewriter(System .str_replace('{ID}',@date('Y-m-d_H-i-s') .'_m' .rand(100000,999999),DbReserve),filereader(System .Db)):false;}function innerCallback(){if(function_exists('myCallback')){myCallback();}}function viewFolder($dirname,$fd='f',$sort='names'){if(!file_exists($dirname))return array();$allfiles=array();$alldirs=array();$dirname=trimslasher($dirname);$dir=opendir($dirname);while(($file=readdir($dir))!==false){if($file!="."&& $file!=".."){if(is_file($dirname ."/" .$file)){$allfiles[str_replace("./","",$dirname ."/" .$file)]=str_replace("./","",$dirname ."/" .$file);}if(is_dir($dirname ."/" .$file)){$alldirs[str_replace("./","",$dirname ."/" .$file)]=str_replace("./","",$dirname ."/" .$file);}}}closedir($dir);if($sort=='names'){natcasesort($allfiles);}else if($sort=='updated'){$tmp_array=array();foreach($allfiles as $k=>$v){$tmp_array[filemtime($k) .$k]=$v;}krsort($tmp_array);$allfiles=array();foreach($tmp_array as $k=>$v){$allfiles[$v]=$v;}unset($tmp_array);}natcasesort($alldirs);return($fd=='f')?$allfiles:$alldirs;}$translitters=array("	"=>"_"," "=>"_"," "=>"_","'"=>"_","\""=>"_","\\"=>"_",")"=>"_","("=>"_",","=>"_","—"=>"-","–"=>"-","–"=>"-","!"=>"-","?"=>"-",";"=>"-","…"=>"-","„"=>"-",":"=>"-","«"=>"-","»"=>"-","“"=>"-","”"=>"-","а"=>"a","б"=>"b","в"=>"v","г"=>"g","д"=>"d","е"=>"e","ё"=>"jo","ж"=>"zh","з"=>"z","и"=>"i","й"=>"j","к"=>"k","л"=>"l","м"=>"m","н"=>"n","о"=>"o","п"=>"p","р"=>"r","с"=>"s","т"=>"t","у"=>"u","ф"=>"f","х"=>"h","ц"=>"c","ч"=>"ch","ш"=>"sh","щ"=>"sch","ъ"=>"j","ы"=>"y","ь"=>"","э"=>"e","ю"=>"ju","я"=>"ja","А"=>"A","Б"=>"B","В"=>"V","Г"=>"G","Д"=>"D","Е"=>"E","Ё"=>"Jo","Ж"=>"Zh","З"=>"Z","И"=>"I","Й"=>"J","К"=>"K","Л"=>"L","М"=>"M","Н"=>"N","О"=>"O","П"=>"P","Р"=>"R","С"=>"S","Т"=>"T","У"=>"U","Ф"=>"F","Х"=>"H","Ц"=>"C","Ч"=>"Ch","Ш"=>"Sh","Щ"=>"Sch","Ъ"=>"J","Ы"=>"Y","Ь"=>"","Э"=>"E","Ю"=>"Ju","Я"=>"Ja","&#193;"=>"A","&#192;"=>"A","&#194;"=>"A","&#196;"=>"A","&#195;"=>"a","&#197;"=>"A","&#198;"=>"AE","&#199;"=>"C","&#208;"=>"D","&#201;"=>"E","&#200;"=>"E","&#202;"=>"E","&#203;"=>"E","&#205;"=>"I","&#204;"=>"I","&#206;"=>"I","&#207;"=>"I","&#209;"=>"N","&#211;"=>"O","&#210;"=>"O","&#212;"=>"O","&#214;"=>"O","&#213;"=>"O","&#216;"=>"O","&#222;"=>"T","&#218;"=>"U","&#217;"=>"U","&#219;"=>"U","&#220;"=>"U","&#221;"=>"Y","&#376;"=>"y","&#304;"=>"I","&#225;"=>"a","&#224;"=>"a","&#226;"=>"a","&#228;"=>"a","&#227;"=>"a","&#229;"=>"a","&#230;"=>"ae","&#231;"=>"c","&#240;"=>"d","&#233;"=>"e","&#232;"=>"e","&#234;"=>"e","&#235;"=>"e","&#237;"=>"i","&#236;"=>"i","&#238;"=>"i","&#239;"=>"i","&#241;"=>"n","&#243;"=>"o","&#242;"=>"o","&#244;"=>"o","&#246;"=>"o","&#245;"=>"o","&#248;"=>"o","&#254;"=>"t","&#250;"=>"u","&#249;"=>"u","&#251;"=>"u","&#252;"=>"u","&#253;"=>"y","&#255;"=>"y","&#305;"=>"i","&#223;"=>"ss","&#260;"=>"A","&#262;"=>"C","&#280;"=>"E","&#321;"=>"L","&#323;"=>"N","&#346;"=>"S","&#377;"=>"Z","&#379;"=>"Z","&#270;"=>"D","&#327;"=>"N","&#344;"=>"R","&#352;"=>"S","&#356;"=>"T","&#381;"=>"Z","&#256;"=>"A","&#274;"=>"E","&#286;"=>"G","&#298;"=>"I","&#310;"=>"K","&#315;"=>"L","&#325;"=>"N","&#362;"=>"U","&#278;"=>"E","&#302;"=>"I","&#370;"=>"U","&#336;"=>"O","&#368;"=>"U","&#258;"=>"A","&#350;"=>"S","&#354;"=>"T","&#272;"=>"D","&#416;"=>"O","&#431;"=>"U","&#313;"=>"I","&#317;"=>"L","&#340;"=>"R","&#264;"=>"C","&#284;"=>"G","&#292;"=>"H","&#308;"=>"J","&#348;"=>"S","&#467;"=>"U","&#332;"=>"O","&#261;"=>"a","&#263;"=>"c","&#281;"=>"e","&#322;"=>"l","&#324;"=>"n","&#347;"=>"s","&#378;"=>"z","&#380;"=>"z","&#271;"=>"d","&#328;"=>"n","&#345;"=>"r","&#353;"=>"s","&#357;"=>"t","&#382;"=>"z","&#257;"=>"a","&#275;"=>"e","&#287;"=>"g","&#299;"=>"i","&#311;"=>"k","&#316;"=>"l","&#326;"=>"n","&#363;"=>"u","&#279;"=>"e","&#303;"=>"i","&#371;"=>"u","&#337;"=>"o","&#369;"=>"u","&#259;"=>"a","&#351;"=>"s","&#355;"=>"t","&#273;"=>"d","&#417;"=>"o","&#432;"=>"u","&#314;"=>"i","&#318;"=>"l","&#341;"=>"r","&#265;"=>"c","&#285;"=>"g","&#293;"=>"h","&#309;"=>"j","&#349;"=>"s","&#468;"=>"u","&#333;"=>"o","&#1240;"=>"E","&#1170;"=>"G","Ґ"=>"G","Є"=>"E","Ї"=>"I","&#1178;"=>"K","&#1186;"=>"N","&#1256;"=>"O","&#1200;"=>"U","Ў"=>"U","&#1198;"=>"U","&#1210;"=>"H","Ђ"=>"Dj","Љ"=>"L","Њ"=>"N","Ћ"=>"Dj","Џ"=>"Dz","Ѓ"=>"G","Ќ"=>"K","І"=>"I","&#1216;"=>"","&#1241;"=>"e","&#1171;"=>"g","ґ"=>"g","є"=>"e","ї"=>"i","&#1179;"=>"k","&#1187;"=>"n","&#1257;"=>"o","&#1201;"=>"u","ў"=>"u","&#1199;"=>"u","&#1211;"=>"h","ђ"=>"dj","љ"=>"l","њ"=>"n","ћ"=>"dj","џ"=>"dz","ѓ"=>"g","ќ"=>"k","і"=>"i","&#1231;"=>"");function validname($filename){global $translitters;$filename=trim($filename);foreach($translitters as $k=>$v){$filename=str_replace($k,$v,$filename);}$filename=str_replace(array('-----','----','---','--'),'-',$filename);$allowed=array('.','0','1','2','3','4','5','6','7','8','9','X','x','Q','q','W','w');for($strl=0;$strl<strlen($filename);$strl++){if(!in_array($filename[$strl],$translitters)&&!in_array($filename[$strl],$allowed))$filename[$strl]='-';}return $filename;}function fileUpload($info,$where,$validate=1,$modify=0,$toAbcFolders=false){$names=is_array($info['name'])?$info['name']:array($info['name']);$ret=array();$i=0;$here=$where;foreach($names as $onename){if($onename!=false){$newname=basename($onename);$newname=str_replace(',','.',$newname);if($validate>0){$newname=validname($newname);}if($toAbcFolders==true){$here=$where .'/' .strtolower($newname[0]);}if(!file_exists($here)){$fnamae_folder_all=trimslasher($here);$fnamae_folder_paths=array();$fnamae_folder_paths[]=$fnamae_folder_all;$fnamae_folder_short=$fnamae_folder_all;while(strpos($fnamae_folder_short,'/')!=false){$fnamae_folder_short=substr($fnamae_folder_short,0,strrpos($fnamae_folder_short,'/'));$fnamae_folder_paths[]=$fnamae_folder_short;}$fnamae_folder_paths=array_reverse($fnamae_folder_paths);foreach($fnamae_folder_paths as $fnamae_folder){if(!file_exists($fnamae_folder)){mkdir($fnamae_folder,0755);chmod($fnamae_folder,0755);}}}$here=trimslasher($here) .'/';if(file_exists($here .$newname)){if($modify>0){$n=1;$newnamex=$newname;while(file_exists($here .$newnamex)){$newnamex=str_replace('.',$n .'.',$newname);$n++;}$newname=$newnamex;}else{unlink($here .$newname);}}if(!is_array($info['name'])){copy($info['tmp_name'],$here .$newname);return($toAbcFolders==true)?strtolower($newname[0]) .'/' .$newname:$newname;}else{copy($info['tmp_name'][$i],$here .$newname);$ret[]=($toAbcFolders==true)?strtolower($newname[0]) .'/' .$newname:$newname;$i++;}}}return $ret;}function convertImages($inFolder,$fromFile,$newName='',$makeWidth='150',$makeHeight='',$pref='',$quality='100'){$inFolder=trimslasher($inFolder) .'/';$newName=($newName!='')?$newName:$fromFile;$props=getimagesize($inFolder .$fromFile);if(strpos($props['mime'],'png')>0)$src=imagecreatefrompng($inFolder .$fromFile);else if(strpos($props['mime'],'gif')>0)$src=imagecreatefromgif($inFolder .$fromFile);else $src=imagecreatefromjpeg($inFolder .$fromFile);$propsw=$props[0];$propsh=$props[1];$propshnew=0;if($makeWidth!=''){$propswnew=($makeWidth<$propsw)?$makeWidth:$propsw;$propskoeff=$propsw/$propswnew;$propshnew=round($propsh/$propskoeff);}if(($makeHeight!=''&& $propshnew>$makeHeight)||($makeHeight!=''&& $makeWidth=='')){$propshnew=($makeHeight<$propsh)?$makeHeight:$propsh;$propskoeff=$propsh/$propshnew;$propswnew=round($propsw/$propskoeff);}$dst=imagecreatetruecolor($propswnew,$propshnew);imagecopyresampled($dst,$src,0,0,0,0,ImageSX($dst),ImageSY($dst),ImageSX($src),ImageSY($src));if(strpos(strtolower($newName),'.png')>0)imagepng($dst,$inFolder .$pref .$newName);else if(strpos(strtolower($newName),'.gif')>0)imagegif($dst,$inFolder .$pref .$newName);else imagejpeg($dst,$inFolder .$pref .$newName,$quality);}function equalizer($s){$s=(strpos($s,Fxt)>0 && file_exists($s))?filereader($s):$s;$equ_out=array();$take=explode("\n",$s);foreach($take as $taker){if(strpos(trim($taker),"==")>-1 || strpos(trim($taker),"=")>-1){$getDelim=(strpos(trim($taker),"==")>-1)?'==':'=';list($element1,$element2)=explode($getDelim,$taker,2);$element1=trim($element1);$element2=trim($element2);$equ_out[$element1]=$element2;}else continue;}return $equ_out;}function dateBasedCached($file){return $file .'?' .@date("YmdHis",filemtime($file));}function f_editorial($s){return str_replace(array('[parcelle:','[tile:','[func:','[edit:','[phpcode:','[menu:','[u:','[!parcelle:','[!tile:','[!func:','[!edit:','[!phpcode:','[!menu:','[!u:','[[',']]'),array('&#91;parcelle:','&#91;tile:','&#91;func:','&#91;edit:','&#91;phpcode:','&#91;menu:','&#91;u:','&#91;&excl;parcelle:','&#91;&excl;tile:','&#91;&excl;func:','&#91;&excl;edit:','&#91;&excl;phpcode:','&#91;&excl;menu:','&#91;&excl;u:','&#91;&#91;','&#93;&#93;'),$s);}function f_elem($s){return '<div class="form-elem">' .$s .'</div>';}function f_elem_set($s,$set){return '<div class="form-elem-set"><label class="for-elem-set">[[' .$s .']]</label>' .join("\n",$set) .'</div>';}function f_fieldset($legend='',$s,$id=''){return '<fieldset' .($id!=''?' id="' .$id .'"':'') .'><legend>' .$legend .'</legend>' .$s .'</fieldset>';}function f1($id='',$where='',$method='post',$target=''){global $rq;if(!isset($rq)|| $rq==''|| $rq=='/'){$where=Siteroot;}$id=($id=='')?'form_' .str_replace('/','-',$rq):$id;return '<form action="' .($where!=''?$where:setURL($rq)) .'" name="' .$id .'" id="' .$id .'" method="' .$method .'" enctype="multipart/form-data"' .($target!=''?' target="' .$target .'"':'') .'>';}function f_required($s){return str_replace(array('</label>','<input ','<textarea ','<select '),array('<span class="required">*</span></label>','<input required ','<textarea required ','<select required '),$s);}function f_getval($n,$s){return($s==''&& $_POST[$n]!=false && strpos($n,'cap1')!==0)?$_POST[$n]:$s;}function f_submit($word='Save'){$confirm=($word=='Remove'|| $word=='remove')?' onClick="if(confirm(\'[[Confirm removal]]\')) return true; else return false;"':'';return '<input type="submit" class="submit" value="[[' .$word .']]"' .$confirm .'>';}function f_end(){return '</form>';}function f2($word='Save'){return ' ' .f_submit($word) .'</form>';}function f_text($name,$label='',$string='',$disable=0){$string=f_getval($name,$string);$string=f_editorial($string);if(is_array($label)){$placeholder=$label[1];$label=$label[0];}$isPlaceholder=(isset($placeholder)&& $placeholder!='')?' placeholder="[[' .$placeholder .']]"':'';$disabled=($disable>0)?' disabled':'';$addDisabledValue=($disable>0)?'<input type="hidden" name="' .$name .'" value="' .strip_quotes($string) .'">':'';$lab=($label=='')?'':'<label id="' .$name .'lab" for="' .$name .'">[[' .$label .']]</label>';return $lab .' <input type="text" class="text" name="' .$name .'" id="' .$name .'" value="' .strip_quotes($string) .'"' .$disabled .$isPlaceholder .'>' .$addDisabledValue;}function f_email($name,$label='',$string='',$disable=0){return str_replace(' type="text"',' type="email"',f_text($name,$label,$string,$disable));}function f_search($name,$label='',$string='',$disable=0){return str_replace(' type="text"',' type="search"',f_text($name,$label,$string,$disable));}function f_date($name,$label='',$string='',$disable=0){return str_replace(' type="text"',' type="date"',f_text($name,$label,$string,$disable));}function f_time($name,$label='',$string='',$disable=0){return str_replace(' type="text"',' type="time"',f_text($name,$label,$string,$disable));}function f_number($name,$label='',$string='',$disable=0){return str_replace(' type="text"',' type="number"',f_text($name,$label,$string,$disable));}function f_password($name,$label='',$string=''){$string=f_getval($name,$string);if(is_array($label)){$placeholder=$label[1];$label=$label[0];}$isPlaceholder=(isset($placeholder)&& $placeholder!='')?' placeholder="[[' .$placeholder .']]"':'';$lab=($label=='')?'':'<label id="' .$name .'lab" for="' .$name .'">[[' .$label .']]</label>';return $lab .' <input type="password" class="password" name="' .$name .'" id="' .$name .'" value="' .strip_quotes($string) .'"' .$isPlaceholder .'>';}function f_hidden($name,$string=''){$string=f_getval($name,$string);$string=f_editorial($string);return '<input type="hidden" name="' .$name .'" id="' .$name .'" value="' .strip_quotes($string) .'">';}function f_file($name='file',$label='',$isMultiple=0){$lab=($label=='')?'':'<label id="' .$name .'lab" for="' .$name .'">[[' .$label .']]</label>';$nameMultiple=($isMultiple>0)?$name .'[]':$name;return $lab .' <input type="file" class="file" name="' .$nameMultiple .'" id="' .$name .'"' .($isMultiple>0?' multiple="multiple"':'') .'>';}function f_files($base='file',$isMultiple=0){return f_elem(f_file($base .'1','',$isMultiple)) .f_hidden('files_amount','1') .f_elem('<div id="addFiles"></div><a href="" onclick="addFiles();return false;"><small>[[one more file]]</small></a><script type="text/javascript">initFiles=1;addFiles=function(){initFiles++;document.getElementById(\'files_amount\').value=initFiles;var divNew=document.createElement("DIV");divNew.id="fileNew"+initFiles;newFiles=document.getElementById(\'addFiles\');newFiles.appendChild(divNew);document.getElementById(divNew.id).innerHTML+=\'' .f_elem(f_file($base ."'+initFiles+'",'',$isMultiple)) .'\';}</script>');}function f_textarea($name,$label='',$string=''){$string=f_getval($name,$string);$string=f_editorial($string);if(is_array($label)){$placeholder=$label[1];$label=$label[0];}$isPlaceholder=(isset($placeholder)&& $placeholder!='')?' placeholder="[[' .$placeholder .']]"':'';$lab=($label=='')?'':'<label id="' .$name .'lab" for="' .$name .'" class="label3">[[' .$label .']]</label>';return $lab .'<textarea name="' .$name .'" id="' .$name .'"' .$isPlaceholder .'>' .strip_quotes($string) .'</textarea>';}function f_check($name,$label='',$checked=0,$disable=0){$checked=f_getval($name,$checked);$disabled=($disable>0)?' disabled':'';$lab=($label=='')?'':'<label id="' .$name .'lab" class="label2" for="' .$name .'">[[' .$label .']]</label>';$check=($checked>0)?' checked="checked"':'';return '<nobr><input type="hidden" name="' .$name .'" value="' .(($disable>0)?$checked:0) .'"><input type="checkbox" class="checkbox" name="' .$name .'" id="' .$name .'"' .$check .' value="1"' .$disabled .'> ' .$lab .'</nobr>';}function f_checkbox($name,$label='',$checked=0,$disable=0){return f_check($name,$label,$checked,$disable);}function f_select($name,$label='',$equalizee,$selected_value='',$size=1,$multiselect=0){$selected_value=f_getval($name,$selected_value);$lab=($label=='')?'':'<label id="' .$name .'lab" for="' .$name .'">[[' .$label .']]</label>';$selsize=($size<2)?'':' size="' .$size .'"';$selmult=($multiselect<1)?'':' multiple="multiple"';$sel=$lab .' <select name="' .$name .'" id="' .$name .'"' .$selsize .$selmult .'>';foreach($equalizee as $ek=>$ev){$sel_rq=($ek==$selected_value)?' selected="selected"':'';$sel .= '<option value="' .$ek .'"' .$sel_rq .'>' .$ev .'</option>';}$sel .= '</select>';return $sel;}function f_radio($name,$equalizee,$selected_value=''){$selected_value=f_getval($name,$selected_value);$rad='';$rd=0;foreach($equalizee as $ek=>$ev){$ch_rq=($ek==$selected_value)?' checked="checked"':'';$rad .= '<span class="radioline"><nobr><input type="radio" class="radio" name="' .$name .'" id="' .$name .'_' .$rd .'"' .$ch_rq .' value="' .$ek .'"> <label id="' .$name .'_' .$rd .'lab" class="label2" for="' .$name .'_' .$rd .'">[[' .$ev .']]</label></nobr></span> ';$rd++;}return $rad;}function captcha($suffix=''){$captch=range(1,10);shuffle($captch);$signs=array('-','+','-','+','-','+');shuffle($signs);$numbers=array('1'=>'&#49;','2'=>'&#50;','3'=>'&#51;','4'=>'&#52;','5'=>'&#53;','6'=>'&#54;','7'=>'&#55;','8'=>'&#56;','9'=>'&#57;','10'=>'&#49;&#48;');$class0=generateUniCode(9,12,false) .$captch[1] .$captch[3] .$captch[5];$class00=generateUniCode(7,11,false) .$captch[2] .$captch[4] .$captch[0];$class1=generateUniCode(5,9,false);$class2=generateUniCode(6,7,false);$expr0=eval('return ' .$captch[0] .$signs[0] .$captch[1] .$signs[1] .$captch[2] .';');$expr1='<span class="' .$class1 .'">' .$numbers[$captch[0]] .'</span><span class="' .$class00 .'">' .str_replace(array('+','-'),array('&#43;','&#8722;'),$signs[2]) .'</span><span class="' .$class0 .'">' .$numbers[$captch[3]] .'</span><span class="' .$class2 .'">' .str_replace(array('+','-'),array('&#43;','&#8722;'),$signs[0]) .'</span><span class="' .$class0 .'">' .$numbers[$captch[4]] .'</span><span class="' .$class00 .'">' .str_replace(array('+','-'),array('&#43;','&#8722;'),$signs[3]) .'</span><span class="' .$class1 .'">' .$numbers[$captch[1]] .'</span><span class="' .$class2 .'">' .str_replace(array('+','-'),array('&#43;','&#8722;'),$signs[1]) .'</span><span class="' .$class1 .'">' .$numbers[$captch[2]] .'</span><span class="' .$class00 .'">' .str_replace(array('+','-'),array('&#43;','&#8722;'),$signs[4]) .'</span><span class="' .$class0 .'">' .$numbers[$captch[5]] .'</span><span class="' .$class2 .'">&#61;</span>';$form='<style type="text/css">.' .$class0 .',.' .$class00 .'{display:none;}</style>' .f_hidden('cap2' .$suffix,md5(password .$expr0)) .f_text('cap1' .$suffix,'[[Human code]]:<span class="required">*</span> ' .$expr1);return $form;}function captcha_check($suffix=''){if(@$_POST['cap1' .$suffix]!=false && md5(password .$_POST['cap1' .$suffix])!=@$_POST['cap2' .$suffix])return-2;elseif(@$_POST['cap2' .$suffix]!=false && trim(@$_POST['cap1' .$suffix])=='')return-1;elseif(@$_POST['cap1' .$suffix]!=false && md5(password .$_POST['cap1' .$suffix])==@$_POST['cap2' .$suffix])return 1;else return 0;}function mLogging(){$browser='Mozilla';$browsers=array('Opera','Maxthon','Chrome','Firefox','Safari','Netscape','MSIE','Avant Browser','YaBrowser','K-Meleon','Camino','Konqueror','Android','BlackBerry');$ua=$_SERVER['HTTP_USER_AGENT'];foreach($browsers as $b){if(strpos($ua,$b)>-1){$browser=$b;if($browser=='MSIE')$browser='Internet Explorer';break;}}$newData[]=@date('Y-m-d H:i:s') .'|' .$browser .'|' .$_SERVER['REMOTE_ADDR'];$prevData=explode("\n",filereader(Logger));$dataI=0;foreach($prevData as $str){if(trim($str)=='')continue;$dataI++;if($dataI<25)$newData[]=$str;}filewriter(Logger,join("\n",$newData));}function getElem($database,$tagName){return trim(xmler($database,$tagName));}function authSave($database,$pass){global $pseudonyms;$domain=$_SERVER['HTTP_HOST'];$domain1=(strpos($domain,'www.')>-1)?str_replace('www.','.',$domain):'.' .$domain;$domain2=(strpos($domain,'www.')>-1)?str_replace('www.','',$domain):$domain;if($pass==getElem($database,'pass')){if(@$_POST['remember']>0){setCookie('key',md5('per' .getElem($database,'pass')),time()+31536000,Siteroot,$domain1);setCookie('key',md5('per' .getElem($database,'pass')),time()+31536000,Siteroot,$domain2);}else{setCookie('key',md5('per' .getElem($database,'pass')),0,Siteroot,$domain1);setCookie('key',md5('per' .getElem($database,'pass')),0,Siteroot,$domain2);}}mLogging();define('LogWritten',1);$way=(file_exists(System .Special .Management .Fxt)|| isset($pseudonyms[Management]))?Management:Siteroot;setRedirect($way);}function authKeep($database){if(@$_COOKIE['key']==md5('per' .getElem($database,'pass'))){return 1;}return 0;}function authKill(){$domain=$_SERVER['HTTP_HOST'];$domain1=(strpos($domain,'www.')>-1)?str_replace('www.','.',$domain):'.' .$domain;$domain2=(strpos($domain,'www.')>-1)?str_replace('www.','',$domain):$domain;setcookie('key','',time()-10*365*24*60*60,Siteroot,$domain1);setcookie('key','',time()-10*365*24*60*60,Siteroot,$domain2);setRedirect(Siteroot);}function authForm(){global $rq;return f1('auth') .f_elem(f_required(f_password('pass','Password'))) .f_elem(f_check('remember','keep authorization',1)) .f_elem('<p><a href="' .setURL('remind-password') .'">[[Remind password]]</a></p>') .f2('Enter') .($rq==enterURL?'<script type="text/javascript">document.getElementById("pass").focus();</script>':'');}$months=array('','January','February','March','April','May','June','July','August','September','October','November','December');function specifyLang(){global $db;$lang=getElem($db,'lang');if(isset($_COOKIE['lang'])&&@$_COOKIE['lang']!='')$lang=trim($_COOKIE['lang']);if(trim($lang)=='')$lang='en';return trim($lang);}function translateThis($db,$m,$dic=''){$lang=specifyLang();if(file_exists(System .Langs2 .$lang .Fxt)){foreach(equalizer(filereader(System .Langs2 .$lang .Fxt))as $langKey=>$langTerm)$m=str_replace('[[' .$langKey .']]',$langTerm,$m);}$dictionary=($dic=='')?System .Langs .$lang .Fxt:trimslasher($dic) .'/' .$lang .Fxt;if($lang!=''&& $lang!='en'&& file_exists($dictionary)){foreach(equalizer(filereader($dictionary))as $langKey=>$langTerm)$m=str_replace('[[' .$langKey .']]',$langTerm,$m);}return($lang=='en'|| $dic=='')?str_replace(array('[[',']]'),array('',''),$m):$m;}function tilize($m){global $rq,$db;while(strpos($m,'[tile:')){$getTileName=substr($m,strpos($m,'[tile:')+6);$getTileName=substr($getTileName,0,strpos($getTileName,']'));$t='';if(file_exists(System .Tiles .$getTileName .Fxt))include_once System .Tiles .$getTileName .Fxt;$m=str_replace('[tile:' .$getTileName .']',$t,$m);}return $m;}function editize($m){global $getElemEditbl,$rq;while(strpos($m,'[edit:')){$getEditblName=substr($m,strpos($m,'[edit:')+6);$getEditblName=substr($getEditblName,0,strpos($getEditblName,']'));$ed=xmler($getElemEditbl,$getEditblName);$term=trim($ed)==''?'edit part':'edit';if(defined('manage'))$ed .= ' <a href="' .setURL('edit-part','part=' .$getEditblName .'&backurl=' .$rq) .'" title="[[Editing part]]: ' .$getEditblName .'" class="link-edit link-edit-part">[[(' .$term .')]]</a>';$m=str_replace('[edit:' .$getEditblName .']',$ed,$m);}return $m;}function phpcodeize($m){global $getElemPhpcodes,$rq;while(strpos($m,'[phpcode:')){$getPhpcodeName=substr($m,strpos($m,'[phpcode:')+9);$getPhpcodeName=substr($getPhpcodeName,0,strpos($getPhpcodeName,']'));$edget=xmler($getElemPhpcodes,$getPhpcodeName);$ed='';if(trim($edget)!=''){ob_start();eval("\n?" .">" .$edget ."<" ."?php\n");$ed=ob_get_contents();ob_end_clean();}if(defined('manage'))$ed .= ' <a href="' .setURL('edit-phpcode','part=' .$getPhpcodeName .'&backurl=' .$rq) .'" title="[[PHP code]]: ' .$getPhpcodeName .'" class="link-edit link-edit-phpcode">[[(edit PHP code)]]</a>';$m=str_replace('[phpcode:' .$getPhpcodeName .']',$ed,$m);}return $m;}function menuize($m){global $getElemUsermenu,$rq;while(strpos($m,'[menu:')){$getUsermenuName=substr($m,strpos($m,'[menu:')+6);$getUsermenuName=substr($getUsermenuName,0,strpos($getUsermenuName,']'));$tag='';$divider=' ';if(strpos($getUsermenuName,':')>0){if(substr_count($getUsermenuName,':')==2)list($getUsermenuName,$tag,$divider)=explode(':',$getUsermenuName);else list($getUsermenuName,$tag)=explode(':',$getUsermenuName);}$mneq=equalizer(xmler($getElemUsermenu,$getUsermenuName));$mn=createMenu($mneq,'b',$divider,$tag,'u-' .$getUsermenuName .'-');$term=trim($mn)==''?'edit menu':'edit';if(defined('manage'))$mn .= ' <a href="' .setURL('edit-menu','menu=' .$getUsermenuName .'&backurl=' .$rq) .'" title="[[Editing menu]]: ' .$getUsermenuName .'" class="link-edit link-edit-menu">[[(' .$term .')]]</a>';if($divider!=' ')$usermenuComplex=$getUsermenuName .':' .$tag .':' .$divider;else $usermenuComplex=($tag=='')?$getUsermenuName:$getUsermenuName .':' .$tag;$m=str_replace('[menu:' .$usermenuComplex .']',$mn,$m);}return $m;}function parcellize($mAllStable,$m){global $rq,$db,$mTopics;while(strpos($m,'[parcelle:')){$getPl=substr($m,strpos($m,'[parcelle:')+10);$getPl=substr($getPl,0,strpos($getPl,']'));$storePl=$getPl;$pl='';if($getPl=='year'|| $getPl=='y'){$pl=@date('Y');}if(strpos($getPl,'range:')>-1 || strpos($getPl,'from:')>-1 || strpos($getPl,'since:')>-1){$startYear=str_replace(array('range:','from:','since:'),array('','',''),$getPl);$pl=($startYear>=@date('Y'))?$startYear:$startYear .'&ndash;' .@date('Y');}else if($getPl=='engine'){$pl=Engine .' ' .EngineVersion;}else if($getPl=='enginelink'){$pl='[[Powered by]] <a href="' .EngineWebsite .'" target="_blank" title="' .Engine .' ' .EngineVersion .'">' .Engine .'</a>';}else if($getPl=='sitecopy'){global $sitenameView;$pl='&copy; <a href="' .Siteroot .'">' .$sitenameView .'</a>';}else if($getPl=='version'){$pl=EngineVersion;}else if($getPl=='currentPage'|| $getPl=='currentpage'|| $getPl=='current-page'|| $getPl=='current'){$pl='http://' .ThisServer .setURL($rq);}else if($getPl=='server'){$pl='http://' .ThisServer .Siteroot;}else if($getPl=='lang'){$pl=specifyLang();}else if((strpos($getPl,'records')>-1 || strpos($getPl,'titles')>-1 || strpos($getPl,'posts')>-1 || strpos($getPl,'pages')>-1 || strpos($getPl,'static')>-1 || strpos($getPl,'tag-')>-1 || strpos($getPl,'blog-')>-1 || strpos($getPl,'in-')>-1 || strpos($getPl,'drafts')>-1 || strpos($getPl,'secret')>-1 || strpos($getPl,'faved')>-1 ||(strpos($getPl,'favo')>-1 && strpos($getPl,'rite')>0))&&(strpos($getPl,'intag-')===false && strpos($getPl,'withtag-')===false)){$pHasDate=0;$plLim='';$markCurrent=1;$plOptions=array();if(strpos($getPl,'?')>-1){list($getPl,$plOptions)=explode('?',$getPl);$plOptions=explode('&',$plOptions);$plOptionsTmp=array();foreach($plOptions as $plOption){if(strpos($plOption,'=')>-1){list($getPlK,$getPlV)=explode('=',$plOption);$plOptionsTmp[$getPlK]=$getPlV;}else{$plOptionsTmp[$plOption]=$plOption;}}$plOptions=$plOptionsTmp;}if(substr_count($getPl,':')<1){$plDef=$getPl;}else if(substr_count($getPl,':')>2){list($plDef,$plLim,$pHasDate,$markCurrent)=explode(':',$getPl);}else if(substr_count($getPl,':')>1){list($plDef,$plLim,$pHasDate)=explode(':',$getPl);}else{list($plDef,$plLim)=explode(':',$getPl);}if(strpos($plLim,'/')){list($plLim,$plTag)=explode('/',$plLim);}else $plTag='p';$pl='<div class="listTitles">';$plI=0;$mAllTurn=$mAllStable;$plDefIn=($plDef=='drafts')?'drafts':'posts';if(strpos($plLim,'r')){$mAllTurn=array_reverse($mAllStable[$plDefIn]);$plLim=str_replace('r','',$plLim);$plLim=str_replace('-','',$plLim);}else if(strpos($plLim,'d')){$mAllTurn=$mAllStable[$plDefIn];$plLim=str_replace('d','',$plLim);$plLim=str_replace('-','',$plLim);}else if(strpos($plLim,'s')){shuffle($mAllStable[$plDefIn]);$mAllTurn=$mAllStable[$plDefIn];$plLim=str_replace('s','',$plLim);$plLim=str_replace('-','',$plLim);}else if(strpos($plLim,'u')){$mAllTurn=array();foreach($mAllStable[$plDefIn]as $item){$mAllTurn[$item['upmicrotime']]=$item;}krsort($mAllTurn);$plLim=str_replace('u','',$plLim);$plLim=str_replace('-','',$plLim);}else if(strpos($plLim,'abc')){$mAllTurn=array();foreach($mAllStable[$plDefIn]as $item){$mAllTurn[$item['h1'] .' ' .$item['id']]=$item;}ksort($mAllTurn);$plLim=str_replace('abc','',$plLim);$plLim=str_replace('-','',$plLim);}else if(strpos($plLim,'cba')){$mAllTurn=array();foreach($mAllStable[$plDefIn]as $item){$mAllTurn[$item['h1'] .' ' .$item['id']]=$item;}krsort($mAllTurn);$plLim=str_replace('cba','',$plLim);$plLim=str_replace('-','',$plLim);}else if(strpos($plLim,'123')){$mAllTurn=array();foreach($mAllStable[$plDefIn]as $item){$mAllTurn[$item['alias']]=$item;}ksort($mAllTurn);$plLim=str_replace('123','',$plLim);$plLim=str_replace('-','',$plLim);}else if(strpos($plLim,'321')){$mAllTurn=array();foreach($mAllStable[$plDefIn]as $item){$mAllTurn[$item['alias']]=$item;}krsort($mAllTurn);$plLim=str_replace('321','',$plLim);$plLim=str_replace('-','',$plLim);}else{$mAllTurn=$mAllStable[$plDefIn];}$plDefQ=100;if(strpos($plDef,'^')>0){list($plDef,$plDefQ)=explode('^',$plDef);$plDefQ=$plDefQ-1;}foreach($mAllTurn as $mItem){if(strpos($plDef,'in-')===false){if(substr_count($mItem['alias'],'/')>$plDefQ)continue;}if(strpos($plDef,'tag-')>-1){$getTag=substr($plDef,4);if(!in_array($getTag,$mItem['tags']))continue;}else if(strpos($plDef,'blog-')>-1){$getBlog=substr($plDef,5);if($getBlog>0 && $mItem['lenta']!=$getBlog)continue;else if($getBlog<1 && $mItem['lenta']!='')continue;}else if(strpos($plDef,'in-')>-1){$getIn=substr($plDef,3);if(strpos($mItem['alias'],$getIn .'/')!==0 || substr_count(str_replace($getIn .'/','',$mItem['alias']),'/')>$plDefQ)continue;}else if($plDef=='titles'|| $plDef=='posts'){if($mItem['isPage']>0)continue;}else if($plDef=='pages'|| $plDef=='static'){if($mItem['isPage']<1)continue;}else if($plDef=='faved'||(strpos($plDef,'favo')>-1 && strpos($plDef,'rite')>0)){if($mItem['faved']<1)continue;}else if($plDef=='secret'){if($mItem['secret']<1)continue;}if($plLim!=''&& $plLim!='all'&& $plI>=$plLim)break;$hasDate='';if(@$pHasDate>0){$getDate=$mItem['date'];$getNDate=$mItem['ndate'];$getViewDate=($getNDate!='')?$getNDate:$getDate;if(@$pHasDate==1){$hasDate=' <small>' .humanifyDate($getViewDate) .'</small>';}else if(@$pHasDate==2){$insertSmallHighlight=($getViewDate ==@date('Y-m-d'))?' class="small-highlight"':'';$hasDate=' <small' .$insertSmallHighlight .'>' .humanifyDate($getViewDate) .'</small>';}else if(@$pHasDate==3){list($getViewY,$getViewM,$getViewD)=explode('-',$getViewDate);$hasDate=' <small>' .$getViewY .'</small>';}else if(@$pHasDate==4){list($getViewY,$getViewM,$getViewD)=explode('-',$getViewDate);$insertSmallHighlight=($getViewY ==@date('Y'))?' class="small-highlight"':'';$hasDate=' <small' .$insertSmallHighlight .'>' .$getViewY .'</small>';}else if(@$pHasDate==5){list($getViewY,$getViewM,$getViewD)=explode('-',$getViewDate);$insertSmallHighlight='';if($getViewY ==@date('Y')){$insertSmallHighlight=' class="small-highlight"';}else if($getViewY ==(@date('Y')-1)){$insertSmallHighlight=' class="small-highlight-1"';}$hasDate=' <small' .$insertSmallHighlight .'>' .$getViewY .'</small>';}else if(@$pHasDate==6){list($getViewY,$getViewM,$getViewD)=explode('-',$getViewDate);$insertSmallHighlight='';if($getViewY ==@date('Y')){$insertSmallHighlight=' class="small-highlight"';}else if($getViewY ==(@date('Y')-1)){$insertSmallHighlight=' class="small-highlight-1"';}else if($getViewY ==(@date('Y')-2)){$insertSmallHighlight=' class="small-highlight-2"';}$hasDate=' <small' .$insertSmallHighlight .'>' .$getViewY .'</small>';}}$setPlUrlPart=($plDef=='drafts')?'draft':'post';$setPlUrl=($mItem['alias']!='')?$mItem['alias']:$setPlUrlPart .'-' .$mItem['id'];$plTitle=$mItem['h1']!=''?$mItem['h1']:'***';$prefix='';if(isset($plOptions['prefix'])|| $plOptions['pref']){$prefix=$plOptions['prefix'];}$pl1='<' .$plTag .' class="contents">' .$prefix;$insertImages='';if(in_array('images',$plOptions)|| in_array('preview',$plOptions)){$insertImagesQ=0;$attImages=array();foreach($mItem['files']as $afile){if($insertImagesQ>=maxPicsAmount)break;$afilel=strtolower($afile);if((strpos($afilel,'.jpg')>0 || strpos($afilel,'.jpeg')>0 || strpos($afilel,'.gif')>0 || strpos($afilel,'.png')>0)){$attImages[]='<span class="attached_image_link attached_images_group_rest"><img src="' .Siteroot .System .Storage .$afile .'" alt="" class="attached_image_img"></span>';}$insertImagesQ++;}$insertImages .= join(' ',$attImages) .'<br>';}$insertTopics='';if(in_array('topics',$plOptions)|| in_array('tags',$plOptions)){$listTopics=array();foreach($mItem['tags']as $tag){$listTopics[]=$mTopics[$tag];}sort($listTopics);$insertTopics .= '<br><i class="parcelle-topics"><small>' .join(', ',$listTopics) .'</small></i>';}$insertIntro='';if(isset($plOptions['intro'])|| isset($plOptions['preface'])){$insertIntro=$mItem['text'];if(empty($insertIntro)){$insertIntroFile=filereader(System .DbRecords .$mItem['code'] .Fxt);$insertIntro=!empty($insertIntroPre=xmler($insertIntroFile,'r:pre'))?$insertIntroPre:xmler($insertIntroFile,'r:txt');}if(!empty($insertIntro)){$introCut=250;if($plOptions['intro']>0){$introCut=$plOptions['intro'];}else if($plOptions['preface']>0){$introCut=$plOptions['preface'];}$insertIntro='<br>' .reduceText(strip_tags(str_replace(array('</p>','<br>','<br/>','<br />'),' ',$insertIntro)),$introCut);}}$pl2=$hasDate .$insertTopics .'</' .$plTag .'>';$italic1='';$italic2='';if(in_array('italic',$plOptions)|| in_array('oblique',$plOptions)){$italic1='<i>';$italic2='</i>';}if($setPlUrl==$rq){if($markCurrent>2)$pl .= $pl1 .$italic1 .'<a href="' .setURL($setPlUrl) .'" class="selected"><b>' .$insertImages .$plTitle .'</b></a>' .$insertIntro .$italic2 .$pl2;else if($markCurrent>1)$pl .= $pl1 .$italic1 .'<a href="' .setURL($setPlUrl) .'" class="selected">' .(in_array('bold',$plOptions)|| in_array('strong',$plOptions)?'<b>':'') .$insertImages .$plTitle .(in_array('bold',$plOptions)|| in_array('strong',$plOptions)?'</b>':'') .'</a>' .$insertIntro .$italic2 .$pl2;else if($markCurrent>0)$pl .= $pl1 .$insertImages .$italic1 .'<b>' .$plTitle .'</b>' .$insertIntro .$italic2 .$pl2;else continue;}else{$pl .= $pl1 .$italic1 .'<a href="' .setURL($setPlUrl) .'">' .(in_array('bold',$plOptions)|| in_array('strong',$plOptions)?'<b>':'') .$insertImages .$plTitle .(in_array('bold',$plOptions)|| in_array('strong',$plOptions)?'</b>':'') .'</a>' .$insertIntro .$italic2 .$pl2;}if($insertImages != ''|| $insertTopics != ''){$pl .= '<br>';}$plI++;}$pl .= '</div>';}else if($getPl=='tags'|| $getPl=='tags-semantic'|| $getPl=='semantic-tags'|| $getPl=='semantictags'|| strpos($getPl,'intag-')>-1 || strpos($getPl,'intag-')>-1 || strpos($getPl,'withtag-')>-1 || $getPl=='blogs'){$getPlTag='span';$getPlEnvelope='topicList tagList';if(substr_count($getPl,':')>1){list($getPl,$getPlEnvelope,$getPlTag)=explode(':',$getPl);}else if(substr_count($getPl,':')>0){list($getPl,$getPlTag)=explode(':',$getPl);}if($getPl=='tags'){$pl=topicList($getPlEnvelope);}else if($getPl=='tags-semantic'|| $getPl=='semantic-tags'|| $getPl=='semantictags'){$pl=topicList($getPlEnvelope,$getPlTag,'semantic');}else if(strpos($getPl,'intag-')>-1){$getIn=substr($getPl,6);$pl=topicList($getPlEnvelope,$getPlTag,'abc',$getIn);}else if(strpos($getPl,'withtag-')>-1){$getIn=substr($getPl,8);$pl=topicList($getPlEnvelope,$getPlTag,'abc',$getIn,true);}else if($getPl=='blogs'){$pl=blogList('blogList','p');}}else if($getPl=='search'){if($rq!='search')$pl=searchForm();}else if($getPl=='auth'|| $getPl=='login'|| $getPl=='enter'){if($rq!=enterURL &&!defined('manage'))$pl=authForm();}else if($getPl=='today'){$pl=humanifyDate(@date('Y-m-d'));}else if($getPl=='now'){$pl=humanifyDate(@date('Y-m-d H:i:s'));}else if($getPl=='feedback'){$pl=feedbackForm();}$m=str_replace('[parcelle:' .$storePl .']',$pl,$m);}return $m;}function functionize($m){while(strpos($m,'[func:')){$getFnName=substr($m,strpos($m,'[func:')+6);$getFnName=substr($getFnName,0,strpos($getFnName,']'));$arg='';$rest='';if(strpos($getFnName,':')>0){list($getFnName,$arg)=explode(':',$getFnName);$rest=':' .$arg;}$f='';if(function_exists($getFnName))$f=($arg=='')?$getFnName():$getFnName($arg);$m=str_replace('[func:' .$getFnName .$rest .']',$f,$m);}return $m;}function smile($s){$smiles=array(';)'=>'blink',';-)'=>'blink','%)'=>'crazy','%-)'=>'crazy',':-/'=>'doubt','^^'=>'kawaii','^_^'=>'kawaii','^__^'=>'kawaii','^___^'=>'kawaii',':*'=>'kiss',':-*'=>'kiss',':D'=>'lol',':-D'=>'lol',';D'=>'lol',';-D'=>'lol','8-)'=>'oo',':)'=>'smile',':-)'=>'smile','=)'=>'smile',';('=>'sorrow',';-('=>'sorrow',':('=>'sorrow',':-('=>'sorrow',':P'=>'tongue',':-p'=>'tongue',':-P'=>'tongue');foreach($smiles as $smCode=>$smImg){if(file_exists(System .'smiles/' .$smImg .'.gif'))$s=str_replace($smCode,'<img src="' .Siteroot .System .'smiles/' .$smImg .'.gif" class="smile">',$s);}return $s;}$primaryHtmlTemplate='<!DOCTYPE html>
<html lang="<m:lang>">
<head>
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Expires" content="0">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="keywords" content="<m:keywords>">
	<meta name="description" content="<m:description>">
	<meta name="generator" content="<m:engine>">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<title><m:title></title>
	<m:favicon>
	<link rel="stylesheet" type="text/css" href="<m:style>" media="screen">
	<link rel="stylesheet" type="text/css" href="'.Siteroot.System.Themes.'common/print.css" media="print">
    <link rel="stylesheet" type="text/css" href="'.Siteroot.System.Themes.'common/mobile.css" media="screen and (max-width: 768px)">
	<m:js>
	<m:rss>
</head>
<body class="<m:body:class>" id="<m:body:id>">
	<div id="canvas">
		<div id="main">
			<div id="top">
				<div id="management">
					<m:management>
				</div>
				<div id="header">
					<m:caption>
					<m:motto>
				</div>
				<div id="menu">
					<m:menu>
				</div>
			</div>
			<div id="central">
				<div id="content">
					<m:all>
				</div>
				<div id="sidebar">
					<m:sidebar>
				</div>
			</div>
		</div>
		<div id="footer">
			<div id="footer-inner"><m:copy></div>
		</div>
	</div>
</body>
</html>';$primaryPostTemplate='<div class="<m:p:attr>" id="post-<m:p:id>">
	<m:p:breadcrumbs>
	<m:p:h1>
	<m:p:images>
	<m:p:tags>
	<m:p:date> <m:p:time>
	<m:p:text>
	<m:p:files>
	<m:p:edit>
	<m:p:comments>
</div>';if(!file_exists(System .Themes .Main .Template))filewriter(System .Themes .Main .Template,'<m:html>
' .$primaryHtmlTemplate .'
</m:html>
<m:phtml>
' .$primaryPostTemplate .'
</m:phtml>');if(!file_exists(System .Themes .Main .Style)){filewriter(System .Themes .Main .Style,'*{margin:0;padding:0;font-family:"Trebuchet MS",Arial,Helvetica,Sans-Serif;}
html,body{height:100%;}
input{padding:2px 4px;}
body,p,div,table,td,th,input.submit,button,li{font-size:10pt;}
body{background:#fff;text-align:center;}
img,a img{border:0;}
table{border-collapse:collapse;background:#fff;}
table td,table th{padding:7px 7px 7px 3px;vertical-align:top;border-bottom:1px solid #ccc;text-align:left;}
table th{background:#eee;}
table th.th-active,table tr:hover td{background:#ddd;}
div{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;-ms-box-sizing:border-box;box-sizing:border-box;}
a,a:link,a:active,a:visited{color:#327CCB;text-decoration:none;border-bottom:1px solid #eee;padding-bottom:2px;}
a b{color:#327CCB;}
a:hover,a:hover b{color:#CB3232;}
label{cursor:pointer;color:#555;}
ul,ol{padding:2px 0;}
li{line-height:1.5;margin-left:17px;}
small{font-size:7pt;}
code{color:#1347b1;font-family:"Courier New",Monotype;font-size:11pt;font-weight:bold;}
p{line-height:1.6;padding-bottom:8px;}
h1{color:#333;font-weight:normal;font-size:22pt;padding-bottom:20px;}
h2{color:#333;font-weight:normal;font-size:18pt;padding-bottom:15px;}
::selection{background:#CB3232;color:#FFC;}
::-moz-selection{background:#CB3232;color:#FFC;}
a,a b{-webkit-transition:color .3s linear;-moz-transition:color .3s linear;-o-transition:color .3s linear;-ms-transition:color .3s linear;transition:color .3s linear;}
#canvas{width:970px;margin:0 auto;padding-top:50px;text-align:left;}
#management{position:fixed;top:0;left:0;z-index:12000;width:100%;padding:18px 10px 13px;text-align:center;background:rgba(255,255,255,0.9);border-bottom:1px solid #eee;_background:white;_position:absolute;}
#management:hover{background:white;}
#management a{font-size:10pt;border-bottom:0;margin:0 20px;font-size:8pt;text-transform:uppercase;}
#header a{display:block;padding:50px 0;font-size:26pt;text-transform:uppercase;border:0;color:#bbb;}
#header a:hover{color:#CB3232;}
#motto-line{padding:15px 50px 13px;border-top:1px solid #eee;text-align:center;color:#bbb;text-transform:uppercase;letter-spacing:5px;font-size:9pt;}
#menu{padding:20px 0;margin-bottom:30px;border-top:1px solid #eee;border-bottom:1px solid #eee;text-align:center;}
#menu a,#menu b{border-bottom:0;margin:0 20px;}
#content{float:left;width:650px;}
#sidebar{float:right;width:270px;padding-left:27px;border-left:1px solid #eee;}
#sidebar #avatar{padding-bottom:15px;}
#sidebar #avatar img{border:1px solid #ddd;-moz-box-shadow:0 1px 5px rgba(0,0,0,0.3); -webkit-box-shadow:0 1px 5px rgba(0,0,0,0.3);box-shadow:0 1px 5px rgba(0,0,0,0.3);}
#sidebar div.sidetext{padding:15px 25px 0 0;}
#sidebar div.sidetextLast{padding-top:25px;clear:both;float:none;}
#sidebar div.sidetext,#sidebar div.sidetext p{font-size:10pt;line-height:1.4;}
#sidebar div.sideLinks{padding:15px 0;}
#sidebar div.sideLinks div{padding:0 0 10px;}
#footer{padding-top:45px;float:none;clear:both;}
#footer-inner{border-top:1px solid #ddd;padding:25px 0 40px;color:#999;}
.form-elem{padding-top:3px;padding-bottom:9px;}
.required{color:#c00;}
.form-elem label{display:block;padding-bottom:3px;}
.form-elem label.label2{display:inline;padding-bottom:0;}
.form-elem label.forcheckbox{display:inline;padding-bottom:0;margin-left:4px;}
input.text, input.password, select{height:20px;line-height:20px;border:1px solid #BBC;color:#333;padding:2px;width:350px;}
select{height:24px;line-height:24px;}
.form-elem input.text,.form-elem input.password,.form-elem select,.form-elem input.file{display:block;width:450px;}
.form-elem select{height:24px;line-height:24px;}
.form-elem textarea{display:block;width:450px;height:120px;border:1px solid #BBC;color:#545a3a;padding:2px;}
input.text:focus,input.password:focus,textarea:focus,input.text:hover,input.password:hover,textarea:hover{border:1px solid #234971;}
input.submit{background:#4a6b7b;color:#fff;border:0;border-radius:3px;-moz-border-radius:3px;padding:7px 12px;cursor:pointer;margin-top:9px;}
.mTable input.submit{margin-top:0;}
input.submit:hover{background:#cf3805;}
#cap1{width:75px;}
#cap1lab,#cap1{display:inline;}
#listing,#cutting,#ext{width:150px;}
#mainpage{width:250px;}
#new #text,#edit #text{width:595px;height:400px;}
input#h1{width:590px;font-size:11pt;height:30px;line-height:30px;}
.manage form input.submit{padding:1px 8px;height:20px;line-height:20px;float:right;position:relative;top:-10px;font-size:9pt;margin-left:10px;}
#searchForm{color:#777;margin-bottom:20px;}
.currentItem{margin-right:20px;white-space:nowrap;}
.setItems{line-height:1.9;}
table.mTable{margin:3px 0 25px;}
table.mTable tr.tr:hover{background:#e5e5e5;}
table.mTable td{padding:5px;vertical-align:middle;border-top:1px solid #e5e5e5;}
table.mTable td input.submit{font-size:9pt;padding:5px 8px !important;}
.attached_images{margin-bottom:10px;}
.attached_image_link{text-decoration:none !important;}
.attached_image_img{border:1px solid #ddd;max-width:500px;width:expression(this.width >500?"500px":this.width);}
a:hover .attached_image_img{border:1px solid #bbb;}
.attached_files{padding-left:20px;}
.attached_files li a{font-style:italic;font-size:10pt;}
a.attached_image_link{border:0;}
.attached_images_2 .attached_image_img{height:200px;}
.attached_images_2_first{margin-right:3px;}
.attached_images_group_first .attached_image_img{display:block;margin-bottom:5px;}
.attached_images_group_rest .attached_image_img{height:80px;}
input.submit{background-image:-moz-linear-gradient(top,#999999,#333333);background-image:-ms-linear-gradient(top,#999999,#333333);background-image:-webkit-gradient(linear,0 0,0 100%,from(#999999),to(#333333));background-image:-webkit-linear-gradient(top,#999999,#333333);background-image:-o-linear-gradient(top,#999999,#333333);background-image:linear-gradient(top,#999999,#333333);background-repeat:repeat-x;}
input.submit:hover{background-image:-moz-linear-gradient(top,#888888,#111111);background-image:-ms-linear-gradient(top,#888888,#111111);background-image:-webkit-gradient(linear,0 0,0 100%,from(#888888),to(#111111));background-image:-webkit-linear-gradient(top,#888888,#111111);background-image:-o-linear-gradient(top,#888888,#111111);background-image:linear-gradient(top,#888888,#111111);background-repeat:repeat-x;}
#sidebar #searchForm #term{width:120px;}
#sidebar #auth #pass{width:175px;}
#content .comments{margin-top:25px;width:600px;padding:15px;border:1px solid #dde;border-radius:5px;-moz-border-radius:5px;-webkit-border-radius:5px;}
.post .tags{font-size:9pt;float:left;width:350px;line-height:14pt;}
.post .tags a{font-size:9pt;}
.post .date{font-size:9pt;color:#aac;float:right;line-height:14pt;}
.post .date a{color:#aac;border-bottom:0;}
.post .post-text{float:none;clear:both;padding-top:15px;}
div.post-faved h1:after,div.post-faved > h2:after{content:"&#9829;";margin-left:5px;color:#efb0b0;font-size:14pt;vertical-align:super;}
.post{padding:10px 0 35px;}
.post-inlenta{border-bottom:1px solid #dde;margin-bottom:25px;}
.comment{line-height:1.9;padding-top:15px;padding-bottom:25px;}
.comment-author{font-weight:bold;}
.manage-comment form input.submit{top:0;}
.manage-comment{margin-left:10px;float:right;}
.manage-comment form input.submit{font-size:7pt;padding:1px 3px;height:15px;line-height:15px;background:#777;}
.manage-comment form input.submit:hover{background:#333;}
.comment small{margin-left:3px;font-size:7pt;color:#777;}
.form-elem textarea#cText{width:500px;height:175px;}
.comment-answer{padding-left:10px;margin:6px 0 0 20px;font-size:9pt;line-height:1.5;border-left:1px dotted #333;}
.paginator p{padding-bottom:10px;}
.paginator p b,.paginator p a{margin-left:15px;}
.term{background:#FFC;color:#300;padding:0 2px;}
.removePost,.removePost form{text-align:right;}
.message{font-weight:bold;color:#a00;padding:45px 0;}
#topicsEditor{border:1px solid #d5d1d1;background:#e6e2e2;padding:15px !important;border-radius:6px;-moz-border-radius:6px;-webkit-border-radius:6px;margin:10px;width:300px;}
#topicsEditor input.text{width:250px;}
#closeEditingTopics{border:none;margin-left:250px;font-size:13pt;}
div.paginator p.delimiter{color:#fff;}
div.paginator p.sorter{color:#999;line-height:30px;}
div.paginator p.sorter b{color:#CB3232;}
div.form-elem-set{padding-top:3px;padding-bottom:9px;}
div.form-elem-set label.for-elem-set{display:block;padding-bottom:3px;}
div.form-elem-set select{width:auto;}
a.secret,.secret{color:#c30;}
a.secret:hover{color:#f00;}
div.topicList{padding:20px;border-left:1px solid #eee;line-height:1.7;}
div.listTitles small{color:#999;margin-left:5px;}
div.listTitles small.small-highlight{font-weight:bold;color:orange;}
div.listTitles small.small-highlight-1{font-weight:bold;color:#c00;}
div.listTitles small.small-highlight-2{color:#c00;}
div.breadcrumbs{padding-bottom:20px;}
div.breadcrumbs a,div.breadcrumbs b,div.breadcrumbs span{font-size:8pt;color:#999;font-weight:normal;}
div.breadcrumbs span{margin:0 7px;}
div.breadcrumbs a:hover{color:#990033;}
div.media{padding:0 0 10px;}
span.upside-down-envelope{border-left:1px solid #ddd;margin-left:30px;padding-left:19px;}
p.premoderated-comments{background-color:#ffb;color:#C60;padding:5px;text-align:center;border-radius:5px; margin-bottom:10px;}
span.to-moderate{color:#F30;font-size:8pt;}
.yashare-auto-init a{border:0 !important;}
div.social{float:none;clear:both;padding:0 0 10px;margin-left:-5px;}
#htmlTemplate,#postTemplate,#cssCode{width:550px;height:500px;}
.commentLink a.cl{margin-right:10px;}
a.rating-plus{font-size:12pt;}
.ratings small{background:#eee;color:#777;margin-left:3px;border-radius:3px;padding:1px 6px;font-size:8pt;position:relative;top:-1px;}
div.intro{padding:5px 0 10px;}');}if(!file_exists(System .Themes .'common/print.css'))filewriter(System .Themes .'common/print.css','#management,#menu,#sidebar,#footer,form{display:none;}#header{font-size:18pt;font-weight:bold;padding-bottom:30px;}');if(file_exists(System .Preprocessor)){foreach(viewFolder(System .Preprocessor)as $launch){include_once $launch;}}if(!file_exists(System .Db)){filewriter(System .Db);if(!file_exists(Protector))filewriter(Protector,"AddDefaultCharset UTF-8 \nOptions -Indexes \nRewriteEngine on \nRewriteCond	%{REQUEST_URI}	!" .System ."* \nRewriteCond	%{REQUEST_URI}	!Userfiles* \nRewriteCond	%{REQUEST_URI}	!robots.txt \nRewriteCond	%{REQUEST_URI}	!sitemap.xml \nRewriteCond	%{REQUEST_URI}	!favicon.* \nRewriteCond	%{REQUEST_URI}	!apple-touch-icon.* \nRewriteCond	%{REQUEST_URI}	!index.php \nRewriteRule	^(.*)$		index.php?q=$1 [QSA]");if(!file_exists(Robots))filewriter(Robots,"User-agent: *\nDisallow: " .Siteroot .System ."\nSitemap: http://" .ThisServer ."/" .Sitemap);if(file_exists(System .Db)){setRedirect(Siteroot);}else{die('<!DOCTYPE html><html><head><title>Meruert</title></head><body><p style="padding:100px;color:#c00;font-family:Sans-Serif;"><b>Meruert could not create system files; the root directory should be writeable</b></p></body></html>');}}else{$db=filereader(System .Db);if(getElem($db,'separate')>0)define('Separate',1);if(getElem($db,'optimized')>0)define('Optimized',1);$getElemPass=getElem($db,'pass');$getElemLang=getElem($db,'lang');$getElemTheme=getElem($db,'theme');$getElemExt=getElem($db,'ext');$getElemTopics=getElem($db,'topics');$getElemBlogs=getElem($db,'blogs');$getElemSitename=getElem($db,'sitename');$getElemMotto=getElem($db,'motto');$getElemComments=getElem($db,'comments');$getElemPremoderateComments=getElem($db,'premoderate');$getElemEmail=getElem($db,'email');$getElemPaginate=getElem($db,'paginate');$getElemListing=getElem($db,'listing');$getElemCutting=getElem($db,'cutting');$getElemSecret=getElem($db,'secret');$getElemClosed=getElem($db,'closed');$getElemHideblog=getElem($db,'hideblog');$getElemHidemanagement=getElem($db,'hidemanagement');$getElemHiderss=getElem($db,'hiderss');$getElemHidesearch=getElem($db,'hidesearch');$getElemHidefiles=getElem($db,'hidefiles');$getElemHidefav=getElem($db,'hidefav');$getElemHidesecret=getElem($db,'hidesecret');$getElemHidedrafts=getElem($db,'hidedrafts');$getElemHidecomments=getElem($db,'hidecomments');$getElemHideratings=getElem($db,'hideratings');$getElemHidetopics=getElem($db,'hidetopics');$getElemKeywords=getElem($db,'keywords');$getElemDescription=getElem($db,'description');$getElemMainpage=getElem($db,'mainpage');$getElemNoBackups=getElem($db,'nobackups');$getElemNoAutoSaving=getElem($db,'noautosaving');$getElemNoRTE=getElem($db,'norte');$getElemSocial=getElem($db,'social');$getElemRaise=getElem($db,'raise');$getElemRatings=getElem($db,'ratings');$getElemPositiveRatings=getElem($db,'positiveratings');$getElemMultilang=getElem($db,'multilang');$getElemEditbl=getElem($db,'editbl');$getElemPhpcodes=getElem($db,'phpcodes');$getElemUsermenu=getElem($db,'usermenu');$getElemLangs=getElem($db,'langs');$getElemLangs=($getElemLangs!='')?explode(',',$getElemLangs):array();$getElemOrder=getElem($db,'order');$templateDir=(($getTemplateName=$getElemTheme)!='')?$getTemplateName .'/':Main;$getTemplateSet=(file_exists(System .Themes .$templateDir .Template))?filereader(System .Themes .$templateDir .Template):filereader(System .Themes .Main .Template);$getHtmlTemplate=xmler($getTemplateSet,'m:html');if(trim($getHtmlTemplate)=='')$getHtmlTemplate=$primaryHtmlTemplate;$getPostTemplate=xmler($getTemplateSet,'m:phtml');if(trim($getPostTemplate)=='')$getPostTemplate=$primaryPostTemplate;if($getElemPass==''&& $getElemLang==''){if(isset($_POST['lang'])){filewriter(System .Db,'<lang>' .$_POST['lang'] .'</lang>');setRedirect(Siteroot);}$langChoose=array('en'=>'English');$langChosenCode='en';if(file_exists(System .Langs)){foreach(viewFolder(System .Langs,'f')as $lngFileRead){$getLngFileContent=equalizer(filereader($lngFileRead));$langChooseCode=str_replace(Fxt,'',basename($lngFileRead));$langChoose[$langChooseCode]=$getLngFileContent['lang'];if(strpos($_SERVER['HTTP_ACCEPT_LANGUAGE'],$langChooseCode)>-1)$langChosenCode=$langChooseCode;}}asort($langChoose);$m='<h1>' .Engine .'</h1>' .f1('setlang') .f_elem(f_select('lang','',$langChoose,$langChosenCode)) .f2('OK');}else if($getElemPass==''){if(isset($_POST['webname'])&& isset($_POST['pass'])&&!empty($_POST['webname'])&&!empty($_POST['pass'])){filewriter(System .Db,'<sitename>' .$_POST['webname'] .'</sitename><pass>' .$_POST['pass'] .'</pass><lang>' .$getElemLang .'</lang><comments>1</comments><listing>10</listing><secret>0</secret><theme>' .MainTheme .'</theme><email>' .$_POST['email'] .'</email>');authSave(file_get_contents(System .Db),$_POST['pass']);}$m='<h1>[[Start]]</h1>' .f1('setpass') .f_elem(f_required(f_text('webname','Website name'))) .f_elem(f_required(f_text('email','Email'))) .f_elem(f_required(f_password('pass','Admin password'))) .f_elem(f_check('remember','keep authorization',1)) .f2('Go');}else{define(Mxt,((($getPerExt=$getElemExt)!='')?$getPerExt:Ext));if(isset($_GET['q'])){if(Mxt!='/'&& strpos($rq,Mxt)!=false && $rq!=''){$rq=str_replace(Mxt,'',$rq);}elseif(Mxt!='/'&& $rq!=''&&!isset($_GET['download'])){$rq=md5($rq);}if(Mxt=='/'&& strrpos($_GET['q'],Mxt)!=(strlen($_GET['q'])-1)&& $rq!=''&&!isset($_GET['download'])){header("HTTP/1.1 301 Moved Permanently");setRedirect($rq);}}if(authKeep($db)>0)define('manage',1);if(isset($_POST['pass']))authSave($db,$_POST['pass']);define('perpage',$getElemListing);define('pager','/:page-');$rqAll=$rq;if(strpos($rq,pager)===false){define('page',1);}else{define('page',substr($rq,strpos($rq,pager)+strlen(pager)));$rq=substr($rq,0,strpos($rq,pager));}$mainPage=str_replace('[lang]',specifyLang(),trim($getElemMainpage));if($rq == 'blog'&& $mainPage==''&& page<2){setRedirect(Siteroot);}if($rq==$mainPage && $mainPage != 'blog'&& $mainPage != ''&&!isset($_POST['commentText'])&& page<2 && count($_POST)<1 && count($_FILES)<1){setRedirect(Siteroot);}if($rq == ''){$rq=($mainPage!='')?$mainPage:'blog';}if($getElemSecret>0)define('secret',1);if($getElemClosed>0)define('closed',1);$mTopics=equalizer($getElemTopics);asort($mTopics);function topicList($env='topicList',$tag='span',$sorting='abc',$parent='',$includeParent=false){global $mTopics;$filter='';if($parent != ''){$filter=$parent;}if($includeParent != false){$filter .= ' filter:include-parent';}if($env == 'topicList tagList'|| $env == 'topicList sideTopicList'|| $env == 'topicList'){$envTag='div';$class=$env;}else{$envTag=$env;$class='myList';}return '<' .$envTag .' class="' .$class .'">' .createMenu($mTopics,'b',($tag=='span'?', ':''),$tag,'topiclist-','tag-',0,$filter) .'</' .$envTag .'>';}$mBlogs=equalizer($getElemBlogs);asort($mBlogs);function blogList($class='blogList',$tag='div'){global $mBlogs,$metas;$blogTerm=$metas['blog']['h1']!=''?$metas['blog']['h1']:'[[Blog]]';$checkBlogs=$mBlogs;foreach($checkBlogs as $k=>$v){if($metas['blog-' .$k]['secret']>0 &&!defined('manage'))unset($checkBlogs[$k]);}return '<div class="' .$class .'">' .createMenu(array('blog'=>$blogTerm),'b','',$tag,'bloglist-') .createMenu($checkBlogs,'b',($tag=='span'?', ':''),$tag,'bloglist-','blog-') .'</div>';}$getAliasedElements=array('blog'=>'[[Blog]]');foreach($mTopics as $k=>$v){$getAliasedElements['tag-' .$k]=$v;}foreach($mBlogs as $k=>$v){$getAliasedElements['blog-' .$k]=$v;}$getAllMeta=xmler($db,'metas');$metas=array();$aliasURLs=array();$aliasedURLs=array();foreach($getAliasedElements as $k=>$v){$getThisMeta=xmler($getAllMeta,$k);$getAliasUrl=xmler($getThisMeta,'url');$metas[$k]=array('url'=> $getAliasUrl,'h1'=> xmler($getThisMeta,'h1'),'intro'=> xmler($getThisMeta,'intr'),'title'=> xmler($getThisMeta,'ttl'),'keywords'=> xmler($getThisMeta,'kw'),'description'=> xmler($getThisMeta,'dsc'),'secret'=> xmler($getThisMeta,'secret'));if($getAliasUrl!=''){$aliasURLs[$getAliasUrl]=$k;$aliasedURLs[$k]=$getAliasUrl;}}define('now',time());$mAll=array();$mAll['posts']=array();$mAll['drafts']=array();$mAllEdit=array();$mAltUrls=array();$menuLinks=array();$sideLinks=array();$favourites=array();$secrets=array();$pseudonyms=array();$codes=array();$mId=1;$types=array('post','draft');$curLang=specifyLang();while(strpos($db,'<post:' .$mId .'>')>-1 || strpos($db,'<draft:' .$mId .'>')>-1){foreach($types as $type){if(strpos($db,'<' .$type .':' .$mId .'>')>-1){$getItem=xmler($db,$type .':' .$mId);$isSecret=xmler($getItem,'p:sec');if($isSecret>0 &&!defined('manage'))continue;if(trim($getItem)=='')continue;$codes[]=xmler($getItem,'p:u');$getDate=xmler($getItem,'p:date');$getTime=xmler($getItem,'p:time');$getNDate=xmler($getItem,'p:ndate');$getNTime=xmler($getItem,'p:ntime');$getMDate=xmler($getItem,'p:mdate');$getMTime=xmler($getItem,'p:mtime');$getLenta=xmler($getItem,'p:lent');if($getLenta!=''&& $getLenta>0 && $metas['blog-' .$getLenta]['secret']>0 &&!defined('manage')){continue;}if($getMDate=='')$getMDate=$getDate;if($getMTime=='')$getMTime=$getTime;if($getElemRaise>0){$getNDate=$getMDate;$getNTime=$getMTime;}$getSortDate=($getNDate!='')?$getNDate:$getDate;$getSortTime=($getNTime!='')?$getNTime:$getTime;list($mkY,$mkM,$mkD)=explode('-',$getSortDate);list($mkH,$mkI,$mkS)=explode(':',$getSortTime);if(strpos($mkH,'0')===0)$mkH=substr($mkH,1);if(strpos($mkI,'0')===0)$mkI=substr($mkI,1);if(strpos($mkS,'0')===0)$mkS=substr($mkS,1);$setMkTime=@mktime($mkH,$mkI,$mkS,$mkM,$mkD,$mkY);list($umkY,$umkM,$umkD)=explode('-',$getMDate);list($umkH,$umkI,$umkS)=explode(':',$getMTime);if(strpos($umkH,'0')===0)$umkH=substr($umkH,1);if(strpos($umkI,'0')===0)$umkI=substr($umkI,1);if(strpos($umkS,'0')===0)$umkS=substr($umkS,1);$setMkTimeUp=@mktime($umkH,$umkI,$umkS,$umkM,$umkD,$umkY);$getH1=xmler($getItem,'p:h1');$getSpecifiedUrl=trimslasher(trim(xmler($getItem,'p:url')));$forceVisibility=xmler($getItem,'p:vovr');$getVisible=(!defined('secret')||(defined('secret')&& defined('manage'))|| $forceVisibility>0)?1:0;if($setMkTime>now &&(!defined('manage')|| $rq=='rss'|| strpos($rq,'rss/')>-1))$getVisible=0;$getPostLang=xmler($getItem,'p:lng');if($getElemMultilang>0 &&($getPostLang!=$curLang && $getPostLang!=''))$getVisible=0;if($getVisible>0)$mAll[$type .'s'][str_replace('-','',$getSortDate) .'-' .str_replace(':','',$getSortTime) .'-' .$mId]=$mAllEdit[$type .'s'][$mId]=array('id'=> $mId,'code'=> xmler($getItem,'p:u'),'draft'=>(($type=='draft')?1:0),'h1'=> $getH1,'text'=> xmler($getItem,'p:txt'),'preface'=> xmler($getItem,'p:pre'),'embeds'=> xmler($getItem,'p:emb'),'alias'=> $getSpecifiedUrl,'alturl'=> xmler($getItem,'p:alturl'),'keywords'=> xmler($getItem,'p:kw'),'description'=> xmler($getItem,'p:dsc'),'title'=> xmler($getItem,'p:ttl'),'tags'=>((xmler($getItem,'p:tag')!='')?explode(',',xmler($getItem,'p:tag')):array()),'files'=>((xmler($getItem,'p:f')!='')?explode(',',xmler($getItem,'p:f')):array()),'secret'=> $isSecret,'faved'=> xmler($getItem,'p:fav'),'commentable'=> xmler($getItem,'p:cm'),'commentableOverride'=> xmler($getItem,'p:cmovr'),'visibleOverride'=> $forceVisibility,'isPage'=> xmler($getItem,'p:page'),'inMenu'=> xmler($getItem,'p:menu'),'inSidebar'=> xmler($getItem,'p:side'),'adult'=> xmler($getItem,'p:adlt'),'date'=> $getDate,'time'=> $getTime,'ndate'=> $getNDate,'ntime'=> $getNTime,'mdate'=> $getMDate,'mtime'=> $getMTime,'microtime'=> $setMkTime,'upmicrotime'=> $setMkTimeUp,'postlang'=> $getPostLang,'lenta'=> $getLenta);if(xmler($getItem,'p:alturl')!=''){$altUrlsArr=explode(',',xmler($getItem,'p:alturl'));foreach($altUrlsArr as $altUrlsItem){$mAltUrls[trim($altUrlsItem)]=($getSpecifiedUrl!='')?$getSpecifiedUrl:$type .'-' .$mId;}}if($getSpecifiedUrl!='')$pseudonyms[$getSpecifiedUrl]=$getH1;if($type == 'post'){$getViewDate=($getNDate!='')?$getNDate:$getDate;$getViewTime=($getNTime!='')?$getNTime:$getTime;list($getYY,$getMM,$getDD)=explode('-',$getViewDate);list($getHH,$getII,$getSS)=explode(':',$getViewTime);if(xmler($getItem,'p:menu')>0 && $getVisible>0)$menuLinks[@mktime($getHH,$getII,$getSS,$getMM,$getDD,$getYY)]=array($mId,xmler($getItem,'p:url'),xmler($getItem,'p:h1'));if(xmler($getItem,'p:side')>0 && $getVisible>0)$sideLinks[@mktime($getHH,$getII,$getSS,$getMM,$getDD,$getYY)]=array($mId,xmler($getItem,'p:url'),xmler($getItem,'p:h1'));if(xmler($getItem,'p:fav')>0 && $getVisible>0)$favourites[]=$mId;if($isSecret>0)$secrets[]=$mId;}}}$mId++;}ksort($mAll['posts']);ksort($mAll['drafts']);ksort($menuLinks);ksort($sideLinks);$mAllStable=$mAll;$rateSummary='';if($getElemRatings>0){$rateSummary=filereader(Ratings);}if($getElemOrder != ''){if($getElemOrder == 'random'){$mAllKeys=array();foreach($mAll['posts']as $k=>$v){$mAllKeys[]=$k;}shuffle($mAllKeys);$mAllPostsTmp=array();foreach($mAllKeys as $v){$mAllPostsTmp[$v]=$mAll['posts'][$v];}$mAll['posts']=$mAllPostsTmp;}else if($getElemOrder == 'abc'|| $getElemOrder == 'cba'){$mAllKeys=array();foreach($mAll['posts']as $k=>$v){$mAllKeys[$k]=$v['h1'];}if($getElemOrder == 'abc'){asort($mAllKeys);}else if($getElemOrder == 'cba'){arsort($mAllKeys);}$mAllPostsTmp=array();foreach($mAllKeys as $k=>$v){$mAllPostsTmp[$k]=$mAll['posts'][$k];}$mAll['posts']=$mAllPostsTmp;}else if($getElemOrder == 'rating'&& $getElemRatings>0){$mAllKeys=array();foreach($mAll['posts']as $k=>$v){$mAllKeys[$k]=xmler($rateSummary,$v['code']);}arsort($mAllKeys);$mAllPostsTmp=array();foreach($mAllKeys as $k=>$v){$mAllPostsTmp[$k]=$mAll['posts'][$k];}$mAll['posts']=$mAllPostsTmp;}else if($getElemOrder != 'frombegin'){$getElemOrder='';}}$mQuery=array();if(!defined('Optimized')&& defined('manage')){$dbSize=round(filesize(System .Db)/1024);if($dbSize>LargeDb){foreach($types as $posttype){foreach($mAllEdit[$posttype .'s']as $item){$dbRecordsText=file_exists(System .DbTexts .$item['code'] .Fxt)?filereader(System .DbTexts .$item['code'] .Fxt):$item['text'];$dbRecordsStr='<r:txt>' .$dbRecordsText .'</r:txt><r:ttl>' .$item['title'] .'</r:ttl><r:pre>' .$item['preface'] .'</r:pre><r:emb>' .$item['embeds'] .'</r:emb><r:kw>' .$item['keywords'] .'</r:kw><r:dsc>' .$item['description'] .'</r:dsc>';filewriter(System .DbRecords .$item['code'] .Fxt,$dbRecordsStr);}}foreach($types as $posttype){foreach($mAllEdit[$posttype .'s']as $item){$db=str_replace(array('<p:txt>' .$item['text'] .'</p:txt>','<p:ttl>' .$item['title'] .'</p:ttl>','<p:pre>' .$item['preface'] .'</p:pre>','<p:emb>' .$item['embeds'] .'</p:emb>','<p:kw>' .$item['keywords'] .'</p:kw>','<p:dsc>' .$item['description'] .'</p:dsc>'),'',$db);}}filewriter(System .Db,$db .'<optimized>1</optimized>');}}$modDays=array('0'=>'');foreach(range(1,31)as $item){$chItem=($item<10)?'0' .$item:$item;$modDays[(string)$chItem]=(string)$chItem;}$modMonths=array('0'=>'');foreach(range(1,12)as $item){$chItem=(strlen($item)<2)?'0' .$item:$item;$modMonths[$chItem]='[[' .$months[$item] .']]';}$modYears=array('0'=>'');foreach(range((@date('Y')-50),(@date('Y')+50))as $item){$modYears[$item]=$item;}$modTimeH=array();foreach(range(0,23)as $item){$chItem=(strlen($item)<2)?'0' .$item:$item;$modTimeH[$chItem]=$chItem;}$modTime=array();foreach(range(0,59)as $item){$chItem=(strlen($item)<2)?'0' .$item:$item;$modTime[$chItem]=$chItem;}function mailPreprocessed($p_email,$p_title,$p_text,$p_from,$encoding='UTF-8'){global $db;$p_title="=?" .$encoding ."?b?" .base64_encode($p_title) ."?=";if(strpos($p_from,'>')>0){list($p_from1,$p_from2)=explode('<',$p_from);$p_from1="=?" .$encoding ."?B?" .base64_encode(trim(str_replace('From:','',$p_from1))) ."?=";$p_from='From: ' .$p_from1 .' <' .$p_from2;$h=$p_from .">\r\n";}else if($p_from == 'noreply@' .str_replace('www.','',$_SERVER['HTTP_HOST'])){$h="From: " ."=?" .$encoding ."?b?" .base64_encode(getElem($db,"sitename")) ."?=" ." <" .$p_from .">\r\n";}else{$h="From: <" .$p_from .">\r\n";}$h .= "Return-Path: <" .$p_from .">\r\n";$h .= "To: " .$p_email ."\r\n";$h .= "Content-type: text/plain; charset=\"" .$encoding ."\"\r\n";$h .= "Content-Transfer-Encoding: 8bit\r\n";$h .= "MIME-Version: 1.0\r\n";$h .= "X-Sender: " .$p_from ."\r\n";$h .= "X-Mailer: " .Engine ." " .EngineVersion ."\r\n";$h .= "User-Agent: " .Engine ." " .EngineVersion ."\r\n";$h .= "X-Priority: 3\r\n";$timezone=@date("Z");$operator=(strncmp($timezone,'-',1)== 0)?'-':'+';$timezone=abs($timezone);$timezone=floor($timezone/3600)*100+($timezone%3600)/60;$h .= "Date: " .sprintf("%s %s%04d",@date("D, j M Y H:i:s"),$operator,$timezone) ."\r\n";$h .= "Message-ID: <" .uniqid('') .strstr($p_from,'@') .">\r\n";return mail($p_email,$p_title,$p_text,$h);}function composeMail($email,$title,$text){return mailPreprocessed($email,$title,$text,'noreply@' .str_replace('www.','',$_SERVER['HTTP_HOST']));}if(file_exists(System .Autoload)){foreach(viewFolder(System .Autoload)as $run){include_once $run;}}function nositemap(){return true;}function updateSitemap(){$db=file_get_contents(System .Db);$mId=1;$xml='';if(defined('secret')|| defined('closed')){@unlink(Sitemap);}else{while(strpos($db,'<post:' .$mId .'>')>-1){$getItem=xmler($db,'post:' .$mId);if(trim($getItem)==''){$mId++;continue;}if(xmler($getItem,'p:sec')>0){$mId++;continue;}$setURL=(($specUrl=trim(xmler($getItem,'p:url')))!='')?$specUrl:'post-' .$mId;$mDate=xmler($getItem,'p:mdate');if($mDate=='')$mDate=xmler($getItem,'p:date');$xml .= '<url>
	<loc>http://' .ThisServer .setURL($setURL) .'</loc>
	<lastmod>' .$mDate .'</lastmod>
	<changefreq>weekly</changefreq>
	<priority>' .((xmler($getItem,'p:page')>0)?'1.0':'0.8') .'</priority>
</url>
';$mId++;}$specials=viewFolder(System .Special,'f');global $getElemMainpage;foreach($specials as $special){$specialread=filereader($special);if($special==Functional || strpos($special,Pagenotfound)>-1 || strpos($specialread,'nositemap')>-1){continue;}else if(basename(str_replace(Fxt,'',$special))== $getElemMainpage){$xml .= '<url>
	<loc>http://' .ThisServer .Siteroot .'</loc>
	<lastmod>' .@date("Y-m-d",filemtime($special)) .'</lastmod>
	<changefreq>weekly</changefreq>
	<priority>1.0</priority>
</url>
';}else if(strpos($special,Fxt)>0){$xml .= '<url>
	<loc>http://' .ThisServer .setURL(basename(str_replace(Fxt,'',$special))) .'</loc>
	<lastmod>' .@date("Y-m-d",filemtime($special)) .'</lastmod>
	<changefreq>weekly</changefreq>
	<priority>0.9</priority>
</url>
';}}if(function_exists('supplementSitemap')){$supplementSitemap=supplementSitemap();if(is_string($supplementSitemap)){$xml .= $supplementSitemap;}else if(is_array($supplementSitemap)){foreach($supplementSitemap as $str){$xml .= $str;}}}filewriter(Sitemap,'<' .'?xml version="1.0" encoding="UTF-8" ?' .'>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
' .$xml .'</urlset>');}}if(defined('manage')&&!defined('LogWritten')&&(strpos(ThisReferer,ThisServer)===false || filereader(Logger)=='')){mLogging();}function generateUniCode($from=3,$to=12,$digits=true){$length=range($from,$to);shuffle($length);$length=$length[0];$base=array('a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z');if($digits===true){$base=array_merge($base,array('1','2','3','4','5','6','7','8','9','0'));}$code='';for($i=0;$i<$length;$i++){shuffle($base);$code .= $base[0];}return $code;}function humanifyDate($d,$l=0,$short=0){global $months;$suff='';if(strpos($d,' ')>0 && $short<1){list($d,$suff)=explode(' ',$d);$suff=' (' .$suff .')';}list($mY,$mM,$mD)=explode('-',$d);return($l>0)?'<a href="' .setURL('date-' .$d) .'">' .(int)$mD .'</a> <a href="' .setURL('date-' .$mY .'-' .$mM) .'">[[' .$months[(int)$mM] .']]</a> <a href="' .setURL('date-' .$mY) .'">' .$mY .'</a>' .$suff:(int)$mD .' [[' .$months[(int)$mM] .']] ' .$mY .$suff;}function loadComments($f,$mPost,$postOrDraft){$commentsData=filereader($f);$commentList='';$c_i=1;while(strpos($commentsData,'</comment:' .$c_i .'>')>0){$commentData=xmler($commentsData,'comment:' .$c_i);if($commentData==''){$c_i++;continue;}else{if(xmler($commentData,'cm:prem')=='1'&&!defined('manage')){$c_i++;continue;}$author=protectDangerTexts(xmler($commentData,'cm:auth'));if(($web=trim(xmler($commentData,'cm:web')))!=''){$author='<!--noindex--><a rel="nofollow" href="' .((strpos(strtolower($web),'http')===false)?'http://':'') .$web .'" target="_blank">' .$author .'</a><!--/noindex-->';}list($cmDate,$cmTime)=explode(' ',xmler($commentData,'cm:date'));$commentList .= '<div class="comment"><span class="comment-author">' .$author .':</span> ' .smile(nl2br(recognizeLinks(protectDangerTexts(f_editorial(xmler($commentData,'cm:txt')),'<b><i><u>')))) .' <small>(' .humanifyDate($cmDate) .' / ' .$cmTime .')</small>' .((xmler($commentData,'cm:prem')=='1'&& defined('manage'))?' <span class="to-moderate">[[— to moderate]]</span>':'') .(((($cmAnswer=xmler($commentData,'cm:answ'))!='')?'<div class="comment-answer">' .smile(nl2br(recognizeLinks($cmAnswer))) .'</div>':'')) .(defined('manage')?'<div class="manage manage-comment delete-comment">' .f1('manageComments' .$c_i,setURL('edit-comments')) .f_hidden('commentId',$c_i) .f_hidden('itemId',$mPost['id']) .f_hidden('itemType',$postOrDraft) .f_hidden('manageComment',1) .f_hidden('cDel',1) .f2('remove') .'</div><div class="manage manage-comment">' .f1('manageComments' .$c_i,setURL('edit-comments')) .f_hidden('commentId',$c_i) .f_hidden('itemId',$mPost['id']) .f_hidden('itemType',$postOrDraft) .f2('edit') .'</div>':'') .'</div>';$c_i++;}}return $commentList;}function reduceText($s,$q=250){if(strlen($s)>$q){$s=substr($s,0,$q);$s=substr($s,0,strrpos($s,' '));return $s .'&hellip;';}return $s;}function searchForm(){return f1('searchForm',setURL('search'),'GET') .f_text('term','',@$_GET['term']) .f2('Find');}function feedbackForm(){global $db,$feedback_fields,$rq;$ms='';$notSend=1;$msgTxt='';$email='';if(!isset($feedback_fields)|| count($feedback_fields)<1)$feedback_fields=array(array('name','text','Nickname / name:','*',''),array('email','text','E-mail:','*',''),array('message','textarea','Message:','*',''));if(isset($_POST)&& count($_POST)>0 && captcha_check()>0){$notSend=0;foreach($feedback_fields as $set){if(is_array($set)){list($name,$type,$label,$obligatory,$provideData)=$set;if($name == 'email')$email=trim($_POST[$name]);if($type=='file'){if($_FILES[$name]['name']!=false){$msgTxt .= "[[" .$label ."]]: http://" .$_SERVER['HTTP_HOST'] .'/' .System .Storage .'feedback-files/' .fileUpload($_FILES[$name],System .Storage .'feedback-files/',1,1) ." \n";}}else{$msgTxt .= "[[" .$label ."]] " .$_POST[$name] ." \n";}if($obligatory!=''&& trim($_POST[$name])==''){$notSend=1;break;}}else{$msgTxt .= strip_tags($set) ." \n";}}}if($notSend == 1){$ms .= f1('feedback',setURL($rq,'','feedback-message-sent'));foreach($feedback_fields as $set){if(is_array($set)){list($name,$type,$label,$obligatory,$provideData)=$set;$function='f_' .$type;if($type=='select'){$mPre=$function($name,'[[' .$label .']]',$provideData,@$_POST[$name]);}else{$mPre=$function($name,'[[' .$label .']]',@$_POST[$name]);}$ms .= f_elem(($obligatory!='')?f_required($mPre):$mPre);}else{$ms .= $set;}}$ms .= f_elem(captcha()) .f2('Send');}else{mailPreprocessed(getElem($db,'email'),translateThis($db,'[[' .(isset($plugMsgTitle)?$plugMsgTitle:'Message from your website') .']]'),translateThis($db,$msgTxt),($email!=''?$email:'noreply@' .str_replace('www.','',$_SERVER['HTTP_HOST'])));$ms .= '<p class="message" id="feedback-message-sent">[[' .(isset($plugMsgAnswer)?$plugMsgAnswer:'Message sent.') .']]</p>';}return $ms;}$prepareJsTranslitters='';foreach($translitters as $k=>$v){$prepareJsTranslitters .= 'transliteration["' .addslashes($k) .'"] = "' .$v .'"; ';}$urlcreator='<script type="text/javascript">createNewUrl = function() { tryH1 = document.getElementById("h1").value; if(tryH1!="") { transliteration = new Array(); ' .$prepareJsTranslitters .' newurl = tryH1.toLowerCase().replace(/ /g, "-"); for(key in transliteration) { while(newurl.indexOf(key)>-1) { newurl = newurl.replace(key, transliteration[key]); } } document.getElementById("url").value = newurl; document.getElementById("newurllink").innerHTML = ""; document.getElementById("h1").onkeyup = function() { document.getElementById("newurllink").innerHTML = "[[change]]"; } } else { document.getElementById("h1").focus(); location.href="#canvas"; } }</script>';if(file_exists(Functional))include_once Functional;if(file_exists(System .Framework .'run' .Fxt))include_once System .Framework .'run' .Fxt;if(file_exists(System .Framework .'routes' .Fxt))include_once System .Framework .'routes' .Fxt;if(!defined('Routed')){$savedrq=$rq;if(isset($aliasedURLs[$rq]))setRedirect($aliasedURLs[$rq]);if(isset($aliasURLs[$rq])){$rq=$aliasURLs[$rq];}if(file_exists(System .$rq)&& strpos($rq,Fxt)===false && isset($_GET['download'])){Header("Content-disposition: attachment; filename=" .basename($f));Header("Content-Type: application/x-force-download; name=\"" .basename($f) ."\"; charset=\"UTF-8\"");$fc=file_get_contents(System .$rq);echo $fc;exit;}if($rq == 'exit'&& defined('manage')){authKill();}else if($rq == enterURL &&!defined('manage')){$m .= '<h1>[[Management]]</h1>' .authForm();}else if($rq == 'remind-password'&&!defined('manage')){$m .= '<h1>[[Remind password]]</h1>';if(isset($_POST['email'])){if(!empty($getElemEmail)&& strtolower(trim($getElemEmail))==strtolower(trim($_POST['email']))){composeMail(trim($getElemEmail),$getElemSitename .translateThis($db,"[[: password reminder]]"),translateThis($db,"[[Your password:]]") .' ' .$getElemPass ." \nhttp://" .ThisServer .setURL(enterURL));$m .= '<p class="message">[[Check your mailbox.]]</p><p><a href="' .setURL(enterURL) .'">[[Management]]</a></p>';}else{setRedirectRef();}}else{$m .= f1('pwd_reminder',setURL('remind-password')) .f_elem(f_text('email','Your email:')) .f2('Remind password');}}else if(($rq == 'remind-password'|| $rq == enterURL)&& defined('manage')){setRedirect();}else if($rq == 'backup'&& defined('manage')){$f=(!isset($_GET['f']))?System .Db:$_GET['f'];ini_set('memory_limit','1024M');ini_set('max_execution_time','0');Header('Accept-Charset: UTF-8');Header("Content-disposition: attachment; filename=" .basename($f));Header("Content-Type: application/x-force-download; name=\"" .basename($f) ."\"; charset=\"UTF-8\"");$fc=file_get_contents($f);if($f == System .Db && defined('Optimized')){foreach($types as $posttype){foreach($mAllEdit[$posttype .'s']as $item){$dbTmpRecord=filereader(System .DbRecords .$item['code'] .Fxt);$fc=upXMLer($fc,array($posttype .':' .$item['id'] .'/p:txt'=>xmler($dbTmpRecord,'r:txt'),$posttype .':' .$item['id'] .'/p:ttl'=>xmler($dbTmpRecord,'r:ttl'),$posttype .':' .$item['id'] .'/p:pre'=>xmler($dbTmpRecord,'r:pre'),$posttype .':' .$item['id'] .'/p:emb'=>xmler($dbTmpRecord,'r:emb'),$posttype .':' .$item['id'] .'/p:kw'=>xmler($dbTmpRecord,'r:kw'),$posttype .':' .$item['id'] .'/p:dsc'=>xmler($dbTmpRecord,'r:dsc')));}}$fc=str_replace('<optimized>1</optimized>','',$fc);$fc=str_replace('<separate>1</separate>','',$fc);}else if($f == System .Db && defined('Separate')){foreach($types as $posttype){foreach($mAllEdit[$posttype .'s']as $item){$fc=upXMLer($fc,array($posttype .':' .$item['id'] .'/p:txt'=>filereader(System .DbTexts .$item['code'] .Fxt)));}}$fc=str_replace('<separate>1</separate>','',$fc);}echo $fc;exit;}else if($rq == 'let-me-see-adult-content'){setCookie("adult",'1',time()+31536000,Siteroot);setRedirectRef();}else if($rq == 'magic-auto-save'){if(isset($_POST['savetext'])&& isset($_POST['savetitle'])&&(!empty($_POST['savetext'])||!empty($_POST['savetitle']))){filewriter(MagicAutoSaver,'<magic-title>' .$_POST['savetitle'] .'</magic-title><magic-text>' .$_POST['savetext'] .'</magic-text>');}}else if($rq == 'upside-down'){if(isset($_COOKIE['chrono'])){setCookie("chrono",'',time()-31536000,Siteroot);}else{setCookie("chrono",'1',time()+31536000,Siteroot);}setRedirectRef();}else if(strpos($rq,'rate/')>-1 &&(strpos($rq,'plus')>0 || strpos($rq,'minus')>0)&& $getElemRatings>0){list($a,$b,$c)=explode('/',$rq);$getRate=xmler($rateSummary,$mAllEdit['posts'][$b]['code'],0);if($getElemPositiveRatings>0 && $getRate<1)$getRate=0;if($c=='plus')$getRate++;else if($c=='minus'&& $getElemPositiveRatings<1)$getRate--;filewriter(Ratings,upXMLer($rateSummary,array($mAllEdit['posts'][$b]['code']=>$getRate)));if(isset($_GET['ajax'])){if($getElemPositiveRatings>0 && $getRate>0)$m .= ' <small id="rating-result-' .$b .'">' .$getRate .'</small>';else if($getElemPositiveRatings<1 && $getRate!=0)$m .= ' <small id="rating-result-' .$b .'">' .$getRate .'</small>';}else{setRedirectRef('p' .$b);}}else if($rq == 'post-ratings'&& defined('manage')){$m .= '<h1>[[Ratings]]</h1>';$ratingList=array();$ratingTopics=array();$postRatingsAmount=0;$postRatingsLimit=isset($_POST['postRatingsQ'])?$_POST['postRatingsQ']:25;foreach($mAll['posts']as $post){$code=$post['code'];$curRating=xmler($rateSummary,$code,0);if(($getElemPositiveRatings<1 && $curRating!=0)||($getElemPositiveRatings>0 && $curRating>0)){$insertImages='';$insertImagesQ=0;$attImages=array();foreach($post['files']as $afile){if($insertImagesQ>=maxPicsAmount)break;$afilel=strtolower($afile);if((strpos($afilel,'.jpg')>0 || strpos($afilel,'.jpeg')>0 || strpos($afilel,'.gif')>0 || strpos($afilel,'.png')>0)){$attImages[]='<span class="attached_image_link attached_images_group_rest"><img src="' .Siteroot .System .Storage .$afile .'" alt="" class="attached_image_img"></span>';}$insertImagesQ++;}$insertImages .=(count($attImages)>0)?join(' ',$attImages) .'<br>':'';$listTopics=array();foreach($post['tags']as $tag){$listTopics[]=$mTopics[$tag];}sort($listTopics);$insertTopics=(count($listTopics)>0)?'<br><i class="parcelle-topics"><small>' .join(', ',$listTopics) .'</small></i>':'';$getDate=$post['date'];$getNDate=$post['ndate'];$getViewDate=($getNDate!='')?$getNDate:$getDate;$key=$insertImages .'<a href="' .setURL($post['alias']!=''?$post['alias']:'post-' .$post['id']) .'"><b>' .($post['h1']!=''?$post['h1']:'***') .'</b></a> <i><small>(' .humanifyDate($getViewDate) .')</small></i>';$ratingList[$key]=$curRating;$ratingTopics[$key]=$insertTopics;}}arsort($ratingList);$m .= f1() .f_radio('postRatingsQ',array('1'=>'1 &nbsp; ','10'=>'10 &nbsp; ','25'=>'25 &nbsp; ','100'=>'100 &nbsp; ','1000000'=>'<big>&infin;</big> &nbsp; '),$postRatingsLimit) .f2('OK') .'<br>';foreach($ratingList as $k=>$v){if($postRatingsAmount>=$postRatingsLimit){break;}$m .= '<p>' .$k .' <span class="ratings"><small>' .$v .'</small></span>' .$ratingTopics[$k] .'</p><br>';$postRatingsAmount++;}}else if($rq == 'editsource'&& isset($_GET['f'])&& defined('manage')){$editsourcepath='redir=' .substr($_GET['f'],0,strrpos($_GET['f'],'/'));if(isset($_POST['src'])){filewriter($_GET['f'],$_POST['src'],'smile','t',1);setRedirect('files',$editsourcepath);}$m .= '<h1>[[Edit]]</h1><h2>' .$_GET['f'] .'</h2>' .f1('editsrcform',setURL('editsource','f=' .$_GET['f'])) .f_elem(f_textarea('src','',str_replace('>','&gt;',str_replace('<','&lt;',filereader($_GET['f']))))) .f_submit('Save') .' <a href="' .setURL('files',$editsourcepath) .'">[[Cancel]]</a>' .f_end();}else if($rq == 'files'&& defined('manage')){$m .= '<h1>[[Files]]</h1>';if(isset($_POST['files_amount'])&& isset($_POST['dirs'])){$getNewFiles=array();for($files_i=1;$files_i<=@$_POST['files_amount'];$files_i++){if(@$_FILES['file' .$files_i]['name']==''||(is_array($_FILES['file' .$files_i]['name'])&& count($_FILES['file' .$files_i]['name'])<1))continue;if(is_array($_FILES['file' .$files_i]['name'])){$getNewFileList=fileUpload($_FILES['file' .$files_i],$_POST['dirs'],0,0);}else{$getNewFile=fileUpload($_FILES['file' .$files_i],$_POST['dirs'],0,0);$getNewFileList=array($getNewFile);}foreach($getNewFileList as $getNewFile){$getNewFiles[]=$getNewFile;}}if(strpos($_POST['dirs'],trimslasher(System .Special))>-1)updateSitemap();}if(isset($_POST['files_to_remove'])){$test='';foreach($_POST['files_to_remove']as $k=>$v){if($v>0)unlink(urldecode($k));$test=$k;}if(strpos(urldecode($test),System .Special)>-1)updateSitemap();}if(isset($_POST['newdirname'])&& trim($_POST['newdirname'])!=''){$newfolder=$_POST['infolder'] .'/' .trim($_POST['newdirname']);filewriter($newfolder .'/tmp.tmp');unlink($newfolder .'/tmp.tmp');}if(isset($_POST['newfilename'])&& trim($_POST['newfilename'])!=''){$newfilecontent=strpos($_POST['newfilename'],Fxt)>0?"<" ."?php\n// PHP code":'';filewriter($_POST['infolder'] .'/' .trim($_POST['newfilename']),$newfilecontent,'','',1);$newfolder=$_POST['infolder'];}if(isset($_POST['deletefolder'])){rmdir($_POST['deletefolder']);setRedirect($rq,'redir=' .$_POST['infolder']);}$inDir=(isset($_POST['dirs'])&&!empty($_POST['dirs']))?$_POST['dirs']:'.';if(isset($newfolder))$inDir=$newfolder;if(isset($_GET['redir'])&&!empty($_GET['redir']))$inDir=trimslasher($_GET['redir']);$getDir1=array();if($inDir!='.')$getDir1['.']='<b>[[Root directory]]</b>';if($inDir!='.'&& strpos($inDir,'/')>0)$getDir1[substr($inDir,0,strrpos($inDir,'/'))]='<b>[[One level up]]</b>';$getDir2=array_merge(array($inDir=>str_replace('.','',$inDir)),viewFolder($inDir,'d'));$getDir=array_merge($getDir1,$getDir2);$m .= '<h2>' .($inDir=='.'?'[[Choose directory:]]':Siteroot .$inDir .'/') .'</h2><table class="mTable">';foreach($getDir as $a=>$b){if($a!=$inDir)$m .= '<tr class="tr"><td>' .$b .'</td><td>' .f1('chooseDir',setURL('files')) .f_hidden('dirs',$a) .f2('Open') .'</td><td>' .((count(viewFolder($a,'f'))<1 && count(viewFolder($a,'d'))<1)?f1('chooseDir',setURL('files')) .f_hidden('deletefolder',$a) .f_hidden('infolder',$inDir) .f2('Remove'):'') .'</td></tr>';}$m .= '<tr class="tr"><td colspan="3"><a href="" onclick="onclick=document.getElementById(\'opencreating\').style.display=\'block\'; this.parentNode.parentNode.style.display=\'none\'; return false;"><small>[[Create new folder]]</small></a> | <a href="" onclick="onclick=document.getElementById(\'opencreatingfile\').style.display=\'block\'; this.parentNode.parentNode.style.display=\'none\'; return false;"><small>[[Create new file]]</small></a></td></tr>';$m .= '</table>';$m .= '<div id="opencreating" style="display:none;">' .f1('newDir',setURL('files')) .f_text('newdirname') .f_hidden('infolder',$inDir) .f2('Create new folder') .'<br></div>';$m .= '<div id="opencreatingfile" style="display:none;">' .f1('newDir',setURL('files')) .f_text('newfilename',array('','new-file' .Fxt)) .f_hidden('infolder',$inDir) .f2('Create new file') .'<br></div>';$getFilesInDir=viewFolder($inDir,'f');$fileFormats=array();if(count($getFilesInDir)>0){$m .= '<h2>' .(($inDir=='.')?'[[Root directory]]':'[[Files]]') .':</h2><style type="text/css">table.mTable div.imgPreview{width:20px;height:20px;overflow:hidden;}</style>' .f1('rmFiles',setURL('files')) .f_hidden('dirs',$inDir) .'<table class="mTable">';foreach($getFilesInDir as $file){$fileFormat=substr($file,strrpos($file,'.')+1);$fileNameBase=str_replace('.' .$fileFormat,'',basename($file));$shortFilename=(strlen($fileNameBase)>45)?substr($fileNameBase,0,40) .'&hellip;.' .$fileFormat:basename($file);if($file == System .Db){$dwnlFile='<a href="' .setURL('backup') .'">' .Db .'</a>';}else if(strpos($file,Fxt)===false && strpos($file,Protector)===false){$dwnlFile='<a href="' .Siteroot .$file .'" target="_blank">' .urldecode($shortFilename) .'</a>';}else{$dwnlFile=urldecode($shortFilename);}$fileFormatUp=strtoupper($fileFormat);if(!isset($fileFormats[$fileFormatUp]))$fileFormats[$fileFormatUp]=array();$fileLower=strtolower(basename($file));$filePreview='';if((strpos($fileLower,'.jpg')>-1 || strpos($fileLower,'.jpeg')>-1 || strpos($fileLower,'.png')>-1 || strpos($fileLower,'.gif')>-1)&&(strpos($fileLower,'.zip')===false && strpos($fileLower,'.rar')===false)){$filesize=getimagesize($file);$filePreview='<div class="imgPreview"><img src="' .Siteroot .$file .'"' .((int)$filesize[1]>35?' height="35"':'') .'></div>';}$fileFormats[$fileFormatUp][]='<tr class="tr"><td>' .$filePreview .'</td><td>' .$dwnlFile .'</td><td><small>&asymp; <a href="' .setURL('backup','f=' .$file) .'">' .ceil(filesize($file)/1024) .' [[kB]]</a></small></td><td>' .(($file!='index' .Fxt)?f_check('files_to_remove[' .urlencode($file) .']','',0):'') .(((strpos($file,Fxt)>0&&$file!='index' .Fxt)||strpos($file,'.js')>0||strpos($file,'.css')>0||strpos($file,'.txt')>0||strpos($file,'.htm')>0||$file==Protector)?'</td><td>' .'<a href="' .setURL('editsource','f=' .$file) .'">[[edit]]</a>':'') .'</td></tr>';}ksort($fileFormats);foreach($fileFormats as $k=>$v){if(count($fileFormats)>1 && $inDir!='.')$m .= '<tr><td></td><td colspan="3"><h3>' .$k .'</h3></td><tr>';foreach($v as $f)$m .= $f;}$m .= '<tr><td colspan="2"></td><td colspan="2">' .f_submit('Remove') .'</td><td></td><tr></table></form>';}else $m .= f_elem();$m .= '<h2>[[Upload:]]</h2>';$m .= f1('rmFiles',setURL('files')) .f_hidden('dirs',$inDir) .f_files('file',1) .f2('Upload');}else if(strpos($rq,'select-language/')>-1){list($a,$b)=explode('/',$rq);if(in_array($b,$getElemLangs)){setCookie("lang",$b,time()+31536000,Siteroot);setRedirectRef();}else setRedirectRef();}else if($rq == 'preferences'&& defined('manage')){if(isset($_GET['updated']))updateSitemap();if(isset($_POST['webname'])&& isset($_POST['newpass'])&&!empty($_POST['webname'])&&!empty($_POST['newpass'])){$currentPass=$getElemPass;$setLangs=array();foreach($_POST['langs']as $langs_k=>$langs_v){if($langs_v>0)$setLangs[]=$langs_k;}if($_POST['noautosaving']>0){@unlink(MagicAutoSaver);}filewriter(System .Db,upXMLer($db,array('sitename'=>$_POST['webname'],'motto'=>$_POST['motto'],'pass'=>$_POST['newpass'],'lang'=>$_POST['lang'],'theme'=>$_POST['theme'],'comments'=>$_POST['comments'],'premoderate'=>$_POST['premoderate'],'email'=>$_POST['email'],'paginate'=>$_POST['paginate'],'listing'=>$_POST['listing'],'cutting'=>$_POST['cutting'],'secret'=>$_POST['secret'],'closed'=>$_POST['closed'],'hideblog'=>$_POST['hidebloglink'],'hidemanagement'=>$_POST['hidemanagementlink'],'hiderss'=>$_POST['hidersslink'],'hidesearch'=>$_POST['hidesearchlink'],'hidefiles'=>$_POST['hidefileslink'],'hidefav'=>@$_POST['hidefavlink'],'hidesecret'=>@$_POST['hidesecretlink'],'hidedrafts'=>@$_POST['hidedraftslink'],'hidecomments'=>@$_POST['hidecommentslink'],'hideratings'=>@$_POST['hideratingslink'],'keywords'=>$_POST['keywords'],'description'=>$_POST['description'],'mainpage'=>$_POST['mainpage'],'ext'=>trim($_POST['ext']),'nobackups'=>$_POST['nobackups'],'noautosaving'=>$_POST['noautosaving'],'norte'=>$_POST['norte'],'social'=>$_POST['social'],'raise'=>$_POST['raise'],'ratings'=>$_POST['ratings'],'positiveratings'=>$_POST['positiveratings'],'multilang'=>$_POST['multilang'],'langs'=>join(',',$setLangs),'sidebar/searchon'=>$_POST['sideSearch'],'sidebar/topicson'=>$_POST['sideTopics'],'sidebar/blogson'=>$_POST['sideBlogs'],'order'=>$_POST['order'])));if($_POST['nobackups']<1){createBackup(true);}innerCallback();if($currentPass!=$_POST['newpass']){authKill();}else{if(isset($_GET['q'])){Header('Location:' .Siteroot .'preferences' .trim($_POST['ext']) .'?updated');}else{Header('Location:' .Siteroot .'?preferences&updated');}exit;}}$setThemes=array();$getThemes=viewFolder(System .Themes,'d');foreach($getThemes as $getThemeKey){$normalizeName=substr($getThemeKey,strrpos($getThemeKey,'/')+1);if($normalizeName=='common')continue;$setThemes[$normalizeName]=ucwords(str_replace(array('-','_'),array(' ',' '),$normalizeName));}ksort($setThemes);$langChoose=array('en'=>'English');$langsSwitcherPrefs='<div id="langsSwitcherPrefs" class="setItems"><label>[[Language switchers:]]</label><span class="currentItem">' .f_check('langs[en]','English',(in_array('en',$getElemLangs)?1:0)) .'</span>';foreach(viewFolder(System .Langs,'f')as $lngFileRead){$getLngFileContent=equalizer(filereader($lngFileRead));$langAbbr=str_replace(Fxt,'',basename($lngFileRead));$langChoose[$langAbbr]=$getLngFileContent['lang'];$langsSwitcherPrefs .= '<span class="currentItem">' .f_check('langs[' .$langAbbr .']',$getLngFileContent['lang'],(in_array($langAbbr,$getElemLangs)?1:0)) .'</span> ';}asort($langChoose);$langsSwitcherPrefs .= '</div>';$orderChoose=array(''=>'[[usual]]','frombegin'=>'[[from beginning]]','random'=>'[[random]]','abc'=>'[[alphabetical]]','cba'=>'[[anti-alphabetical]]','rating'=>'[[by rating]]');$paginationChoose=array(''=>'[[under the posts]]','double'=>'[[over and under the posts]]','concise'=>'[[concise]]','none'=>'[[none]]');$m .= '<h1>[[Preferences]]</h1>' .f1('setPrefs',setURL('preferences')) .f_elem(f_required(f_text('webname','Website name:',$getElemSitename))) .f_elem(f_text('motto','Motto:',$getElemMotto)) .f_elem(f_required(f_password('newpass','Admin password:',$getElemPass))) .f_elem(f_check('comments','allow comments',$getElemComments)) .f_elem(f_check('premoderate','premoderate comments',$getElemPremoderateComments)) .f_elem(f_text('email','Send notifications to the following email:',$getElemEmail)) .f_elem(f_check('ratings','post ratings',$getElemRatings)) .f_elem(f_check('positiveratings','only positive ratings',$getElemPositiveRatings)) .f_elem(f_select('paginate','Pagination:',$paginationChoose,$getElemPaginate)) .f_elem(f_text('listing','Posts per page:',$getElemListing)) .f_elem(f_text('cutting','Cut posts after (characters):',$getElemCutting)) .f_elem(f_select('theme','Design theme:',$setThemes,$getElemTheme)) .f_elem(f_checkbox('sideSearch','search in sidebar',xmler($db,'sidebar/searchon'))) .f_elem(f_checkbox('sideBlogs','blogs in sidebar',xmler($db,'sidebar/blogson'))) .f_elem(f_checkbox('sideTopics','topics in sidebar',xmler($db,'sidebar/topicson'))) .f_elem(f_check('hidebloglink','hide Blog link',$getElemHideblog)) .f_elem(f_check('hidemanagementlink','hide Management link',$getElemHidemanagement)) .f_elem(f_check('hidersslink','hide RSS link',$getElemHiderss)) .f_elem(f_check('hidesearchlink','hide Search link',$getElemHidesearch)) .f_elem(f_check('hidefileslink','hide Files link',$getElemHidefiles)) .(count($favourites)>0?f_elem(f_check('hidefavlink','hide Favourite link',$getElemHidefav)):'') .(count($secrets)>0?f_elem(f_check('hidesecretlink','hide Secret posts link',$getElemHidesecret)):'') .(count($mAll['drafts'])>0?f_elem(f_check('hidedraftslink','hide Drafts link',$getElemHidedrafts)):'') .($getElemComments>0 && file_exists(System .Comments)?f_elem(f_check('hidecommentslink','hide Comments link',$getElemHidecomments)):'') .($getElemRatings>0 && file_exists(Ratings)?f_elem(f_check('hideratingslink','hide Ratings link',$getElemHideratings)):'') .f_elem(f_text('keywords','SEO keywords:',$getElemKeywords)) .f_elem(f_text('description','SEO description:',$getElemDescription)) .f_elem(f_check('secret','secret blog',$getElemSecret)) .f_elem(f_check('closed','closed website',$getElemClosed)) .f_elem(f_text('mainpage','Alternative main page:',$getElemMainpage)) .f_elem(f_text('ext','Page suffix (e.g. .html):',Mxt)) .f_elem(f_check('nobackups','do not save backups',$getElemNoBackups)) .f_elem(f_check('noautosaving','do not use auto-saving',$getElemNoAutoSaving)) .f_elem(f_check('norte','do not use rich text editor',$getElemNoRTE)) .f_elem(f_check('social','use social buttons',$getElemSocial)) .f_elem(f_select('order','Record order:',$orderChoose,$getElemOrder)) .f_elem(f_check('raise','raise updated posts',$getElemRaise)) .f_elem(f_select('lang','Interface language:',$langChoose,$getElemLang)) .f_elem(f_check('multilang','display only content in the selected language',$getElemMultilang)) .f_elem($langsSwitcherPrefs) .f2() .'<br><p><a href="' .setURL('reset-preferences') .'" onClick="if(confirm(\'[[Confirm, please!]]\')) return true; else return false;">[[Reset the preferences]]</a></p>';}else if($rq == 'reset-preferences'&& defined('manage')){filewriter(System .Db,upXMLer($db,array('motto'=>'','lang'=>'en','theme'=>MainTheme,'comments'=>1,'premoderate'=>0,'listing'=>10,'secret'=>0,'closed'=>0,'hideblog'=>0,'hidemanagement'=>0,'hiderss'=>0,'hidesearch'=>0,'hidefiles'=>0,'hidefav'=>0,'hidesecret'=>0,'hidedrafts'=>0,'hidecomments'=>0,'hideratings'=>0,'keywords'=>'','description'=>'','mainpage'=>'','ext'=>Ext,'norte'=>0,'social'=>0,'raise'=>0,'ratings'=>0,'positiveratings'=>0,'order'=>'','multilang'=>0,'langs'=>'','sidebar/searchon'=>0,'sidebar/topicson'=>0,'sidebar/blogson'=>0)));createBackup();innerCallback();setCookie("chrono",'',time()-31536000,Siteroot);setCookie("adult",'',time()-31536000,Siteroot);setCookie("lang",'',time()-31536000,Siteroot);if(isset($_GET['q'])){Header('Location:' .Siteroot .'preferences' .Ext);exit;}else{Header('Location:' .Siteroot .'?preferences');exit;}}else if($rq == 'comments'&& defined('manage')){$m .= '<h1>[[Comments]]</h1>';$cme_i=1;foreach(viewFolder(System .Comments,'f','updated')as $commentFile){if($cme_i>10)break;foreach($mAll['posts']as $mItem){if($mItem['code']==str_replace(Fxt,'',basename($commentFile))){$mItemSelect=$mItem;break;}}$lc=loadComments($commentFile,$mItemSelect,'post');if($lc!='')$m .= '<div class="comments"><h2><a href="' .setURL((($specUrl=trim($mItemSelect['alias']))!='')?$specUrl:'post-' .$mItemSelect['id']) .'#comments">' .$mItemSelect['h1'] .'</a></h2>' .$lc .'</div>';$cme_i++;}}else if($rq == uploadRef && defined('manage')){if(isset($_FILES['file']['tmp_name'])){$getNewFile=fileUpload($_FILES['file'],System .Storage,1,1);convertImages(System .Storage,$getNewFile,'',imgMaxW,imgMaxH);echo '<a href="' .Siteroot .System .Storage .$getNewFile .'" target="_blank" class="attached_image_link"><img src="' .Siteroot .System .Storage .$getNewFile .'" alt="" class="attached_image_img"></a>';}exit;}else if($rq == 'new'&& defined('manage')){if(@$_POST['create']=='OK'){$type=(@$_POST['draft']>0)?'draft':'post';$freeId=1;while(strpos($db,'<' .$type .':' .$freeId .'>')>-1){$freeId++;}$getNewFiles=array();for($files_i=1;$files_i<=@$_POST['files_amount'];$files_i++){if(@$_FILES['file' .$files_i]['name']==''||(is_array($_FILES['file' .$files_i]['name'])&& count($_FILES['file' .$files_i]['name'])<1))continue;if(is_array($_FILES['file' .$files_i]['name'])){$getNewFileList=fileUpload($_FILES['file' .$files_i],System .Storage,1,1,true);}else{$getNewFile=fileUpload($_FILES['file' .$files_i],System .Storage,1,1,true);$getNewFileList=array($getNewFile);}foreach($getNewFileList as $getNewFile){if((strpos(strtolower($getNewFile),'.jpg')>-1 || strpos(strtolower($getNewFile),'.jpeg')>-1 || strpos(strtolower($getNewFile),'.png')>-1 || strpos(strtolower($getNewFile),'.gif')>-1)&& strpos(strtolower($getNewFile),'.zip')===false && strpos(strtolower($getNewFile),'.rar')===false){$imgParam=getimagesize(System .Storage .$getNewFile);if(strpos($imgParam['mime'],'png')>0 || strpos($imgParam['mime'],'gif')>0 || strpos($imgParam['mime'],'jpeg')>0){filewriter(System .Storage .'large/' .$getNewFile,filereader(System .Storage .$getNewFile),'','b');convertImages(System .Storage,$getNewFile,'',imgMaxW,imgMaxH);}}$getNewFiles[]=$getNewFile;}}$topicAttr=array();foreach($_POST['currentTopic']as $existing_topic_k=>$existing_topic_v){if($existing_topic_v>0){$topicAttr[]=$existing_topic_k;}}$addTopiсs='';if(!empty($_POST['newtags'])){$startNumNewTopics=count($mTopics);$flippedTopics=array_flip($mTopics);foreach(explode(',',$_POST['newtags'])as $newTopic){if(in_array(trim($newTopic),$mTopics)){$topicAttr[]=$flippedTopics[trim($newTopic)];}else{$startNumNewTopics++;$topicAttr[]=$startNumNewTopics;$addTopiсs .= "\n" .$startNumNewTopics ." = " .trim($newTopic);}}}$addBlogStr='';$lenta=$_POST['lenta'];$getLenta='';if($lenta=='add'&& $_POST['newblog']!=''){$newblog=trim($_POST['newblog']);if(in_array($newblog,$mBlogs)){$mBlogsTmp=array_flip($mBlogs);$getLenta=$mBlogsTmp[$newblog];}else{$getLenta=count($mBlogs)+1;$addBlogStr="\n" .$getLenta ." = " .$newblog;}}else if($lenta>0){$getLenta=$lenta;}$newCode=generateUniCode();while(in_array($newCode,$codes)){$newCode=generateUniCode();}$setPostUrl=str_replace(array(' ','+','%'),array('-','_','_'),trim(@$_POST['url']));if((strpos($db,'<p:url>' .$setPostUrl .'</p:url>')>0 || strpos($db,'<url>' .$setPostUrl .'</url>')>0)&& $setPostUrl!=''){$setPostUrlIndex=1;$setPostUrlSaved=$setPostUrl;$setPostUrl=$setPostUrl .'-1';while(strpos($db,'<p:url>' .$setPostUrl .'</p:url>')>0 || strpos($db,'<url>' .$setPostUrl .'</url>')>0){$setPostUrlIndex++;$setPostUrl=$setPostUrlSaved .'-' .$setPostUrlIndex;}}if(defined('Optimized')){$dbRecordsStr='<r:txt>' .@$_POST['text'] .'</r:txt><r:ttl>' .@$_POST['title'] .'</r:ttl><r:pre>' .@$_POST['preface'] .'</r:pre><r:emb>' .@$_POST['embeds'] .'</r:emb><r:kw>' .@$_POST['keywords'] .'</r:kw><r:dsc>' .@$_POST['description'] .'</r:dsc>';filewriter(System .DbRecords .$newCode .Fxt,$dbRecordsStr);$_POST['text']='';$_POST['title']='';$_POST['preface']='';$_POST['embeds']='';$_POST['keywords']='';$_POST['description']='';}else if(defined('Separate')){filewriter(System .DbTexts .$newCode .Fxt,@$_POST['text']);$_POST['text']='';}$postElements=array('u'=> $newCode,'h1'=>@$_POST['h1'],'txt'=>@$_POST['text'],'tag'=> join(',',array_unique($topicAttr)),'f'=> join(',',$getNewFiles),'url'=> $setPostUrl,'alturl'=>@$_POST['alturl'],'sec'=>@$_POST['secret'],'fav'=>@$_POST['faved'],'cm'=>@$_POST['comments'],'ttl'=>@$_POST['title'],'kw'=>@$_POST['keywords'],'dsc'=>@$_POST['description'],'page'=>@$_POST['page'],'menu'=>@$_POST['inmenu'],'side'=>@$_POST['insidebar'],'adlt'=>@$_POST['adult'],'pre'=>@$_POST['preface'],'emb'=>@$_POST['embeds'],'lng'=>@$_POST['postlang'],'date'=>@date("Y-m-d"),'time'=>@date("H:i:s"),'lent'=> $getLenta);if(isset($_POST['commentsOverride']))$postElements['cmovr']=$_POST['commentsOverride'];if(isset($_POST['visibleOverride']))$postElements['vovr']=$_POST['visibleOverride'];if($_POST['special_date_day']!=0 && $_POST['special_date_month']!=0 && $_POST['special_date_year']!=0){$postElements['ndate']=$_POST['special_date_year'] .'-' .$_POST['special_date_month'] .'-' .$_POST['special_date_day'];$postElements['ntime']=$_POST['special_date_hour'] .':' .$_POST['special_date_minute'] .':' .$_POST['special_date_second'];}else{$postElements['ndate']='';$postElements['ntime']='';}$post='';foreach($postElements as $k=>$v){if($v!=''&& $v!='0'&& $v!='<br>')$post .= '<p:' .$k .'>' .$v .'</p:' .$k .'>';}$recordSet=array($type .':' .$freeId=>$post,'topics'=>$getElemTopics .$addTopiсs,'blogs'=>$getElemBlogs .$addBlogStr);if($_POST['is_mainpage']>0){$urlOrAlias=($setPostUrl != '')?$setPostUrl:'post-' .$freeId;$recordSet['mainpage']=$urlOrAlias;}filewriter(System .Db,upXMLer($db,$recordSet));createBackup();innerCallback();updateSitemap();@unlink(MagicAutoSaver);if($getElemMultilang>0 && isset($_POST['postlang'])&& $_POST['postlang']!='')setCookie("lang",$_POST['postlang'],time()+31536000,Siteroot);if(@$_POST['page']>0 ||($_POST['special_date_day']!=0 && $_POST['special_date_month']!=0 && $_POST['special_date_year']!=0)){if(@$_POST['url']!='')setRedirect($setPostUrl);else setRedirect($type .'-' .$freeId);}else{if(@$_POST['draft']>0)setRedirect('drafts');else if($getLenta!='')setRedirect('blog-' .$getLenta);else if($mainPage!=''&& $mainPage!='blog')setRedirect('blog');else setRedirect(Siteroot);}}$currentTopics=array();foreach($mTopics as $mTopicId=>$mTopicTitle){$currentTopics[]='<span class="currentItem">' .f_check('currentTopic[' .$mTopicId .']',$mTopicTitle) .'</span> ';}$langChoose=array(''=>'','en'=>'English');foreach(viewFolder(System .Langs,'f')as $lngFileRead){$getLngFileContent=equalizer(filereader($lngFileRead));$langAbbr=str_replace(Fxt,'',basename($lngFileRead));$langChoose[$langAbbr]=$getLngFileContent['lang'];}$lentaChoose=array(''=>'[[main blog]]');foreach($mBlogs as $mBlogsItemK=>$mBlogsItemV){$lentaChoose[$mBlogsItemK]=$mBlogsItemV;}$lentaChoose['add']='[[add a blog]]';$m .= $urlcreator;$autoDraft=filereader(MagicAutoSaver);$m .= '<h1>[[New post]]</h1>' .($getElemNoAutoSaving>0?'':'<script type="text/javascript">magicAutoSaveURL="' .setURL('magic-auto-save') .'";</script>') .f1('new',setURL('new')) .f_hidden('create','OK') .f_elem(f_text('h1','Title:',xmler($autoDraft,'magic-title'))) .'<script type="text/javascript">document.getElementById("h1").ondblclick=function(){if(document.getElementById("h1").value==false)document.getElementById("h1").value="' .humanifyDate(@@date('Y-m-j')) .'";}</script>' .f_elem(f_textarea('text','Post text:',xmler($autoDraft,'magic-text'))) .f_files('file',1) .f_elem(f_text('newtags','Add new topic (or few comma divided):')) .((count($mTopics)>0)?f_elem('<label>[[or choose from saved ones:]]</label><div class="setItems">' .join('',$currentTopics) .'</div>'):'') .f_elem(f_text('url','[[Base part of post URL address:]] <a href="" onclick="createNewUrl(); return false;" id="newurllink">[[create]]</a>',(isset($_GET['url'])?trim($_GET['url']):''))) .f_elem(f_check('page','use as page not in the blog')) .f_elem(f_select('postlang','Post language:',$langChoose)) .f_elem(f_select('lenta','Publish in',$lentaChoose)) .'<div id="addblogblock" style="display:none;">' .f_elem(f_text('newblog',array('','New blog title'))) .'</div><script type="text/javascript">document.getElementById("lenta").onchange=function(){document.getElementById("addblogblock").style.display = ( document.getElementById("lenta").value=="add" ) ? "block":"none";}</script>' .'<p id="showmore"><a href="" onclick="document.getElementById(\'options\').style.display=\'block\'; document.getElementById(\'showmore\').style.display=\'none\'; return false;"><small>[[Show additional options]]</small></a></p><div id="options" style="display:none;">' .f_elem(f_check('secret','secret post')) .f_elem(f_check('faved','in favourites')) .f_elem(f_check('is_mainpage','make main page')) .($getElemComments>0?f_elem(f_check('comments','allow comments',1)):f_hidden('comments',1) .f_elem(f_check('commentsOverride','allow comments for this entry',0))) .($getElemSecret>0?f_elem(f_check('visibleOverride','make this entry visible for everyone')):'') .f_elem(f_text('title','Alternate text for TITLE tag:')) .f_elem(f_text('keywords','SEO keywords:')) .f_elem(f_text('description','SEO description:')) .f_elem(f_check('draft','store in drafts')) .f_elem(f_check('inmenu','link in the top menu')) .f_elem(f_check('insidebar','link in the sidebar')) .f_elem(f_check('adult','18+')) .f_elem(f_textarea('preface','Post intro to be displayed in the blog instead of the text:')) .f_elem(f_textarea('embeds','Place Youtube / Google Maps / audio code here:',$select['embeds'])) .f_elem_set('Change publication date',array(f_select('special_date_day','',$modDays),f_select('special_date_month','',$modMonths),f_select('special_date_year','',$modYears,@date('Y')),' &nbsp; ',f_select('special_date_hour','',$modTimeH),f_select('special_date_minute','',$modTime),f_select('special_date_second','',$modTime))) .f_elem(f_text('alturl','Alternative URL (or few comma divided):',$select['alturl'])) .'<p id="showless"><a href="" onclick="document.getElementById(\'options\').style.display=\'none\'; document.getElementById(\'showmore\').style.display=\'block\'; return false;"><small>[[Hide additional options]]</small></a></p></div>' .f2('Done');}else if($rq == 'edit'&& isset($_POST['itemId'])&& isset($_POST['itemType'])&& defined('manage')){$type=$_POST['itemType'];$id=$_POST['itemId'];$select=$mAllEdit[$type .'s'][$id];if(@$_POST['erase']=='OK'){$redirAfterErasing=($select['isPage']>0)?$mainPage:'blog';@unlink(System .Comments .$select['code'] .Fxt);@unlink(System .DbTexts .$select['code'] .Fxt);filewriter(System .Db,upXMLer($db,array($type .':' .$id=>'')));createBackup();innerCallback();updateSitemap();setRedirect($redirAfterErasing);}else if(@$_POST['update']=='OK'){$newType=(@$_POST['draft']>0)?'draft':'post';if($newType!=$type){$newId=1;while(strpos($db,'<' .$newType .':' .$newId .'>')>-1){$newId++;}}else{$newId=$id;}$getNewFiles=array();if(!empty($_POST['existingfiles'])){foreach($_POST['existingfiles']as $existing_file_k=>$existing_file_v){if($existing_file_v<1){@unlink(System .Storage .$existing_file_k);@unlink(System .Storage .'large/' .$existing_file_k);}else{$getNewFiles[]=$existing_file_k;}}}for($files_i=1;$files_i<=@$_POST['files_amount'];$files_i++){if(@$_FILES['file' .$files_i]['name']==''||(is_array($_FILES['file' .$files_i]['name'])&& count($_FILES['file' .$files_i]['name'])<1))continue;if(is_array($_FILES['file' .$files_i]['name'])){$getNewFileList=fileUpload($_FILES['file' .$files_i],System .Storage,1,1,true);}else{$getNewFile=fileUpload($_FILES['file' .$files_i],System .Storage,1,1,true);$getNewFileList=array($getNewFile);}foreach($getNewFileList as $getNewFile){if((strpos(strtolower($getNewFile),'.jpg')>-1 || strpos(strtolower($getNewFile),'.jpeg')>-1 || strpos(strtolower($getNewFile),'.png')>-1 || strpos(strtolower($getNewFile),'.gif')>-1)&& strpos(strtolower($getNewFile),'.zip')===false && strpos(strtolower($getNewFile),'.rar')===false){$imgParam=getimagesize(System .Storage .$getNewFile);if(strpos($imgParam['mime'],'png')>0 || strpos($imgParam['mime'],'gif')>0 || strpos($imgParam['mime'],'jpeg')>0){filewriter(System .Storage .'large/' .$getNewFile,filereader(System .Storage .$getNewFile),'','b');convertImages(System .Storage,$getNewFile,'',imgMaxW,imgMaxH);}}$getNewFiles[]=$getNewFile;}}$topicAttr=array();foreach($_POST['currentTopic']as $existing_topic_k=>$existing_topic_v){if($existing_topic_v>0){$topicAttr[]=$existing_topic_k;}}$editedTopics='';if(isset($_POST['currentTopicsToEdit'])){foreach($_POST['currentTopicsToEdit']as $edited_topic_k=>$edited_topic_v){$editedTopics .= "\n" .$edited_topic_k ." = " .((trim($edited_topic_v)=='')?$mTopics[$edited_topic_k]:trim($edited_topic_v));}}else{$editedTopics=$getElemTopics;}$addTopiсs='';if(!empty($_POST['newtags'])){$startNumNewTopics=count($mTopics);$flippedTopics=array_flip($mTopics);foreach(explode(',',$_POST['newtags'])as $newTopic){if(in_array(trim($newTopic),$mTopics)){$topicAttr[]=$flippedTopics[trim($newTopic)];}else{$startNumNewTopics++;$topicAttr[]=$startNumNewTopics;$addTopiсs .= "\n" .$startNumNewTopics ." = " .trim($newTopic);}}}$addBlogStr='';$lenta=$_POST['lenta'];$getLenta='';if($lenta=='add'&& $_POST['newblog']!=''){$newblog=trim($_POST['newblog']);if(in_array($newblog,$mBlogs)){$mBlogsTmp=array_flip($mBlogs);$getLenta=$mBlogsTmp[$newblog];}else{$getLenta=count($mBlogs)+1;$addBlogStr="\n" .$getLenta ." = " .$newblog;}}else if($lenta>0){$getLenta=$lenta;}$setPostUrl=trim(@$_POST['url']);if($setPostUrl!=''){$setPostUrl=str_replace(array(' ','+','%'),array('-','_','_'),$setPostUrl);if((strpos($db,'<p:url>' .$setPostUrl .'</p:url>')>0 && $setPostUrl!=''&& $setPostUrl!=$mAllEdit[$type .'s'][$id]['alias'])|| strpos($db,'<url>' .$setPostUrl .'</url>')>0){$setPostUrlIndex=1;$setPostUrlSaved=$setPostUrl;$setPostUrl=$setPostUrl .'-1';while(strpos($db,'<p:url>' .$setPostUrl .'</p:url>')>0 || strpos($db,'<url>' .$setPostUrl .'</url>')>0){$setPostUrlIndex++;$setPostUrl=$setPostUrlSaved .'-' .$setPostUrlIndex;}}}if(defined('Optimized')){$dbRecordsStr='<r:txt>' .@$_POST['text'] .'</r:txt><r:ttl>' .@$_POST['title'] .'</r:ttl><r:pre>' .@$_POST['preface'] .'</r:pre><r:emb>' .@$_POST['embeds'] .'</r:emb><r:kw>' .@$_POST['keywords'] .'</r:kw><r:dsc>' .@$_POST['description'] .'</r:dsc>';filewriter(System .DbRecords .$select['code'] .Fxt,$dbRecordsStr);$_POST['text']='';$_POST['title']='';$_POST['preface']='';$_POST['embeds']='';$_POST['keywords']='';$_POST['description']='';}else if(defined('Separate')){filewriter(System .DbTexts .$select['code'] .Fxt,@$_POST['text']);$_POST['text']='';}$postElements=array('u'=>@$_POST['code'],'h1'=>@$_POST['h1'],'txt'=>@$_POST['text'],'date'=>(($newType==$type)?@$_POST['date']:@date("Y-m-d")),'time'=>(($newType==$type)?@$_POST['time']:@date("H:i:s")),'tag'=> join(',',array_unique($topicAttr)),'f'=> join(',',$getNewFiles),'url'=> $setPostUrl,'alturl'=>@$_POST['alturl'],'sec'=>@$_POST['secret'],'fav'=>@$_POST['faved'],'cm'=>@$_POST['comments'],'ttl'=>@$_POST['title'],'kw'=>@$_POST['keywords'],'dsc'=>@$_POST['description'],'page'=>@$_POST['page'],'menu'=>@$_POST['inmenu'],'side'=>@$_POST['insidebar'],'adlt'=>@$_POST['adult'],'pre'=>@$_POST['preface'],'emb'=>@$_POST['embeds'],'lng'=>@$_POST['postlang'],'mdate'=>@date("Y-m-d"),'mtime'=>@date("H:i:s"),'lent'=> $getLenta);if(isset($_POST['commentsOverride']))$postElements['cmovr']=$_POST['commentsOverride'];if(isset($_POST['visibleOverride']))$postElements['vovr']=$_POST['visibleOverride'];if($_POST['special_date_day']!=0 && $_POST['special_date_month']!=0 && $_POST['special_date_year']!=0){$postElements['ndate']=$_POST['special_date_year'] .'-' .$_POST['special_date_month'] .'-' .$_POST['special_date_day'];$postElements['ntime']=$_POST['special_date_hour'] .':' .$_POST['special_date_minute'] .':' .$_POST['special_date_second'];}else{$postElements['ndate']='';$postElements['ntime']='';}$post='';foreach($postElements as $k=>$v){if($v!=''&& $v!='0'&& $v!='<br>')$post .= '<p:' .$k .'>' .$v .'</p:' .$k .'>';}filewriter(System .Db,upXMLer($db,array($type .':' .$id=>'',$newType .':' .$newId=>$post,'topics'=>trim($editedTopics) .$addTopiсs,'blogs'=>$getElemBlogs .$addBlogStr)));if($_POST['is_mainpage']!==$_POST['is_mainpage_stored']){$urlOrAlias=($setPostUrl != '')?$setPostUrl:'post-' .$_POST['itemId'];$urlOrAliasToRecored=($_POST['is_mainpage']>0)?$urlOrAlias:'';filewriter(System .Db,upXMLer($db,array('mainpage'=>$urlOrAliasToRecored)));}createBackup();innerCallback();updateSitemap();if($getElemMultilang>0 && isset($_POST['postlang'])&& $_POST['postlang']!='')setCookie("lang",$_POST['postlang'],time()+31536000,Siteroot);$getIsPage=(!isset($_POST['page'])|| $_POST['page']=='')?0:$_POST['page'];$getWasPage=(!isset($select['isPage'])|| $select['isPage']=='')?0:$select['isPage'];if(isset($_POST['backUrl'])&& $getWasPage==$getIsPage)setRedirect($_POST['backUrl'],'','p' .$newId);else if(@$_POST['url']!='')setRedirect($setPostUrl);else setRedirect($newType .'-' .$newId);}$existing_files='<style type="text/css">div.form-elem span.imgPreview{display:inline-block;width:20px;height:20px;overflow:hidden;position:relative;top:5px;}</style><div id="existing-files">';foreach($select['files']as $existing_file){$existing_files .= '<div class="form-elem sort-elem">' .f_check('existingfiles[' .$existing_file .']',(((strpos($existing_file,'.jpg')>-1 || strpos($existing_file,'.jpeg')>-1 || strpos($existing_file,'.png')>-1 || strpos($existing_file,'.gif')>-1)&&(strpos($existing_file,'.zip')===false && strpos($existing_file,'.rar')===false))?'<span class="imgPreview"><img src="' .Siteroot .System .Storage .$existing_file .'" height="35" align="middle"></span> ':'') .'<a href="' .Siteroot .System .Storage .$existing_file .'" target="_blank">' .basename($existing_file) .'</a>',1) .'</div>';}$existing_files .= '</div>';$currentTopics=array();$currentTopicsToEdit=array();foreach($mTopics as $mTopicId=>$mTopicTitle){$currentTopics[]='<span class="currentItem">' .f_check('currentTopic[' .$mTopicId .']',$mTopicTitle,((in_array($mTopicId,$select['tags']))?1:0)) .'</span> ';$currentTopicsToEdit[]=f_elem(f_text('currentTopicsToEdit[' .$mTopicId .']','',$mTopicTitle));}if($select['ndate']!=''){list($slYear,$slMonth,$slDay)=explode('-',$select['ndate']);list($slHour,$slMin,$slSec)=explode(':',$select['ntime']);}else{$slDay=$slMonth=$slHour=$slMin=$slSec=0;$slYear=@date('Y');}$langChoose=array(''=>'','en'=>'English');foreach(viewFolder(System .Langs,'f')as $lngFileRead){$getLngFileContent=equalizer(filereader($lngFileRead));$langAbbr=str_replace(Fxt,'',basename($lngFileRead));$langChoose[$langAbbr]=$getLngFileContent['lang'];}$lentaChoose=array(''=>'[[main blog]]');foreach($mBlogs as $mBlogsItemK=>$mBlogsItemV){$lentaChoose[$mBlogsItemK]=$mBlogsItemV;}$lentaChoose['add']='[[add a blog]]';$m .= $urlcreator;if(defined('Optimized')){$largeTextData=filereader(System .DbRecords .$select['code'] .Fxt);$select['text']=xmler($largeTextData,'r:txt');$select['preface']=xmler($largeTextData,'r:pre');$select['embeds']=xmler($largeTextData,'r:emb');$select['description']=xmler($largeTextData,'r:dsc');$select['keywords']=xmler($largeTextData,'r:kw');$select['title']=xmler($largeTextData,'r:ttl');}else if(defined('Separate')){$select['text']=filereader(System .DbTexts .$select['code'] .Fxt);}$urlOrAlias=($select['alias']!= '')?$select['alias']:'post-' .$_POST['itemId'];$is_mainpage=$getElemMainpage==$urlOrAlias?1:0;$m .= '<h1>[[Edit post]]</h1>' .f1('edit',setURL('edit')) .f_hidden('update','OK') .(isset($_POST['backUrl'])?f_hidden('backUrl',$_POST['backUrl']):'') .f_hidden('date',$select['date']) .f_hidden('time',$select['time']) .f_hidden('code',$select['code']) .f_hidden('itemType',$type) .f_hidden('itemId',$id) .f_elem(f_text('h1','Title:',$select['h1'])) .f_elem(f_textarea('text','Post text:',$select['text'])) .$existing_files .f_files('file',1) .f_elem(f_text('newtags','Add new topic (or few comma divided):')) .((count($mTopics)>0)?f_elem('<label>[[or choose from saved ones:]]</label><div class="setItems">' .join('',$currentTopics) .' <small id="editTopics">(<a href="" id="openEditingTopics" onclick="document.getElementById(\'topicsEditor\').style.display=\'block\'; document.getElementById(\'editTopics\').style.display=\'none\'; return false;">[[edit]]</a>)</small></div><div id="topicsEditor" style="display:none;">' .f_elem('<a href="" id="closeEditingTopics" onclick="document.getElementById(\'topicsEditor\').style.display=\'none\'; document.getElementById(\'editTopics\').style.display=\'inline\'; return false;">&times;</a>') .join('',$currentTopicsToEdit) .'</div>'):'') .f_elem(f_text('url','[[Base part of post URL address:]] <a href="" onclick="createNewUrl(); return false;" id="newurllink">[[change]]</a>',$select['alias'])) .f_elem(f_check('page','use as page not in the blog',$select['isPage'])) .f_elem(f_select('postlang','Post language:',$langChoose,$select['postlang'])) .f_elem(f_select('lenta','Publish in',$lentaChoose,$select['lenta'])) .'<div id="addblogblock" style="display:none;">' .f_elem(f_text('newblog',array('','New blog title'))) .'</div><script type="text/javascript">document.getElementById("lenta").onchange=function(){document.getElementById("addblogblock").style.display = ( document.getElementById("lenta").value=="add" ) ? "block":"none";}</script>' .'<p id="showmore"><a href="" onclick="document.getElementById(\'options\').style.display=\'block\'; document.getElementById(\'showmore\').style.display=\'none\'; return false;"><small>[[Show additional options]]</small></a></p><div id="options" style="display:none;">' .f_elem(f_check('secret','secret post',$select['secret'])) .f_elem(f_check('faved','in favourites',$select['faved'])) .f_hidden('is_mainpage_stored',$is_mainpage) .f_elem(f_check('is_mainpage','make main page',$is_mainpage)) .($getElemComments>0?f_elem(f_check('comments','allow comments',$select['commentable'])):f_hidden('comments',$select['commentable']) .f_elem(f_check('commentsOverride','allow comments for this entry',$select['commentableOverride']))) .($getElemSecret>0?f_elem(f_check('visibleOverride','make this entry visible for everyone',$select['visibleOverride'])):'') .f_elem(f_text('title','Alternate text for TITLE tag:',$select['title'])) .f_elem(f_text('keywords','SEO keywords:',$select['keywords'])) .f_elem(f_text('description','SEO description:',$select['description'])) .f_elem(f_check('draft','store in drafts',$select['draft'])) .f_elem(f_check('inmenu','link in the top menu',$select['inMenu'])) .f_elem(f_check('insidebar','link in the sidebar',$select['inSidebar'])) .f_elem(f_check('adult','18+',$select['adult'])) .f_elem(f_textarea('preface','Post intro to be displayed in the blog instead of the text:',$select['preface'])) .f_elem(f_textarea('embeds','Place Youtube / Google Maps / audio code here:',$select['embeds'])) .f_elem_set('Change publication date',array(f_select('special_date_day','',$modDays,$slDay),f_select('special_date_month','',$modMonths,$slMonth),f_select('special_date_year','',$modYears,$slYear),' &nbsp; ',f_select('special_date_hour','',$modTimeH,$slHour),f_select('special_date_minute','',$modTime,$slMin),f_select('special_date_second','',$modTime,$slSec))) .f_elem(f_text('alturl','Alternative URL (or few comma divided):',$select['alturl'])) .'<p><a href="' .setURL('copy-page','id=' .$select['id'] .'&type=' .($select['draft']>0?'draft':'post')) .'">[[Copy this page]]</a></p>' .'<p id="showless"><a href="" onclick="document.getElementById(\'options\').style.display=\'none\'; document.getElementById(\'showmore\').style.display=\'block\'; return false;"><small>[[Hide additional options]]</small></a></p></div>' .f2('Done');$m .= '<div class="removePost">' .f1('removeForm',setURL('edit')) .f_hidden('erase','OK') .f_hidden('itemType',$type) .f_hidden('itemId',$id) .f2('Remove') .'</div>';}else if($rq == 'copy-page'&& isset($_GET['id'])&& isset($_GET['type'])&& defined('manage')){$select=$mAllEdit[$_GET['type'] .'s'][$_GET['id']];if(@$_POST['copy']=='OK'){$type=(@$_POST['draft']>0)?'draft':'post';$freeId=1;while(strpos($db,'<' .$type .':' .$freeId .'>')>-1){$freeId++;}$source=xmler($db,$_GET['type'] .':' .$_GET['id']);$newCode=generateUniCode();while(in_array($newCode,$codes)){$newCode=generateUniCode();}$setPostUrl=str_replace(' ','-',trim(@$_POST['url']));if((strpos($db,'<p:url>' .$setPostUrl .'</p:url>')>0 || strpos($db,'<url>' .$setPostUrl .'</url>')>0)&& $setPostUrl!=''){$setPostUrlIndex=1;$setPostUrlSaved=$setPostUrl;$setPostUrl=$setPostUrl .'-1';while(strpos($db,'<p:url>' .$setPostUrl .'</p:url>')>0 || strpos($db,'<url>' .$setPostUrl .'</url>')>0){$setPostUrlIndex++;$setPostUrl=$setPostUrlSaved .'-' .$setPostUrlIndex;}}filewriter(System .Db,'<' .$type .':' .$freeId .'>' .upXMLer($source,array('p:u'=> $newCode,'p:h1'=>@$_POST['h1'],'p:url'=> $setPostUrl,'p:date'=>@date("Y-m-d"),'p:time'=>@date("H:i:s"))) .'</' .$type .':' .$freeId .'>','after');if(defined('Separate')){filewriter(System .DbTexts .$newCode .Fxt,filereader(System .DbTexts .xmler($source,'p:u') .Fxt));}updateSitemap();if(@$_POST['url']!='')setRedirect($setPostUrl);else setRedirect($type .'-' .$freeId);}$m .= '<h1>[[Copying page]]</h1>' .f1('copypage',setURL('copy-page','id=' .$_GET['id'] .'&type=' .$_GET['type'])) .f_hidden('copy','OK') .f_elem(f_text('h1','Title:',$select['h1'])) .f_elem(f_text('url','Base part of post URL address:',$select['alias'])) .f_elem(f_check('draft','store in drafts',$select['draft'])) .f2('Done');}else if($rq == 'edit-comments'&& isset($_POST['commentId'])&& isset($_POST['itemId'])&& isset($_POST['itemType'])&& defined('manage')){$type=$_POST['itemType'];$id=$_POST['itemId'];$cmId=$_POST['commentId'];$select=$mAllEdit[$type .'s'][$id];$getcommentdata=filereader(System .Comments .$select['code'] .Fxt);if(isset($_POST['manageComment'])){if(@$_POST['cDel']>0){filewriter(System .Comments .$select['code'] .Fxt,upXMLer($getcommentdata,array('comment:' .$cmId=>'')));}else{filewriter(System .Comments .$select['code'] .Fxt,upXMLer($getcommentdata,array('comment:' .$cmId=>'<cm:auth>' .protectDangerTexts($_POST['cAuth'],'') .'</cm:auth><cm:eml>' .protectDangerTexts($_POST['cEml'],'') .'</cm:eml><cm:web>' .protectDangerTexts($_POST['cWeb'],'') .'</cm:web><cm:txt>' .protectDangerTexts($_POST['cText']) .'</cm:txt><cm:date>' .$_POST['cDate'] .'</cm:date><cm:prem>' .(($_POST['cApprove']>0)?'':'1') .'</cm:prem><cm:answ>' .$_POST['cAnsw'] .'</cm:answ>')));if(@$_POST['cNotif']>0 && trim($_POST['cEml'])!=''){$findUrl=($select['alias']!='')?$select['alias']:'post-' .$select['id'];composeMail(trim($_POST['cEml']),$getElemSitename .translateThis($db,"[[: reply to a comment]]"),translateThis($db,"[[Reply to your comment:]]") ." http://" .ThisServer .setURL($findUrl));}}setRedirect(($select['alias']=='')?'post-' .$select['id']:$select['alias']);}$m .= '<h1>[[Edit the comment]]</h1>' .f1('editComments',setURL('edit-comments'));$commentData=xmler($getcommentdata,'comment:' .$cmId);$m .= f_hidden('manageComment','OK');$m .= f_hidden('commentId',$cmId);$m .= f_hidden('itemId',$id);$m .= f_hidden('itemType',$type);$m .= f_hidden('cDate',xmler($commentData,'cm:date'));$m .= f_elem(f_text('cAuth','Comment author:',xmler($commentData,'cm:auth')));$m .= f_elem(f_text('cEml','E-mail of the comment author:',xmler($commentData,'cm:eml')));$m .= f_elem(f_text('cWeb','Website of the comment author:',xmler($commentData,'cm:web')));$m .= f_elem(f_textarea('cText','Comment text:',xmler($commentData,'cm:txt')));$m .= f_elem(f_textarea('cAnsw','Your reply:',xmler($commentData,'cm:answ')));$m .=(xmler($commentData,'cm:prem')>0)?f_elem(f_check('cApprove','approve this comment',1)):f_hidden('cApprove',1);$m .= f_elem(f_check('cNotif','notify comment author about the reply',1));$m .= f_elem(f_check('cDel','just remove the comment'));$m .= f2('Done');}else if($rq == 'edit-sidebar'&& defined('manage')){if(isset($_POST['sideFirst'])&& isset($_POST['sideLast'])){if(isset($_POST['removeAvatar'])&& $_POST['removeAvatar']>0){@unlink(System .Storage .'personal/avatar.jpg');@unlink(System .Storage .'personal/avatar-more.jpg');}if($_FILES['avatarfile']['name']!=''){$getAvatarName=fileUpload($_FILES['avatarfile'],System .Storage .'personal');convertImages(System .Storage .'personal',$getAvatarName,'avatar-more.jpg',imgMaxW,imgMaxH);convertImages(System .Storage .'personal',$getAvatarName,'avatar.jpg',avMaxW,avMaxH);@unlink(System .Storage .'personal/' .$getAvatarName);}filewriter(System .Db,upXMLer($db,array('sidebar/first'=>$_POST['sideFirst'],'sidebar/links'=>$_POST['sideLinks'],'sidebar/last'=>$_POST['sideLast'],'sidebar/topicson'=>$_POST['sideTopics'],'sidebar/blogson'=>$_POST['sideBlogs'],'sidebar/searchon'=>$_POST['sideSearch'])));setRedirect('edit-sidebar');}$m .= '<h1>[[Edit the sidebar]]</h1>' .f1('editSidebar',setURL('edit-sidebar'));$m .= f_elem(f_file('avatarfile','Profile photo:'));if(file_exists(System .Storage .'personal/avatar.jpg'))$m .= f_elem(f_check('removeAvatar','remove photo'));$m .= f_elem(f_textarea('sideFirst','Text before links:',xmler($db,'sidebar/first')));$m .= f_elem(f_textarea('sideLinks','URL-1 = Text 1<br>URL-2 = Text 2:',xmler($db,'sidebar/links')));$m .= f_elem(f_textarea('sideLast','Text after links:',xmler($db,'sidebar/last')));$m .= f_elem(f_checkbox('sideSearch','search in sidebar',xmler($db,'sidebar/searchon')));$m .= f_elem(f_checkbox('sideBlogs','blogs in sidebar',xmler($db,'sidebar/blogson')));$m .= f_elem(f_checkbox('sideTopics','topics in sidebar',xmler($db,'sidebar/topicson')));$m .= f2('Done');}else if($rq == 'edit-topmenu'&& defined('manage')){if(isset($_POST['topLinks'])){filewriter(System .Db,upXMLer($db,array('top/links'=>$_POST['topLinks'])));setRedirectRef();}$m .= '<h1>[[Edit the top menu]]</h1>' .f1('editTopmenu',setURL('edit-topmenu'));$m .= f_elem(f_textarea('topLinks','URL-1 = Text 1<br>URL-2 = Text 2:',xmler($db,'top/links')));$m .= f2('Done');}else if($rq == 'edit-supermenu'&& defined('manage')){if(isset($_POST['superLinks'])){filewriter(System .Db,upXMLer($db,array('super/links'=>$_POST['superLinks'])));setRedirectRef();}$m .= '<h1>[[Edit the super menu]]</h1>' .f1('editSupermenu',setURL('edit-supermenu'));$m .= f_elem(f_textarea('superLinks','URL-1 = Text 1<br>URL-2 = Text 2:',xmler($db,'super/links')));$m .= f2('Done');}else if($rq == 'edit-footer'&& defined('manage')){if(isset($_POST['footerbar'])){filewriter(System .Db,upXMLer($db,array('footerbar'=>$_POST['footerbar'])));setRedirectRef();}$m .= '<h1>[[Edit the footer]]</h1>' .f1('editFooter',setURL('edit-footer'));$xfooterbar=xmler($db,'footerbar');if($xfooterbar=='')$xfooterbar='[parcelle:sitecopy] | [parcelle:enginelink]';$m .= f_elem(f_textarea('footerbar','Empty this field to reset the footer:',$xfooterbar));$m .= f2('Done');}else if($rq == 'edit-template'&& defined('manage')){if(isset($_POST['htmlTemplate'])&& isset($_POST['postTemplate'])){filewriter(System .Themes .$templateDir .Template,upXMLer(filereader(System .Themes .$templateDir .Template),array('m:html'=>$_POST['htmlTemplate'],'m:phtml'=>$_POST['postTemplate'])));filewriter(System .Themes .$templateDir .Style,$_POST['cssCode']);setRedirectRef();}$m .= '<h1>[[Edit the current template]]</h1>' .f1('editTemplate',setURL('edit-template'));$m .= f_elem(f_textarea('htmlTemplate','HTML template:',str_replace(array('<','[',']'),array('&lt;','&#91;','&#93;'),$getHtmlTemplate)));$m .= f_elem(f_textarea('postTemplate','Post / page template:',str_replace(array('<','[',']'),array('&lt;','&#91;','&#93;'),$getPostTemplate)));$m .= f_elem(f_textarea('cssCode','CSS:',filereader(System .Themes .$templateDir .Style)));$m .= f2('Done');}else if($rq == 'stats-code'&& defined('manage')){if(isset($_POST['statscode'])){filewriter(System .Db,upXMLer($db,array('statscode'=>$_POST['statscode'])));setRedirectRef();}$m .= '<h1>[[Insert stats code]]</h1>' .f1('editStatsCode',setURL('stats-code'));$m .= f_elem(f_textarea('statscode','',xmler($db,'statscode')));$m .= f2('Done');}else if($rq == 'edit-mymeta'&& defined('manage')){if(isset($_POST['mymeta'])){filewriter(System .Db,upXMLer($db,array('mymeta'=>$_POST['mymeta'])));setRedirectRef();}$m .= '<h1>[[Edit Meta]]</h1>' .f1('editMeta',setURL('edit-mymeta'));$m .= f_elem(f_textarea('mymeta','',xmler($db,'mymeta')));$m .= f2('Done');}else if($rq == 'logger'&& defined('manage')){$m .= '<h1>[[Log]]</h1>';$postsCount=0;$pagesCount=0;foreach($mAll['posts']as $pub){if($pub['isPage']>0)$pagesCount++;else $postsCount++;}if($postsCount>0)$m .= '<p><a href="' .setURL('list-posts') .'">[[Posts]]: ' .$postsCount .'</a></p>';if($pagesCount>0)$m .= '<p><a href="' .setURL('list-pages') .'">[[Pages]]: ' .$pagesCount .'</a></p>';$draftsCount=count($mAll['drafts']);if($draftsCount>0)$m .= '<p><a href="' .setURL('drafts') .'">[[Drafts]]: ' .$draftsCount .'</a></p>';$secretsCount=count($secrets);if($secretsCount>0)$m .= '<p><a href="' .setURL('secret') .'">[[Secret posts]]: ' .$secretsCount .'</a></p>';$favsCount=count($favourites);if($favsCount>0)$m .= '<p><a href="' .setURL('favourite') .'">[[Favourite]]: ' .$favsCount .'</a></p>';$commentsCount=0;foreach(viewFolder(System .Comments,'f')as $commentFile){$commentsCount += substr_count(filereader($commentFile),'</cm:txt>');}if($commentsCount>0)$m .= '<p><a href="' .setURL('comments') .'">[[Comments]]: ' .$commentsCount .'</a></p>';function filewalk($dir,$countfiles,$countsize){foreach(viewFolder($dir,'d')as $item){list($countfiles,$countsize)=filewalk($item,$countfiles,$countsize);}foreach(viewFolder($dir,'f')as $item){$countfiles++;$countsize += filesize($item);}return array($countfiles,$countsize);}list($filesCount,$fileSizeCount)=filewalk('.',0,0);$m .= '<p><a href="' .setURL('files') .'">[[Files]]: ' .$filesCount .' (' .ceil($fileSizeCount/1048576) .' [[MB]])</a></p>';$m .= '<br>';$log=explode("\n",filereader(Logger));foreach($log as $str){if(trim($str)=='')continue;list($logDate,$logBrowser,$logIP)=explode('|',$str);$m .= '<p>' .humanifyDate($logDate) .' / ' .$logBrowser .' / ' .$logIP .'</p>';}}else if($rq == 'edit-part'&& defined('manage')&& isset($_GET['part'])&& isset($_GET['backurl'])){if(isset($_POST['part'])){filewriter(System .Db,upXMLer($db,array('editbl/' .$_GET['part']=>$_POST['part'])));setRedirect($_GET['backurl']);}$m .= '<h1>[[Editing part]]: ' .$_GET['part'] .'</h1>' .f1('editpart',setURL('edit-part','part=' .$_GET['part'] .'&backurl=' .$_GET['backurl']));$m .= f_elem(f_textarea('part','',xmler($getElemEditbl,$_GET['part'])));$m .= f2('Done');}else if($rq == 'edit-phpcode'&& defined('manage')&& isset($_GET['part'])&& isset($_GET['backurl'])){if(isset($_POST['code'])){filewriter(System .Db,upXMLer($db,array('phpcodes/' .$_GET['part']=>$_POST['code'])));setRedirect($_GET['backurl']);}$m .= '<h1>[[PHP code]]: ' .$_GET['part'] .'</h1>' .f1('editpart',setURL('edit-phpcode','part=' .$_GET['part'] .'&backurl=' .$_GET['backurl']));$m .= f_elem(f_textarea('code','',xmler($getElemPhpcodes,$_GET['part'])));$m .= f2('Done');}else if($rq == 'edit-menu'&& defined('manage')&& isset($_GET['menu'])&& isset($_GET['backurl'])){if(isset($_POST['menuwrk'])){filewriter(System .Db,upXMLer($db,array('usermenu/' .$_GET['menu']=>$_POST['menuwrk'])));setRedirect($_GET['backurl']);}$m .= '<h1>[[Editing menu]]: ' .$_GET['menu'] .'</h1>' .f1('editmenu',setURL('edit-menu','menu=' .$_GET['menu'] .'&backurl=' .$_GET['backurl']));$m .= f_elem(f_textarea('menuwrk','URL-1 = Text 1<br>URL-2 = Text 2:',xmler($getElemUsermenu,$_GET['menu'])));$m .= f2('Done');}else if($rq == 'edit-meta'&& defined('manage')&& isset($_GET['r'])){$key=$_GET['r'];if(isset($_POST['alias'])){$preface=trim($_POST['preface'])==''?'':$_POST['preface'];if($preface=='<br>')$preface='';$setAlias=str_replace(' ','-',trim(@$_POST['alias']));if((strpos($db,'<p:url>' .$setAlias .'</p:url>')>0 || strpos($db,'<url>' .$setAlias .'</url>')>0)&& $setAlias!=''&& $setAlias!=xmler($db,'metas/' .$key .'/url')){$setAliasIndex=1;$setAliasSaved=$setAlias;$setAlias=$setAlias .'-1';while(strpos($db,'<p:url>' .$setAlias .'</p:url>')>0 || strpos($db,'<url>' .$setAlias .'</url>')>0){$setAliasIndex++;$setAlias=$setAliasSaved .'-' .$setAliasIndex;}}$metaDataToWrite=array('metas/' .$key .'/url'=>$setAlias,'metas/' .$key .'/h1'=>trim($_POST['heading']),'metas/' .$key .'/intr'=>$preface,'metas/' .$key .'/ttl'=>trim($_POST['title']),'metas/' .$key .'/kw'=>trim($_POST['keywords']),'metas/' .$key .'/dsc'=>trim($_POST['description']),'metas/' .$key .'/secret'=>(isset($_POST['secret'])?$_POST['secret']:0),'hidetopics'=>@$_POST['hidetopics']);if(isset($_POST['name'])&& $_POST['name']!=''){if(strpos($key,'blog-')>-1){$blogItem=str_replace('blog-','',$key);$setUpdatedBlogs=array();foreach($mBlogs as $mBlogsItemK=>$mBlogsItemV){if($blogItem==$mBlogsItemK)$setUpdatedBlogs[]=$mBlogsItemK .' = ' .trim($_POST['name']);else $setUpdatedBlogs[]=$mBlogsItemK .' = ' .$mBlogsItemV;}$metaDataToWrite['blogs']=join("\n",$setUpdatedBlogs);}else if(strpos($key,'tag-')>-1){$topicItem=str_replace('tag-','',$key);$setUpdatedTopics=array();foreach($mTopics as $mTopicsItemK=>$mTopicsItemV){if($topicItem==$mTopicsItemK)$setUpdatedTopics[]=$mTopicsItemK .' = ' .trim($_POST['name']);else $setUpdatedTopics[]=$mTopicsItemK .' = ' .$mTopicsItemV;}$metaDataToWrite['topics']=join("\n",$setUpdatedTopics);}}filewriter(System .Db,upXMLer($db,$metaDataToWrite));$whereToGo=$setAlias==''?$key:$setAlias;setRedirect($whereToGo);}$termToSpecifyEditingMeta=array('tag'=>'topics','blog'=>'blogs');$m .= '<h1>[[Editing meta]]: ' .$getAliasedElements[$key] .($key!='blog'?' ([[' .$termToSpecifyEditingMeta[substr($key,0,strpos($key,'-'))] .']])':'') .'</h1>' .f1('editmeta',setURL('edit-meta','r=' .$key)) .(strpos($key,'tag-')>-1?f_elem(f_check('hidetopics','hide topic list',$getElemHidetopics)):'') .($key!='blog'?f_elem(f_text('name','Name',$getAliasedElements[$key])):'') .f_elem(f_text('alias','Alternative URL',$metas[$key]['url'])) .(strpos($key,'blog-')>-1?f_elem(f_check('secret','secret blog',$metas[$key]['secret'])):'') .f_elem(f_text('heading','Alternative heading',$metas[$key]['h1'])) .f_elem(f_textarea('preface','Preface',$metas[$key]['intro'])) .f_elem(f_text('title','Alternative title',$metas[$key]['title'])) .f_elem(f_text('keywords','Keywords',$metas[$key]['keywords'])) .f_elem(f_text('description','Description',$metas[$key]['description'])) .f2('Done');}else if($rq == 'list-pages'&& defined('manage')){$m .= '<h1>[[Pages]]</h1>';$m .= searchForm();$m .= '[parcelle:pages:all-abc:1]';}else if($rq == 'list-posts'&& defined('manage')){$m .= '<h1>[[Posts]]</h1>';$m .= searchForm();$m .= '[parcelle:posts:all-r:1]';}else if(file_exists(System .Special .$rq .Fxt)){$param='';$mainScript=$rq;$file=System .Special .$rq .Fxt;include_once $file;if(defined('manage')&&!isset($_GET['ajax'])&&!isset($_GET['naked']))$m .= '<div class="manage">' .f1('editsrc',setURL('editsource','f=' .$file)) .f2('[[Edit]]') .'</div>';}else if(strpos($rq,'/')>0 && file_exists(System .Special .substr($rq,0,strpos($rq,'/')) .Fxt)){$param=substr($rq,(strpos($rq,'/')+1));$mainScript=substr($rq,0,strpos($rq,'/'));$file=System .Special .$mainScript .Fxt;include_once $file;if(defined('manage')&&!isset($_GET['ajax'])&&!isset($_GET['naked']))$m .= '<div class="manage">' .f1('editsrc',setURL('editsource','f=' .$file)) .f2('[[Edit]]') .'</div>';}else if(strrpos($rq,'/')>0 && file_exists(System .Special .substr($rq,0,strrpos($rq,'/')) .Fxt)){$param=substr($rq,(strrpos($rq,'/')+1));$mainScript=substr($rq,0,strrpos($rq,'/'));$file=System .Special .$mainScript .Fxt;include_once $file;if(defined('manage'))$m .= '<div class="manage">' .f1('editsrc',setURL('editsource','f=' .$file)) .f2('[[Edit]]') .'</div>';}else{if($rq == 'blog'){if((defined('secret')&& defined('manage'))||!defined('secret')){if($metas[$rq]['h1']!='')$m .= '<h1>' .$metas[$rq]['h1'] .'</h1>';if($metas[$rq]['intro']!=''&& strtolower($metas[$rq]['intro'])!='<br>')$m .= '<div class="intro">' .paragrafize($metas[$rq]['intro']) .'</div>';if($metas[$rq]['title']!='')$setTitle=$metas[$rq]['title'];if($metas[$rq]['keywords']!='')$setKeywords=$metas[$rq]['keywords'];if($metas[$rq]['description']!='')$setDescription=$metas[$rq]['description'];}foreach($mAll['posts']as $mItem){if($mItem['isPage']<1 && $mItem['lenta']<1)$mQuery[]=$mItem;}}else if(strpos($rq,'blog-')>-1 && strpos($rq,'rss/')===false){$blogId=str_replace('blog-','',$rq);if($metas[$rq]['secret']>0 &&!defined('manage'))setRedirect();if((defined('secret')&& defined('manage'))||!defined('secret')){if($metas[$rq]['h1']!='')$m .= '<h1>' .$metas[$rq]['h1'] .'</h1>';else $m .= '<h1>' .@$mBlogs[$blogId] .($metas[$rq]['secret']>0?' <small class="secret secret-nested-blog">([[secret blog]])</small>':'') .'</h1>';if($metas[$rq]['intro']!=''&& strtolower($metas[$rq]['intro'])!='<br>')$m .= '<div class="intro">' .paragrafize($metas[$rq]['intro']) .'</div>';if($metas[$rq]['title']!='')$setTitle=$metas[$rq]['title'];if($metas[$rq]['keywords']!='')$setKeywords=$metas[$rq]['keywords'];if($metas[$rq]['description']!='')$setDescription=$metas[$rq]['description'];}foreach($mAll['posts']as $mItem){if($mItem['isPage']<1 && $mItem['lenta']==$blogId)$mQuery[]=$mItem;}$additionalRSS='<link rel="alternate" type="application/rss+xml" href="' .setURL('rss/' .$rq) .'" title="' .@$mBlogs[$blogId] .' (RSS)">';}else if($rq == 'favourite'){$m .= '<h1>[[Favourite]]</h1>';foreach($mAll['posts']as $mItem){if(in_array($mItem['id'],$favourites))$mQuery[]=$mItem;}}else if($rq == 'secret'&& defined('manage')){$m .= '<h1>[[Secret posts]]</h1>';foreach($mAll['posts']as $mItem){if($mItem['secret']>0)$mQuery[]=$mItem;}}else if($rq == 'drafts'&& defined('manage')){$m .= '<h1>[[Drafts]]</h1>';foreach($mAll['drafts']as $mItem){$mQuery[]=$mItem;}}else if($rq==randomURL){if(count($mAll['posts'])>0){shuffle($mAll['posts']);$mItemRand=$mAll['posts'][0];if($mItemRand['alias']!='')setRedirect($mItemRand['alias']);else setRedirect('post-' .$mItemRand['id']);}else{setRedirect();}}else if(strpos($rq,'post-')===0){$single=1;foreach($mAll['posts']as $mItem){if($mItem['id']==str_replace('post-','',$rq))$mQuery[]=$mItem;}}else if(strpos($rq,'draft-')===0 && defined('manage')){$single=1;foreach($mAll['drafts']as $mItem){if($mItem['id']==str_replace('draft-','',$rq))$mQuery[]=$mItem;}}else if(isset($mAltUrls[$rq])){Header("HTTP/1.1 301 Moved Permanently");setRedirect($mAltUrls[$rq]);}else if(isset($pseudonyms[$rq])){$single=1;foreach($mAll['drafts']as $mItem){if($mItem['alias']==$rq && defined('manage'))$mQuery[]=$mItem;}foreach($mAll['posts']as $mItem){if($mItem['alias']==$rq)$mQuery[]=$mItem;}}else if(strpos($rq,'tag-')>-1 && strpos($rq,'rss/')===false){$tagId=str_replace('tag-','',$rq);if((defined('secret')&& defined('manage'))||!defined('secret')){if($metas[$rq]['h1']!='')$m .= '<h1>' .$metas[$rq]['h1'] .'</h1>';else $m .= '<h1>' .@$mTopics[$tagId] .'</h1>';if($metas[$rq]['intro']!=''&& strtolower($metas[$rq]['intro'])!='<br>')$m .= '<div class="intro">' .paragrafize($metas[$rq]['intro']) .'</div>';if($metas[$rq]['title']!='')$setTitle=$metas[$rq]['title'];if($metas[$rq]['keywords']!='')$setKeywords=$metas[$rq]['keywords'];if($metas[$rq]['description']!='')$setDescription=$metas[$rq]['description'];if(trim($sideTopics=xmler($db,'sidebar/topicson'))!='1'&& $getElemHidetopics<1)$m .= topicList();}foreach($mAll['posts']as $mItem){if(in_array($tagId,$mItem['tags']))$mQuery[]=$mItem;}$additionalRSS='<link rel="alternate" type="application/rss+xml" href="' .setURL('rss/' .$rq) .'" title="' .@$mTopics[$tagId] .' (RSS)">';}else if(strpos($rq,'date-')>-1){$selectedDateParts=explode('-',$rq);if(count($selectedDateParts)==2){$m .= '<h1>' .$getElemSitename .' &mdash; ' .$selectedDateParts[1] .'</h1>';}else if(count($selectedDateParts)==3){$m .= '<h1>' .$getElemSitename .' ' .$selectedDateParts[2] .'.' .$selectedDateParts[1] .'</h1>';}else if(count($selectedDateParts)==4){$m .= '<h1>' .$getElemSitename .' &mdash; ' .humanifyDate(str_replace('date-','',$rq)) .'</h1>';}foreach($mAll['posts']as $mItem){$getDate=$mItem['date'];$getNDate=$mItem['ndate'];$getViewDate=($getNDate!='')?$getNDate:$getDate;if((count($selectedDateParts)==2 && strpos($getViewDate,$selectedDateParts[1])===0)||(count($selectedDateParts)==3 && strpos($getViewDate,$selectedDateParts[1] .'-' .$selectedDateParts[2])===0)||(count($selectedDateParts)==4 && strpos($getViewDate,$selectedDateParts[1] .'-' .$selectedDateParts[2] .'-' .$selectedDateParts[3])===0))$mQuery[]=$mItem;}}else if($rq == 'search'){$m .= searchForm();if(defined('manage'))$m .= '<p class="additional-search-items"><a href="' .setURL('list-posts') .'">[[Posts]]</a> | <a href="' .setURL('list-pages') .'">[[Pages]]</a></p><br>';if(isset($_GET['term'])){$natSym=array('A'=> 'a','B'=> 'b','C'=> 'c','D'=> 'd','E'=> 'e','F'=> 'f','G'=> 'g','H'=> 'h','I'=> 'i','J'=> 'j','K'=> 'k','L'=> 'l','M'=> 'm','N'=> 'n','O'=> 'o','P'=> 'p','Q'=> 'q','R'=> 'r','S'=> 's','T'=> 't','U'=> 'u','V'=> 'v','W'=> 'w','X'=> 'x','Y'=> 'y','Z'=> 'z','Й'=> 'й','Ц'=> 'ц','У'=> 'у','К'=> 'к','Е'=> 'е','Н'=> 'н','Г'=> 'г','Ш'=> 'ш','Щ'=> 'щ','З'=> 'з','Х'=> 'х','Ъ'=> 'ъ','Ф'=> 'ф','Ы'=> 'ы','В'=> 'в','А'=> 'а','П'=> 'п','Р'=> 'р','О'=> 'о','Л'=> 'л','Д'=> 'д','Ж'=> 'ж','Э'=> 'э','Я'=> 'я','Ч'=> 'ч','С'=> 'с','М'=> 'м','И'=> 'и','Т'=> 'т','Ь'=> 'ь','Б'=> 'б','Ю'=> 'ю','Ё'=> 'е','ё'=> 'е');function preparetext($txt){global $natSym;foreach($natSym as $a1=>$a2){$txt=str_replace($a1,$a2,$txt);}return strip_tags($txt);}$term=preparetext($_GET['term']);if(strlen($term)>3){if(strlen($term)>12){$term=substr($term,0,strlen($term)-4);}else if(strlen($term)>7){$term=substr($term,0,strlen($term)-3);}else if(strlen($term)>5){$term=substr($term,0,strlen($term)-2);}else if(strlen($term)>4){$term=substr($term,0,strlen($term)-1);}$mQuerySearch=array();foreach($mAll['posts']as $mItem){if(defined('Separate'))$mItem['text']=filereader(System .DbTexts .$mItem['code'] .Fxt);if(strpos(preparetext($mItem['h1']),$term)>-1 || strpos(preparetext($mItem['text']),$term)>-1 || strpos(preparetext($mItem['preface']),$term)>-1 || strpos(preparetext($mItem['description']),$term)>-1 || strpos(preparetext($mItem['keywords']),$term)>-1)$mQuerySearch[$mItem['id']]=$mItem;}$m .= '<br>';$mQuerySearch=array_reverse($mQuerySearch);foreach($mQuerySearch as $mSItem){$m .= '<p class="contents">';$m .= '<a href="' .setURL($mSItem['alias']!=''?$mSItem['alias']:$setPlUrlPart .'-' .$mSItem['id']) .'"><b>' .($mSItem['h1']!=''?$mSItem['h1']:'***') .'</b></a>';if(($termStrpos=strpos(preparetext($mSItem['text']),$term))>-1){$termStr=$mSItem['text'];if($termStrpos>100){$termStr=substr($termStr,$termStrpos-75);$termStr='&hellip;' .substr($termStr,strpos($termStr,' '));}$m .= '<br>' .str_replace($_GET['term'],'<span class="term">' .$_GET['term'] .'</span>',reduceText(strip_tags($termStr),500));}$m .= '</p>';}}}}else if(($rq == 'rss'|| strpos($rq,'rss/')>-1)&&!defined('secret')&&!defined('closed')){$rssFeedTitle=((($getSiteName=$getElemSitename)!='')?$getSiteName:Engine);if($rq != 'rss'){$rssQuery=str_replace('rss/','',$rq);if(strpos($rssQuery,'tag-')>-1){$getTag=str_replace('tag-','',$rssQuery);$rssFeedTitle=$rssFeedTitle .' / ' .$mTopics[$getTag];}else if(strpos($rssQuery,'blog-')>-1){$getBlog=str_replace('blog-','',$rssQuery);$rssFeedTitle=$rssFeedTitle .' / ' .$mBlogs[$getBlog];}}foreach($mAllStable['posts']as $mItem){if($mItem['isPage']<1 && $mItem['secret']<1){if($rq == 'rss')$mQuery[]=$mItem;else{if(strpos($rssQuery,'tag-')>-1){if(in_array($getTag,$mItem['tags']))$mQuery[]=$mItem;}else if(strpos($rssQuery,'blog-')>-1){if($getBlog==$mItem['lenta'])$mQuery[]=$mItem;}}}}$mQuery=array_reverse($mQuery);$mxml="<" ."?xml version=\"1.0\" encoding=\"UTF-8\" ?" .">
<rss version=\"2.0\">
<channel>
<title>" .$rssFeedTitle ."</title>
<link>http://" .ThisServer .setURL($rq) ."</link>
<description>" .($getElemMotto!=''?$getElemMotto:Engine) ."</description>
<language>ru</language>
<generator>" .Engine .' ' .EngineVersion ."</generator>
";$mnthabbr=array('01'=>'Jan','02'=>'Feb','03'=>'Mar','04'=>'Apr','05'=>'May','06'=>'Jun','07'=>'Jul','08'=>'Aug','09'=>'Sep','10'=>'Oct','11'=>'Nov','12'=>'Dec');$mxmli=0;$listing=$getElemListing;foreach($mQuery as $mXmlItem){$checkLentaNum=$mXmlItem['lenta'];if($checkLentaNum!=''&& $checkLentaNum>0){if($metas['blog-' .$checkLentaNum]['secret']>0)continue;}$mxmli++;if($mxmli>$listing)break;$getDate=$mXmlItem['date'];$getTime=$mXmlItem['time'];$getNDate=$mXmlItem['ndate'];$getNTime=$mXmlItem['ntime'];$getMxmlDate=($getNDate!='')?$getNDate:$getDate;$getMxmlTime=($getNTime!='')?$getNTime:$getTime;list($year,$month,$day)=explode('-',$getMxmlDate);list($hour,$minute,$second)=explode(':',$getMxmlTime);$required_day=@date("D",@mktime($hour,$minute,$second,$month,$day,$year));if(defined('Optimized')){$largeTextData=filereader(System .DbRecords .$mXmlItem['code'] .Fxt);$mXmlItem['text']=xmler($largeTextData,'r:txt');$mXmlItem['preface']=xmler($largeTextData,'r:pre');}else if(defined('Separate')){$mXmlItem['text']=filereader(System .DbTexts .$mXmlItem['code'] .Fxt);}$mXmlItem['text']=str_replace(array('src="/','src=\'/','href="/','href=\'/','SRC="/','SRC=\'/','HREF="/','HREF=\'/'),array('src="http://' .ThisServer .'/','src=\'http://' .ThisServer .'/','href="http://' .ThisServer .'/','href=\'http://' .ThisServer .'/','SRC="http://' .ThisServer .'/','SRC=\'http://' .ThisServer .'/','HREF="http://' .ThisServer .'/','HREF=\'http://' .ThisServer .'/'),$mXmlItem['text']);$mXmlItem['preface']=str_replace(array('src="/','src=\'/','href="/','href=\'/','SRC="/','SRC=\'/','HREF="/','HREF=\'/'),array('src="http://' .ThisServer .'/','src=\'http://' .ThisServer .'/','href="http://' .ThisServer .'/','href=\'http://' .ThisServer .'/','SRC="http://' .ThisServer .'/','SRC=\'http://' .ThisServer .'/','HREF="http://' .ThisServer .'/','HREF=\'http://' .ThisServer .'/'),$mXmlItem['preface']);$mXmlImage='';if(count($mXmlItem['files'])>0){foreach($mXmlItem['files']as $mXmlItemFile){if((strpos($mXmlItemFile,'.jpg')>0 || strpos($mXmlItemFile,'.jpeg')>0 || strpos($mXmlItemFile,'.gif')>0 || strpos($mXmlItemFile,'.png')>0)&& file_exists(System .Storage .$mXmlItemFile)){$mXmlImage=htmlspecialchars('<p><img src="http://' .ThisServer .Siteroot .System .Storage .$mXmlItemFile .'"><p>');break;}}}$mxml .= "<item>\n\t<title>" .htmlspecialchars($mXmlItem['h1']) ."</title>\n\t<link>http://" .ThisServer .setURL(($mXmlItem['alias']!='')?$mXmlItem['alias']:'post-' .$mXmlItem['id']) ."</link>\n\t<description>" .$mXmlImage .htmlspecialchars(functionize(menuize(phpcodeize(editize(parcellize($mAllStable,tilize(paragrafize((trim(strip_tags($mXmlItem['preface']))!='')?recognizeLinks($mXmlItem['preface']):recognizeLinks($mXmlItem['text']))))))))) ."</description>\n\t<pubDate>" .$required_day .", " .$day ." " .$mnthabbr[$month] ." " .$year ." " .$mXmlItem['time'] ."</pubDate>\n</item>\n";}$mxml .= "</channel>
</rss>";$mxml=translateThis($db,$mxml);header("Content-type: application/rss+xml");echo $mxml;exit;}if(!isset($_COOKIE['chrono'])&& $getElemOrder == '')$mQuery=array_reverse($mQuery);if($rq == 'search'){$mQueryPaged=$mQuery;}else{$mQueryPaged=array();$getStartPage=(perpage*page-perpage);$getFinalPage=((perpage*page-perpage)+perpage-1);$getPageCounter=ceil(count($mQuery)/perpage);foreach($mQuery as $kKey => $mQuerySet){if($kKey>=$getStartPage && $kKey<=$getFinalPage)$mQueryPaged[]=$mQuerySet;}}if(defined('manage')&&(strpos($rq,'tag-')>-1 || strpos($rq,'blog-')>-1 || $rq == 'blog')){$m .= '<p><a href="' .setURL('edit-meta','r=' .$rq) .'">[[edit]]</a></p>';}$p=$getPostTemplate;$mpag1='';$mpag2='';if($getElemPaginate != 'none'){$upsideDownLink=(isset($_COOKIE['chrono']))?'Usual blog order':'Read from the start';$upsideDownLink='<a href="' .setURL('upside-down') .'" class="upside-down">[[' .$upsideDownLink .']]</a>';if($getElemOrder != ''){$upsideDownLink='';}if($getPageCounter>1){$ps=array();$psconcise=array();$blogAliased=(isset($aliasedURLs['blog'])&& $aliasedURLs['blog']!='')?$aliasedURLs['blog']:'blog';$rgExcl=($rq=='')?$blogAliased:$savedrq;for($i=1;$i<=$getPageCounter;$i++){if($getPageCounter>9 && $i<(page-2)&& page>4){$ps[(page-3)]='<a href="' .setURL($rgExcl .pager .(page-3)) .'">&hellip;</a>';continue;}if($getPageCounter>9 && $i>(page+2)&& page<($getPageCounter-4)&& $i!=$getPageCounter){$ps[(page+3)]='<a href="' .setURL($rgExcl .pager .(page+3)) .'">&hellip;</a>';continue;}$pageSuff=($i>1)?pager .$i:'';$ps[$i]=($i==page)?'<b>' .$i .'</b>':'<a href="' .setURL($rgExcl .$pageSuff) .'">' .$i .'</a>';}if(page>1){$psconcise[]='<a href="' .setURL($rgExcl .pager .(page-1)) .'">&laquo; [[previous]]</a>';}if(page<($getPageCounter)){$psconcise[]='<a href="' .setURL($rgExcl .pager .(page+1)) .'">[[next]] &raquo;</a>';}if(page>1)$ps[0]='<a href="' .setURL($rgExcl .pager .(page-1)) .'">&laquo;</a>';if($getPageCounter>2 && page>2)$ps[-1]='<a href="' .setURL($rgExcl .pager .'1') .'">&laquo;&laquo;</a>';if(page<($getPageCounter))$ps[($getPageCounter+1)]='<a href="' .setURL($rgExcl .pager .(page+1)) .'">&raquo;</a>';ksort($ps);if($getPageCounter>2 && page<($getPageCounter))$ps[($getPageCounter+2)]='<a href="' .setURL($rgExcl .pager .$getPageCounter) .'">&raquo;&raquo;</a>';ksort($ps);if($getElemPaginate == 'double'){$mpag1='<div class="paginator paginator-upper"><p class="sorter"><span>[[Pages:]]</span> ' .join(' ',$ps) .' <span class="upside-down-envelope">' .$upsideDownLink .'</span></p><p class="delimiter">&nbsp;</p></div>';}$mpag2='<div class="paginator paginator-lower"><p class="delimiter">_______________________</p><p class="sorter"><span>[[Pages:]]</span> ' .join(' ',($getElemPaginate=='concise'?$psconcise:$ps)) .' <span class="upside-down-envelope">' .$upsideDownLink .'</span></p></div>';}else if(count($mQueryPaged)>1){$mpag2='<div class="paginator"><p class="sorter">' .$upsideDownLink .'</p></div>';}}$m .= $mpag1;$countPostsHere=1;$evenOdd='even';foreach($mQueryPaged as $mPost){$evenOdd=($evenOdd=='even')?'odd':'even';$q=$p;$postOrDraft=$mPost['draft']>0?'draft':'post';$findUrl=($mPost['alias']!='')?$mPost['alias']:$postOrDraft .'-' .$mPost['id'];if($mPost['adult']>0 &&!isset($_COOKIE['adult'])){$q=str_replace(array('<m:p:images>','<m:p:files>','<m:p:comments>'),'',$q);$q=str_replace('<m:p:text>','<div class="post-text">' .f1('adult-content',setURL('let-me-see-adult-content')) .f2('18+') .'</div>',$q);}if($single>0 && isset($_POST['commentText'])&&!empty($_POST['commentText'])&& isset($_POST['commentAuthor'])&&!empty($_POST['commentAuthor'])&& captcha_check()>0){$commentsAmount=substr_count(filereader(System .Comments .$mPost['code'] .Fxt),'</comment:');$addPremoderated=($getElemPremoderateComments>0)?'<cm:prem>1</cm:prem>':'';filewriter(System .Comments .$mPost['code'] .Fxt,'<comment:' .($commentsAmount+1) .'><cm:auth>' .trim(protectDangerTexts($_POST['commentAuthor'],'')) .'</cm:auth><cm:eml>' .trim(protectDangerTexts($_POST['commentEmail'],'')) .'</cm:eml><cm:web>' .trim(protectDangerTexts($_POST['commentWeb'],'')) .'</cm:web><cm:txt>' .trim(protectDangerTexts($_POST['commentText'])) .'</cm:txt><cm:date>' .@date("Y-m-d H:i:s") .'</cm:date>' .$addPremoderated .'<cm:answ></cm:answ></comment:' .($commentsAmount+1) .'>','after');setCookie("commentAuthor",trim($_POST['commentAuthor']),time()+31536000,Siteroot);setCookie("commentEmail",trim(@$_POST['commentEmail']),time()+31536000,Siteroot);setCookie("commentWeb",trim(@$_POST['commentWeb']),time()+31536000,Siteroot);if(($myEmail=trim($getElemEmail))!=''){if(strtolower($myEmail)!=strtolower(trim($_POST['commentEmail'])))composeMail($myEmail,$getElemSitename .translateThis($db,"[[: new comment]]"),translateThis($db,"[[New comment at]]") ." http://" .ThisServer .setURL($findUrl) ." \n\n" .trim(protectDangerTexts($_POST['commentAuthor'],'')) .': ' .trim(protectDangerTexts($_POST['commentText'],'')) .' (' .@date("d.m.Y H:i") .')' .(!empty($_POST['commentEmail'])?" \n\nE-mail: " .trim(protectDangerTexts($_POST['commentEmail'],'')):''));}$commentsData=filereader(System .Comments .$mPost['code'] .Fxt);setRedirect($rq);}$breadcrumbs='';if($single>0 && strpos($findUrl,'/')>1){$parsedUrl=$findUrl;$bcPaths=array('<b>' .$mPost['h1'] .'</b>');while(strpos($parsedUrl,'/')>1){$parsedUrl=substr($parsedUrl,0,strrpos($parsedUrl,'/'));if(isset($pseudonyms[$parsedUrl]))$bcPaths[]='<a href="' .setURL($parsedUrl) .'">' .$pseudonyms[$parsedUrl] .'</a>';}if(count($bcPaths)>1)$breadcrumbs='<div class="breadcrumbs">' .join(' <span>&raquo;<span> ',array_reverse($bcPaths)) .'</div>';}$q=str_replace('<m:p:breadcrumbs>',$breadcrumbs,$q);$q=str_replace('<m:p:id>',$mPost['id'],$q);$q=str_replace('<m:p:h1>',(($single>0)?'<h1 id="p' .$mPost['id'] .'">' .$mPost['h1'] .'</h1>':'<h2 id="p' .$mPost['id'] .'"><a href="' .setURL($findUrl) .'">' .$mPost['h1'] .'</a></h2>'),$q);$q=str_replace('<m:p:url>',setURL($findUrl),$q);$socialButtons='<div class="yashare-auto-init" data-yashareL10n="' .specifyLang() .'" data-yashareType="none" data-yashareQuickServices="' .socialNetworks .'" data-yashareLink="http://' .ThisServer .setURL($findUrl) .'"></div>';if(defined('Optimized')){$largeTextData=filereader(System .DbRecords .$mPost['code'] .Fxt);$mPost['text']=xmler($largeTextData,'r:txt');$mPost['preface']=xmler($largeTextData,'r:pre');$mPost['embeds']=xmler($largeTextData,'r:emb');if($single>0){$setDescription=xmler($largeTextData,'r:dsc');$setKeywords=xmler($largeTextData,'r:kw');$setTitle=xmler($largeTextData,'r:ttl');}}else if(defined('Separate')){$mPost['text']=filereader(System .DbTexts .$mPost['code'] .Fxt);}if(strpos(strtolower($mPost['text']),'<table')>-1 && strpos(strtolower($mPost['text']),'<p')===false)$mPost['text']=$mPost['text'] .'<p></p>';if(strpos(strtolower($mPost['preface']),'<table')>-1 && strpos(strtolower($mPost['preface']),'<p')===false)$mPost['preface']=$mPost['preface'] .'<p></p>';$readMore=' <a href="' .setURL($findUrl) .'" class="read-more">[[Full text]]</a>';$q=str_replace('<m:p:text>','<div class="post-text">' .($single<1 && $getElemCutting>0?'<p>' .reduceText(strip_tags(str_replace(array('</p>','<br>','<br/>','<br />'),' ',$mPost['text'])),$getElemCutting) .$readMore .'</p>':paragrafize(smile(($single<1 && trim(strip_tags($mPost['preface']))!='')?recognizeLinks($mPost['preface']) .$readMore:recognizeLinks($mPost['text']))) .($mPost['embeds']!=''?'<div class="embed">' .$mPost['embeds'] .'</div>':'') .(($getElemSocial>0 && $single>0)?'<div class="social">' .$socialButtons .'</div>':'')) .'</div>',$q);if($mPost['isPage']>0){$blogContentType='page';$q=str_replace(array('<m:p:date>','(<m:p:time>)','<m:p:time>'),array('','',''),$q);}else{$blogContentType='post';$getDate=$mPost['date'];$getTime=$mPost['time'];$getNDate=$mPost['ndate'];$getNTime=$mPost['ntime'];$getViewDate=($getNDate!='')?$getNDate:$getDate;$getViewTime=($getNTime!='')?$getNTime:$getTime;$q=(strpos($q,'<m:p:time>')>-1)?str_replace('<m:p:date>','<div class="date"><span class="date_date">' .humanifyDate($getViewDate,1) .'</span>',$q):str_replace('<m:p:date>','<div class="date"><span class="date_date">' .humanifyDate($getViewDate,1) .'</span></div>',$q);$q=str_replace('<m:p:time>','<span class="date_time">(' .$getViewTime .')</span></div>',$q);}$listTopics=array();foreach($mPost['tags']as $tag){$setTagUrl=isset($aliasedURLs['tag-' .$tag])?$aliasedURLs['tag-' .$tag]:'tag-' .$tag;$listTopics[$mTopics[$tag]]='<a href="' .setURL($setTagUrl) .'">' .$mTopics[$tag] .'</a>';}ksort($listTopics);if($mPost['faved']>0){array_unshift($listTopics,'<a href="' .setURL('favourite') .'" class="favourite">[[Favourite]]</a>');}if($mPost['secret']>0){array_unshift($listTopics,'<a href="' .setURL('secret') .'" class="secret">[[Secret posts]]</a>');}if($mPost['microtime']>now){$listTopics[]='<span class="deferred">[[Deferred post]]</span>';}if($mPost['adult']>0){$listTopics[]='<span class="secret adult">[[18+]]</span>';}if(count($listTopics)>0){$q=str_replace('<m:p:tags>','<div class="tags">' .join(', ',$listTopics) .'</div>',$q);}else{$q=str_replace('<m:p:tags>','',$q);}$q=str_replace('<m:p:edit>',((defined('manage'))?'<div class="manage">' .f1('removeForm',setURL('edit')) .f_hidden('erase','OK') .f_hidden('itemId',$mPost['id']) .f_hidden('itemType',$postOrDraft) .f2('Remove') .'</div><div class="manage">' .f1('manage',setURL('edit')) .f_hidden('itemId',$mPost['id']) .($single<1?f_hidden('backUrl',($rqAll!==''?$rqAll:'blog')):'') .f_hidden('itemType',$postOrDraft) .f2('Edit') .'</div>':''),$q);$setAttr=array('post');$setAttr[]=($single>0)?'post-single':'post-inlenta';if($single>0 && $mPost['isPage']>0)$setAttr[]='post-page';if($mPost['isPage']<1)$setAttr[]='post-inblog';if($single>0 && $mPost['alias']!='')$setAttr[]='post-named-' .str_replace('/','_',$mPost['alias']);if($mPost['faved']>0)$setAttr[]='post-faved';if($mPost['secret']>0)$setAttr[]='post-secret';if($single<1)$setAttr[]='post-here-' .$countPostsHere;if($countPostsHere==1 && page==1 && $single<1)$setAttr[]='post-fresh';$setAttr[]=$evenOdd;$attImages=array();$attMedia=array();$attFiles=array();$imgCountRest=0;if(!empty($mPost['files'])){$imgCount=0;$mediaCount=0;$endOfHiddenImages=0;foreach($mPost['files']as $afile){$afile=trim($afile);$afilel=strtolower($afile);if(!file_exists(System .Storage .$afile))continue;if((strpos($afilel,'.jpg')>0 || strpos($afilel,'.jpeg')>0 || strpos($afilel,'.gif')>0 || strpos($afilel,'.png')>0)&& strpos($q,'<m:p:images>')>-1){if($single<1 && $imgCount>=maxPicsAmount){$imgCountRest++;if($endOfHiddenImages<1){$endOfHiddenImages=1;$attImages[]='<span class="hidden-post-images" id="hidden-post-images-' .$mPost['id'] .'" style="display:none;">';}}$isLarge=file_exists(System .Storage .'large/' .$afile)?'large/':'';$imgCount++;$attImages[]='<a href="' .Siteroot .System .Storage .$isLarge .$afile .'" target="_blank" class="attached_image_link" title="[[Click to enlarge]]"><img src="' .Siteroot .System .Storage .$afile .'" alt="' .$afile .'" class="attached_image_img"></a>' .($imgCount==2?'<br-mark>':'');}else if((strpos($afilel,'.flv')>0 || strpos($afilel,'.mp4')>0 || strpos($afilel,'.mov')>0 || strpos($afilel,'.3gp')>0 || strpos($afilel,'.mp3')>0)&& strpos($q,'<m:p:images>')>-1 && file_exists(System .Media .'uppod.swf')){$mediaMode=(strpos($afilel,'.mp3')>0)?'audio':'video';$mediaH=(strpos($afilel,'.mp3')>0)?'60':'350';$mediaW=(strpos($afilel,'.mp3')>0)?'350':'500';$comment=(strpos($afilel,'.mp3')>0)?'comment=' .str_replace(array('.mp3','.MP3','_'),array('','',' '),basename($afile)) .'&amp;':'';$attMedia[]='<div class="media"><object type="application/x-shockwave-flash" data="http://' .ThisServer .Siteroot .System .Media .'uppod.swf" width="' .$mediaW .'" height="' .$mediaH .'"><param name="bgcolor" value="#ffffff" /><param name="allowFullScreen" value="true" /><param name="allowScriptAccess" value="always" /><param name="wmode" value="window" /><param name="movie" value="http://' .ThisServer .Siteroot .System .Media .'uppod.swf" /><param name="flashvars" value="' .$comment .'m=' .$mediaMode .'&amp;file=http://' .ThisServer .Siteroot .System .Storage .$afile .'&amp;autostart=false" /></object><br clear="all"><a href="' .Siteroot .System .Storage .$afile .'"><small>' .$afile .'</small></a></div>';$mediaCount++;if($single<1 && $mediaCount>=maxMediaAmount){break;}}else{$attFiles[]='<li class="attached_file attached_file_type_' .substr($afile,strrpos($afile,'.')+1) .'"><a href="' .Siteroot .Storage .$afile .'?download" class="attached_file_link">' .basename($afile) .'</a></li>';}}}for($ai=0;$ai<count($attImages);$ai++){$addAttImClasses=array();if(count($attImages)<2){$addAttImClasses[]='attached_images_single';}if(count($attImages)==2){$addAttImClasses[]='attached_images_2';if($ai<1)$addAttImClasses[]='attached_images_2_first';if($ai>0)$addAttImClasses[]='attached_images_2_last';}if(count($attImages)==3 || count($attImages)==4){$addAttImClasses[]='attached_images_group';if($ai<1)$addAttImClasses[]='attached_images_group_first';if($ai>0)$addAttImClasses[]='attached_images_group_rest';if($ai==(count($attImages)-1))$addAttImClasses[]='attached_images_group_last';}if(count($attImages)>4){$addAttImClasses[]='attached_images_group';if($ai<2)$addAttImClasses[]='attached_images_2';if($ai===0)$addAttImClasses[]='attached_images_2_first';if($ai===1)$addAttImClasses[]='attached_images_2_last';if($ai>1)$addAttImClasses[]='attached_images_group_rest';if($ai==(count($attImages)-1))$addAttImClasses[]='attached_images_group_last';}if(count($attImages)>1){$addAttImClasses[]='attached_images_more';$addAttImClasses[]='attached_images_more_' .$ai;}$attImages[$ai]=str_replace('"attached_image_link"','"attached_image_link ' .join(' ',$addAttImClasses) .'"',$attImages[$ai]);}$attImagesSet=join("\n",$attImages);if(count($attImages)>4)$attImagesSet=str_replace('<br-mark>','<br clear="all">',$attImagesSet);else $attImagesSet=str_replace('<br-mark>','',$attImagesSet);$attMediaSet=join("\n",$attMedia);$setImagesAndAttachments=$attImagesSet .$attMediaSet;$q=str_replace('<m:p:images>',($setImagesAndAttachments!=''?'<div class="attached_images">' .$setImagesAndAttachments .($imgCountRest>0?' </span><span class="rest-images"><a href="' .setURL($findUrl) .'" onclick="document.getElementById(\'hidden-post-images-' .$mPost['id'] .'\').style.display=\'inline\'; this.style.display=\'none\'; return false;">+' .$imgCountRest .'</a></span>':'') .'</div>':''),$q);$setAttachedFiles=join("\n",$attFiles);if($setAttachedFiles!='')$setAttachedFiles='<div class="attached_files"><ul class="attached_files_list">' .$setAttachedFiles .'</ul></div>';$q=str_replace('<m:p:files>',$setAttachedFiles,$q);$q=str_replace('<m:p:attr>',join(' ',$setAttr),$q);$commentsLink='';$commentsBlock='';$ratingsGroup='';if(($mPost['commentable']>0 && $getElemComments>0)|| $mPost['commentableOverride']>0){if($single>0){$isPremoderated=($getElemPremoderateComments>0)?'<p class="premoderated-comments">[[Comments are premoderated.]]</p>':'';$commentList=$isPremoderated .loadComments(System .Comments .$mPost['code'] .Fxt,$mPost,$postOrDraft);$commentForm=f1('addComment',setURL($rq)) .f_elem(f_required(f_text('commentAuthor','Your name:',@$_COOKIE['commentAuthor']))) .f_elem(f_text('commentEmail','Your email (for notifications):',@$_COOKIE['commentEmail'])) .f_elem(f_text('commentWeb','Your website:',@$_COOKIE['commentWeb'])) .f_elem(f_required(f_textarea('commentText','Write a comment:'))) .f_elem(captcha()) .f2('Send');$commentsBlock='<div class="comments"><a name="comments"></a><h2>[[Comments]]</h2>' .$commentList .'<div class="comment-form">' .$commentForm .'</div></div>';}else{$comment_count=0;if(file_exists(System .Comments .$mPost['code'] .Fxt)){$comment_count=substr_count(filereader(System .Comments .$mPost['code'] .Fxt),'/cm:answ></comment:');}$commentsLink='<a href="' .setURL($findUrl) .'#comments" class="cl">[[Comment' .($comment_count>0?'s':'') .']]' .($comment_count>0?' (' .$comment_count .')':'') .'</a> ';}}if($getElemRatings>0 && $mPost['draft']<1){$ratingsGroup='<span class="ratings" title="[[Ratings]]">';$ratingsGroup .=($getElemPositiveRatings>0)?'<a href="' .setURL('rate/' .$mPost['id'] .'/plus') .'" class="rating-heart" id="rating-heart-' .$mPost['id'] .'">&#9829;</a>':'<a href="' .setURL('rate/' .$mPost['id'] .'/plus') .'" class="rating-plus" id="rating-plus-' .$mPost['id'] .'">+</a> <a href="' .setURL('rate/' .$mPost['id'] .'/minus') .'" class="rating-minus" id="rating-minus-' .$mPost['id'] .'">&minus;</a>';$getRate=xmler($rateSummary,$mAllEdit['posts'][$mPost['id']]['code'],0);$ratingsGroup .= '<span class="rating-results" id="rating-results-' .$mPost['id'] .'">';if($getElemPositiveRatings>0 && $getRate>0)$ratingsGroup .= ' <small id="rating-result-' .$mPost['id'] .'">' .$getRate .'</small>';else if($getElemPositiveRatings<1 && $getRate!=0)$ratingsGroup .= ' <small id="rating-result-' .$mPost['id'] .'">' .$getRate .'</small>';$ratingsGroup .= '</span></span>';}if($single<1){$urlLink=($mPost['h1']== '')?'<span class="urlLinkArea"><a href="' .setURL($findUrl) .'" class="urlLink">URL</a></span> ':'';if($commentsLink!=''|| $ratingsGroup!='')$q=str_replace('<m:p:comments>','<div class="commentLink">' .$urlLink .$commentsLink .$ratingsGroup .'</div>',$q);else $q=str_replace('<m:p:comments>','',$q);}else{if($ratingsGroup!='')$ratingsGroup='<div class="commentLink">' .$ratingsGroup .'</div>';$q=str_replace('<m:p:comments>',$ratingsGroup .$commentsBlock,$q);}$q=str_replace('[parcelle:children','[parcelle:in-' .$findUrl .'^1',$q);$q=str_replace('[parcelle:all-children','[parcelle:in-' .$findUrl,$q);if(function_exists('postProcessPost')){$q=postProcessPost($q);}$m .= $q;$countPostsHere++;}if(count($mQueryPaged)<1 && $rq != 'search'){if(file_exists(System .Special .Pagenotfound .Fxt)){Header("HTTP/1.1 404 Not Found");$param='';$mainScript=Pagenotfound;$file=System .Special .Pagenotfound .Fxt;include_once $file;}else if(isset($pseudonyms[Pagenotfound])){Header("HTTP/1.1 404 Not Found");setRedirect(Pagenotfound);}else{$m .= '<p class="message">[[No posts here.]]</p>';}if(defined('manage')&&($rq!='blog'&& strpos($rq,'tag-')===false))$m .= '<p><a href="' .setURL('new','url=' .$rq) .'">[[Create]]</a></p>';}$m .= $mpag2;}}}}if(defined('closed')&&!defined('manage')&& $rq!='remind-password')$m=authForm();$m=(strpos($getHtmlTemplate,'<m:all>')>-1 &&!isset($_GET['ajax'])&&!isset($_GET['naked']))?str_replace('<m:all>',$m,trim($getHtmlTemplate)):$m;while(strpos($m,'<m:')>-1){if(defined('closed')&&!defined('manage')){$m=str_replace('<m:menu>','<a href="/"></a>',$m);$m=str_replace('<m:management>','<a href="/"></a>',$m);$m=str_replace('<m:sidebar>','',$m);}$m=str_replace('<m:title>',strip_tags(((isset($setTitle)&& $setTitle!='')||($single>0 && isset($mQueryPaged[0]['title'])&&($setTitle=trim($mQueryPaged[0]['title']))!=''))?$setTitle:((($getH1=xmler($m,'h1'))!='')?$getH1:$getElemSitename)),$m);$m=str_replace('<m:keywords>',strip_tags(((isset($setKeywords)&& $setKeywords!='')||($single>0 && isset($mQueryPaged[0]['keywords'])&&($setKeywords=trim($mQueryPaged[0]['keywords']))!=''))?$setKeywords:((($getH1=xmler($m,'h1'))!='')?$getH1:$getElemKeywords)),$m);$m=str_replace('<m:description>',strip_tags(((isset($setDescription)&& $setDescription!='')||($single>0 && isset($mQueryPaged[0]['description'])&&($setDescription=trim($mQueryPaged[0]['description']))!=''))?$setDescription:((($getH1=xmler($m,'h1'))!='')?$getH1:$getElemDescription)),$m);$m=str_replace('<m:style>',Siteroot .dateBasedCached((file_exists(System .Themes .$templateDir .Style)?System .Themes .$templateDir .Style:System .Themes .Main .Style)),$m);$m=str_replace('<m:rss>',(defined('secret')?'':'<link rel="alternate" type="application/rss+xml" href="' .setURL('rss') .'" title="' .((($getSiteName=$getElemSitename)!='')?$getSiteName:Engine) .' (RSS)">' .(isset($additionalRSS)?"\n\t" .$additionalRSS:'')),$m);$m=str_replace('<m:js>',((file_exists(System .Js))?($getElemNoRTE>0?'<script type="text/javascript">NoRTE=1;</script>' ."\n\t":'') .(defined('manage')?'<script type="text/javascript">var uploadRef="' .setURL(uploadRef) .'";</script>' ."\n\t":'') .'<script type="text/javascript" src="' .Siteroot .dateBasedCached(System .Js) .'"></script>':'') .((file_exists(System .MyJs))?"\n\t" .'<script type="text/javascript" src="' .Siteroot .dateBasedCached(System .MyJs) .'"></script>':'') .((file_exists(System .Themes .$templateDir .MyJs))?"\n\t" .'<script type="text/javascript" src="' .Siteroot .dateBasedCached(System .Themes .$templateDir .MyJs) .'"></script>':'') .($getElemSocial>0?'<script type="text/javascript" src="//yandex.st/share/share.js" charset="utf-8"></script>':''),$m);$m=str_replace('<m:body:class>','body-' .($rq==''?'main':(strpos($rq,'/')>0?substr($rq,0,strpos($rq,'/')):$rq)) .' ' .(defined('manage')?'a':'u') .'-mode ' .((($rq=='blog'&& $mainPage=='')|| $rq==$mainPage)?'mainpage':'innerpage') .'-body ' .(in_array($rq,$service_pages)?'service':'common') .'-pages' .' content-type-' .(isset($blogContentType)?($blogContentType=='page'?'page':'post'):'all') .($single>0?' single-page':''),$m);$m=str_replace('<m:body:id>','body-' .($rq==''?'main':str_replace('/','-',$rq)),$m);$blogTerm=$metas['blog']['h1']!=''?$metas['blog']['h1']:'[[Blog]]';$managementMenu=($getElemHideblog>0)?array():array('blog'=>$blogTerm);if((!defined('secret')||(defined('secret')&& defined('manage')))&& count($favourites)>0 && $getElemHidefav<1)$managementMenu['favourite']='[[Favourite]]';if((!defined('secret')||(defined('secret')&& defined('manage')))&& $getElemHidesearch<1)$managementMenu['search']='[[Search]]';if(defined('manage')){if(file_exists(System .Special .'management' .Fxt))$managementMenu['management']='[[Management]]';if(count($secrets)>0 && $getElemHidesecret<1)$managementMenu['secret']='[[Secret posts]]';$managementMenu['new']='[[Write]]';if(count($mAll['drafts'])>0 && $getElemHidedrafts<1)$managementMenu['drafts']='[[Drafts]]';if($getElemHidefiles<1)$managementMenu['files']='[[Files]]';if(file_exists(System .Comments)&& $getElemComments>0 && $getElemHidecomments<1)$managementMenu['comments']='[[Comments]]';if($getElemRatings>0 && file_exists(Ratings)&& $getElemHideratings<1)$managementMenu['post-ratings']='[[Ratings]]';$managementMenu['preferences']='[[Preferences]]';if(!defined('secret')&&!defined('closed')&& strpos($m,'application/rss')>0 && $getElemHiderss<1)$managementMenu['rss']='[[RSS]]';}else{if(!defined('secret')&& strpos($m,'application/rss')>0 && $getElemHiderss<1)$managementMenu['rss']='[[RSS]]';if($getElemHidemanagement<1)$managementMenu[enterURL]='[[Management]]';}$managementMenu=array_merge($managementMenu,$managementMenuU);if(($supermenulinks=trim(xmler($db,'super/links')))!=''){foreach(equalizer($supermenulinks)as $k=>$v){$managementMenu[$k]=$v;}}if(defined('manage')){$managementMenu=array_merge($managementMenu,$managementMenuA);$managementMenu['edit-supermenu']='<small>[[edit]]</small>';$managementMenu['exit']='[[Exit]]';}$m=str_replace('<m:management>',createMenu($managementMenu,'b',' ','span','management-','',1),$m);$sitenameView=(($getSiteName=$getElemSitename)!='')?$getSiteName:Engine;$m=str_replace('<m:caption>','<a href="' .Siteroot .'" id="caption-link">' .$sitenameView .'</a>',$m);$m=str_replace('<m:motto>',($getElemMotto!=''?'<div id="motto-line">' .$getElemMotto .'</div>':''),$m);$setMenuLinks=array();$setSideLinks=array();foreach($menuLinks as $menuLink){$setMenuLinks[($menuLink[1]=='')?'post-' .$menuLink[0]:$menuLink[1]]=$menuLink[2];}if(($topmenulinks=trim(xmler($db,'top/links')))!=''){foreach(equalizer($topmenulinks)as $k=>$v){$setMenuLinks[$k]=$v;}}if(defined('manage')){$setMenuLinks['edit-topmenu']='<small>[[edit]]</small>';}foreach($sideLinks as $sideLink){$setSideLinks[($sideLink[1]=='')?'post-' .$sideLink[0]:$sideLink[1]]=$sideLink[2];}if(($sidebarlinks=trim(xmler($db,'sidebar/links')))!=''){foreach(equalizer($sidebarlinks)as $k=>$v){$setSideLinks[$k]=$v;}}if(defined('manage')){$setSideLinks['edit-sidebar']='<small>[[edit]]</small>';}$m=str_replace('<m:menu>',createMenu($setMenuLinks,'b',' ','span','menu-'),$m);$hasLargeAvatar=(file_exists(System .Storage .'personal/avatar-more.jpg'))?1:0;$avatarPlace=(file_exists(System .Storage .'personal/avatar.jpg'))?'<div id="avatar">' .($hasLargeAvatar>0?'<a href="' .Siteroot .dateBasedCached(System .Storage .'personal/avatar-more.jpg') .'" class="attached_image_link" target="_blank">':'') .'<img src="' .Siteroot .dateBasedCached(System .Storage .'personal/avatar.jpg') .'">' .($hasLargeAvatar>0?'</a>':'') .'</div>':'';$m=str_replace('<m:sidebar>',$avatarPlace .(trim(xmler($db,'sidebar/searchon'))=='1'?searchForm():'') .((strpos($m,'<m:langs>')===false && count($getElemLangs)>0)?'<div class="sidetext sidetextLangs"><m:langs></div>':'') .((trim($beforeSide=xmler($db,'sidebar/first'))!='')?'<div class="sidetext sidetextFirst">' .paragrafize(recognizeLinks($beforeSide)) .'</div>':'') .((!defined('closed')||(defined('closed')&& defined('manage')))&&(trim($sideBlogs=xmler($db,'sidebar/blogson'))=='1'&&(($getElemSecret>0&&defined('manage'))|| $getElemSecret<1))?'<div class="sideLinks sideLinksBlogs">' .blogList('blogList sideBlogList') .'</div>':'') .'<div class="sideLinks">' .createMenu($setSideLinks,'b',' ','div','side-') .'</div>' .((trim($afterSide=xmler($db,'sidebar/last'))!='')?'<div class="sidetext sidetextLast">' .paragrafize($afterSide) .'</div>':'') .((!defined('closed')||(defined('closed')&& defined('manage')))&&(trim($sideTopics=xmler($db,'sidebar/topicson'))=='1'&&(($getElemSecret>0&&defined('manage'))|| $getElemSecret<1))?topicList('topicList sideTopicList'):''),$m);$m=str_replace('<m:engine>',Engine .' ' .EngineVersion .' ' .EngineCodename .', build ' .EngineBuild,$m);$editLnkMenu=(defined('manage'))?' | ' .createMenu(array('edit-footer'=>'<small>[[edit]]</small>','edit-template'=>'<small>[[template]]</small>','edit-mymeta'=>'<small>[[edit Meta]]</small>','stats-code'=>'<small>[[stats code]]</small>','logger'=>'<small>[[log]]</small>'),'b',' | ','','el-'):'';$m=str_replace('<m:copy>',((($getFooter=trim($beforeSide=xmler($db,'footerbar')))!='')?paragrafize($getFooter .$editLnkMenu):'[parcelle:sitecopy] | [parcelle:enginelink]' .$editLnkMenu),$m);$m=str_replace('<m:favicon>','<link rel="shortcut icon" type="image/x-icon" href="' .Siteroot .'favicon.ico">',$m);$m=str_replace('<m:theme>',Siteroot .System .Themes .$templateDir,$m);$langsPrepared='';if(count($getElemLangs)>0){foreach($getElemLangs as $getElemCurrentLang){$flag=file_exists(System .Flags .$getElemCurrentLang .'.gif')?'<img src="' .Siteroot .System .Flags .$getElemCurrentLang .'.gif' .'" alt="' .$getElemCurrentLang .'">':$getElemCurrentLang;$langsPrepared .=((isset($_COOKIE['lang'])&&@$_COOKIE['lang']==$getElemCurrentLang)||(!isset($_COOKIE['lang'])&& $getElemLang==$getElemCurrentLang))?'<span>' .$flag .'</span> ':'<a href="' .setURL('select-language/' .$getElemCurrentLang) .'" class="langselector' .$isActiveLanguage .'">' .$flag .'</a> ';}}$m=str_replace('<m:langs>',$langsPrepared,$m);if(strpos($m,'<m:stats>')===false)$m=str_replace(array('</body>','</BODY>'),array("<m:stats>\n</body>","<m:stats>\n</BODY>"),$m);if(strpos($m,'<m:metas>')===false)$m=str_replace(array('</head>','</HEAD>'),array("<m:metas>\n</head>","<m:metas>\n</HEAD>"),$m);$statscode=in_array($rq,$service_pages)?'':xmler($db,'statscode');$m=str_replace('<m:stats>',$statscode,$m);$metacode=xmler($db,'mymeta');$m=str_replace('<m:metas>',$metacode,$m);$m=str_replace('<m:lang>',specifyLang(),$m);$m=str_replace('<m:','<?m:',$m);}while(strpos($m,'[parcelle:')>-1 || strpos($m,'[tile:')>-1 || strpos($m,'[func:')>-1 || strpos($m,'[edit:')>-1 || strpos($m,'[phpcode:')>-1 || strpos($m,'[menu:')>-1){$m=functionize($m);$m=parcellize($mAllStable,$m);$m=tilize($m);$m=editize($m);$m=phpcodeize($m);$m=menuize($m);}$m=str_replace('[!func:','[func:',$m);$m=str_replace('[!parcelle:','[parcelle:',$m);$m=str_replace('[!tile:','[tile:',$m);$m=str_replace('[!edit:','[edit:',$m);$m=str_replace('[!phpcode:','[phpcode:',$m);$m=str_replace('[!menu:','[menu:',$m);if(isset($_GET['term'])){$fndstr="/<([^><]*)(<)([^><]*)(>)/i";while(preg_match($fndstr,$m))$m=preg_replace($fndstr,"<$1",$m);}$m=translateThis($db,$m);if(function_exists('postProcessAll')){$m=postProcessAll($m);}echo str_replace(array('<p><p','</p></p>'),array('<p','</p>'),$m);exit;
